"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("webrtc-adapter")),n=require("sdp-transform"),r=require("ua-parser-js"),i=require("uuid"),a=require("events"),s=e(a);function o(e,t,n,r,i,a,s){try{var o=e[a](s),c=o.value}catch(e){return void n(e)}o.done?t(c):Promise.resolve(c).then(r,i)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var a=e.apply(t,n);function s(e){o(a,r,i,s,c,"next",e)}function c(e){o(a,r,i,s,c,"throw",e)}s(void 0)}))}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e}function l(){return(l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function h(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,f(e,t)}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function g(e,t,n){return(g=v()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&f(i,n.prototype),i}).apply(null,arguments)}function m(e){var t="function"==typeof Map?new Map:void 0;return(m=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return g(e,arguments,p(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),f(n,e)})(e)}function k(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function E(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return T(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?T(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var x,y,b,S=(function(e){var t=function(e){var t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",a=r.asyncIterator||"@@asyncIterator",s=r.toStringTag||"@@toStringTag";function o(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{o({},"")}catch(e){o=function(e,t,n){return e[t]=n}}function c(e,t,n,r){var i=Object.create((t&&t.prototype instanceof l?t:l).prototype),a=new b(r||[]);return i._invoke=function(e,t,n){var r="suspendedStart";return function(i,a){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===i)throw a;return{value:void 0,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var o=E(s,n);if(o){if(o===d)continue;return o}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var c=u(e,t,n);if("normal"===c.type){if(r=n.done?"completed":"suspendedYield",c.arg===d)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r="completed",n.method="throw",n.arg=c.arg)}}}(e,n,a),i}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d={};function l(){}function h(){}function p(){}var f={};o(f,i,(function(){return this}));var v=Object.getPrototypeOf,g=v&&v(v(S([])));g&&g!==t&&n.call(g,i)&&(f=g);var m=p.prototype=l.prototype=Object.create(f);function k(e){["next","throw","return"].forEach((function(t){o(e,t,(function(e){return this._invoke(t,e)}))}))}function T(e,t){var r;this._invoke=function(i,a){function s(){return new t((function(r,s){!function r(i,a,s,o){var c=u(e[i],e,a);if("throw"!==c.type){var d=c.arg,l=d.value;return l&&"object"==typeof l&&n.call(l,"__await")?t.resolve(l.__await).then((function(e){r("next",e,s,o)}),(function(e){r("throw",e,s,o)})):t.resolve(l).then((function(e){d.value=e,s(d)}),(function(e){return r("throw",e,s,o)}))}o(c.arg)}(i,a,r,s)}))}return r=r?r.then(s,s):s()}}function E(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,E(e,t),"throw"===t.method))return d;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return d}var r=u(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,d;var i=r.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,d):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function y(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function b(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function S(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,a=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:w}}function w(){return{value:void 0,done:!0}}return h.prototype=p,o(m,"constructor",p),o(p,"constructor",h),h.displayName=o(p,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,o(e,s,"GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},k(T.prototype),o(T.prototype,a,(function(){return this})),e.AsyncIterator=T,e.async=function(t,n,r,i,a){void 0===a&&(a=Promise);var s=new T(c(t,n,r,i),a);return e.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},k(m),o(m,s,"Generator"),o(m,i,(function(){return this})),o(m,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=S,b.prototype={constructor:b,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(y),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return s.type="throw",s.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var o=n.call(a,"catchLoc"),c=n.call(a,"finallyLoc");if(o&&c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(o){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,d):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),y(n),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;y(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:S(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),d}},e}(e.exports);try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}}(b={exports:{}}),b.exports);!function(e){e[e.Publish=0]="Publish",e[e.Subscribe=1]="Subscribe"}(x||(x={})),(y=exports.HMSLogLevel||(exports.HMSLogLevel={}))[y.VERBOSE=0]="VERBOSE",y[y.DEBUG=1]="DEBUG",y[y.INFO=2]="INFO",y[y.WARN=3]="WARN",y[y.TIME=4]="TIME",y[y.TIMEEND=5]="TIMEEND",y[y.ERROR=6]="ERROR",y[y.NONE=7]="NONE";var w=function(){function e(){}return e.v=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log.apply(this,[exports.HMSLogLevel.VERBOSE,e].concat(n))},e.d=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log.apply(this,[exports.HMSLogLevel.DEBUG,e].concat(n))},e.i=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log.apply(this,[exports.HMSLogLevel.INFO,e].concat(n))},e.w=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log.apply(this,[exports.HMSLogLevel.WARN,e].concat(n))},e.e=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];this.log.apply(this,[exports.HMSLogLevel.ERROR,e].concat(n))},e.time=function(e){this.log(exports.HMSLogLevel.TIME,"[HMSPerformanceTiming]",e)},e.timeEnd=function(e){this.log(exports.HMSLogLevel.TIMEEND,"[HMSPerformanceTiming]",e,e)},e.cleanUp=function(){performance.clearMarks(),performance.clearMeasures()},e.log=function(e,t){if(!(this.level.valueOf()>e.valueOf())){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];switch(e){case exports.HMSLogLevel.VERBOSE:var a;(a=console).log.apply(a,[t].concat(r));break;case exports.HMSLogLevel.DEBUG:var s;(s=console).debug.apply(s,[t].concat(r));break;case exports.HMSLogLevel.INFO:var o;(o=console).info.apply(o,[t].concat(r));break;case exports.HMSLogLevel.WARN:var c;(c=console).warn.apply(c,[t].concat(r));break;case exports.HMSLogLevel.ERROR:var u;(u=console).error.apply(u,[t].concat(r));break;case exports.HMSLogLevel.TIME:performance.mark(r[0]);break;case exports.HMSLogLevel.TIMEEND:var d=r[0];try{var l=performance.measure(d,d);this.log(exports.HMSLogLevel.DEBUG,t,d,null==l?void 0:l.duration),performance.clearMarks(d),performance.clearMeasures(d)}catch(e){this.log(exports.HMSLogLevel.DEBUG,t,d,e)}}}},e}();function I(e,t){var r,i=n.parse(e.sdp);if(null==(r=i.origin)||!r.username.startsWith("mozilla"))return e;var a=Array.from(t.values());return i.media.forEach((function(e){var t,n,r,i=null==(t=e.msid)?void 0:t.split(" ")[0],s=null==(n=a.find((function(t){return t.type===e.type&&t.stream_id===i})))?void 0:n.track_id;s&&(e.msid=null==(r=e.msid)?void 0:r.replace(/\s(.+)/," "+s))})),{type:e.type,sdp:n.write(i)}}w.level=exports.HMSLogLevel.VERBOSE;var A,P={WebSocketConnectionErrors:{GENERIC_CONNECT:1e3,WEBSOCKET_CONNECTION_LOST:1003},InitAPIErrors:{SERVER_ERRORS:2e3,CONNECTION_LOST:2001,HTTP_ERROR:2400,INVALID_ENDPOINT_URL:2002,ENDPOINT_UNREACHABLE:2003,INVALID_TOKEN_FORMAT:2004},TracksErrors:{GENERIC_TRACK:3e3,CANT_ACCESS_CAPTURE_DEVICE:3001,DEVICE_NOT_AVAILABLE:3002,DEVICE_IN_USE:3003,DEVICE_LOST_MIDWAY:3008,NOTHING_TO_RETURN:3005,INVALID_VIDEO_SETTINGS:3006,CODEC_CHANGE_NOT_PERMITTED:3007,AUTOPLAY_ERROR:3008},WebrtcErrors:{CREATE_OFFER_FAILED:4001,CREATE_ANSWER_FAILED:4002,SET_LOCAL_DESCRIPTION_FAILED:4003,SET_REMOTE_DESCRIPTION_FAILED:4004,ICE_FAILURE:4005},WebsocketMethodErrors:{SERVER_ERRORS:5e3,ALREADY_JOINED:5001,CANNOT_JOIN_PREVIEW_IN_PROGRESS:5002},GenericErrors:{NOT_CONNECTED:6e3,SIGNALLING:6001,UNKNOWN:6002,NOT_READY:6003,JSON_PARSING_FAILED:6004,TRACK_METADATA_MISSING:6005,RTC_TRACK_MISSING:6006,PEER_METADATA_MISSING:6007,INVALID_ROLE:6008},PlaylistErrors:{NO_ENTRY_TO_PLAY:8001,NO_ENTRY_IS_PLAYING:8002}},R=function(e){function t(n,r,i,a,s,o){var c;return void 0===o&&(o=!1),(c=e.call(this,a)||this).code=n,c.name=r,c.message=a,c.description=s,c.isTerminal=o,Object.setPrototypeOf(k(c),t.prototype),c.action=i.toString(),c}h(t,e);var n=t.prototype;return n.toAnalyticsProperties=function(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}},n.addNativeError=function(e){this.nativeError=e},t}(m(Error));!function(e){e.NONE="NONE",e.TRACK="TRACK",e.INIT="INIT",e.PUBLISH="PUBLISH",e.UNPUBLISH="UNPUBLISH",e.JOIN="JOIN",e.SUBSCRIBE="SUBSCRIBE",e.DATA_CHANNEL_SEND="DATA_CHANNEL_SEND",e.RESTART_ICE="RESTART_ICE",e.VIDEO_PLUGINS="VIDEO_PLUGINS",e.AUDIO_PLUGINS="AUDIO_PLUGINS",e.AUTOPLAY="AUTOPLAY",e.RECONNECT_SIGNAL="RECONNECT_SIGNAL",e.VALIDATION="VALIDATION",e.PLAYLIST="PLAYLIST"}(A||(A={}));var C,M,D,_,L,O=function(e,t){return void 0===t&&(t=""),new R(1e3,"GenericConnect",e,"Something went wrong",t)},N=function(e,t,n){return void 0===n&&(n=""),new R(e,"ServerErrors",t,"[INIT]: Server error",n)},U=function(e,t){return void 0===t&&(t=""),new R(2001,"ConnectionLost",e,"[INIT]: Network error",t)},G=function(e,t){return void 0===t&&(t=""),new R(2004,"InvalidTokenFormat",e,"Token is not in proper JWT format",t)},H=function(e,t){return void 0===t&&(t=""),new R(3e3,"GenericTrack",e,"[TRACK]: Something went wrong",t)},F=function(e,t,n){return void 0===n&&(n=""),new R(3001,"CantAccessCaptureDevice",e,"[TRACK]: No permission to access capture device - "+t,n)},B=function(e,t,n){return void 0===n&&(n=""),new R(3002,"DeviceNotAvailable",e,"[TRACK]: Capture device is no longer available - "+t,n)},V=function(e,t){return void 0===t&&(t=""),new R(3005,"NothingToReturn",e,"There is no media to return. Please select either video or audio or both.",t)},K=function(e,t){return void 0===t&&(t=""),new R(4003,"SetLocalDescriptionFailed",e,"["+e.toString()+"]: Failed to set offer. ",t)},j=function(e,t){return void 0===t&&(t=""),new R(4004,"SetRemoteDescriptionFailed",e,"["+e.toString()+"]: Failed to set answer. ",t)},q=function(e,t){return void 0===t&&(t=""),new R(4005,"ICEFailure",e,"["+e.toString()+"]: Ice connection state FAILED",t)},W=function(e,t,n){return new R(e,"ServerErrors",t,n,n)},J=function(e,t){return void 0===t&&(t=""),new R(6e3,"NotConnected",e,"Client is not connected",t)},Y=function(e,t){return new R(6002,"Unknown",e,"Unknown exception: "+t,t)},Q=function(e,t){return new R(6008,"ValidationFailed",A.VALIDATION,e,t?JSON.stringify(t):"")},z=function(e,t){return void 0===t&&(t=""),new R(7001,"PlatformNotSupported",e,"Check HMS Docs to see the list of supported platforms",t)},Z=function(e,t){return void 0===t&&(t=""),new R(7002,"InitFailed",e,"Plugin init failed",t)},X=function(e,t){return void 0===t&&(t=""),new R(7004,"AddAlreadyInProgress",e,"Plugin add already in progress",t)},$=function(e,t){return new R(P.PlaylistErrors.NO_ENTRY_TO_PLAY,"NoEntryToPlay",e,"Reached end of playlist",t)},ee="HMSConnection",te=function(){function e(e,t){this.candidates=new Array,this.role=e,this.signal=t}var t=e.prototype;return t.addTransceiver=function(e,t){return this.nativeConnection.addTransceiver(e,t)},t.createOffer=function(){var e=c(S.mark((function e(t,n){var r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t=void 0),e.prev=1,e.next=4,this.nativeConnection.createOffer(t);case 4:return r=e.sent,w.d(ee,"[role="+this.role+"] createOffer offer="+JSON.stringify(r,null,1)),e.abrupt("return",(s=I(r,n)).sdp.includes("usedtx=1")?s:{type:s.type,sdp:s.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")});case 9:throw e.prev=9,e.t0=e.catch(1),void 0===(a=e.t0.message)&&(a=""),new R(4001,"CreateOfferFailed",i=this.action,"["+i.toString()+"]: Failed to create offer. ",a);case 12:case"end":return e.stop()}var i,a,s}),e,this,[[1,9]])})));return function(t,n){return e.apply(this,arguments)}}(),t.createAnswer=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t=void 0),e.prev=1,e.next=4,this.nativeConnection.createAnswer(t);case 4:return n=e.sent,w.d(ee,"[role="+this.role+"] createAnswer answer="+JSON.stringify(n,null,1)),e.abrupt("return",n);case 9:throw e.prev=9,e.t0=e.catch(1),void 0===(i=e.t0.message)&&(i=""),new R(4002,"CreateAnswerFailed",r=this.action,"["+r.toString()+"]: Failed to create answer. ",i);case 12:case"end":return e.stop()}var r,i}),e,this,[[1,9]])})));return function(t){return e.apply(this,arguments)}}(),t.setLocalDescription=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,w.d(ee,"[role="+this.role+"] setLocalDescription description="+JSON.stringify(t,null,1)),e.next=4,this.nativeConnection.setLocalDescription(t);case 4:e.next=9;break;case 6:throw e.prev=6,e.t0=e.catch(0),K(this.action,e.t0.message);case 9:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t){return e.apply(this,arguments)}}(),t.setRemoteDescription=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,w.d(ee,"[role="+this.role+"] setRemoteDescription description="+JSON.stringify(t,null,1)),e.next=4,this.nativeConnection.setRemoteDescription(t);case 4:e.next=9;break;case 6:throw e.prev=6,e.t0=e.catch(0),j(this.action,e.t0.message);case 9:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t){return e.apply(this,arguments)}}(),t.addIceCandidate=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w.d(ee,"[role="+this.role+"] addIceCandidate candidate="+JSON.stringify(t,null,1)),e.next=3,this.nativeConnection.addIceCandidate(t);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.getSenders=function(){return this.nativeConnection.getSenders()},t.removeTrack=function(e){this.nativeConnection.removeTrack(e)},t.setMaxBitrate=function(){var e=c(S.mark((function e(t,n){var r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=this.getSenders().find((function(e){var t;return(null==e||null==(t=e.track)?void 0:t.id)===n.getTrackIDBeingSent()})))){e.next=8;break}return(i=r.getParameters()).encodings.length>0&&(i.encodings[0].maxBitrate=1e3*t),e.next=6,r.setParameters(i);case 6:e.next=9;break;case 8:w.w(ee,"no sender found to setMaxBitrate for track - "+n.trackId+", sentTrackId - "+n.getTrackIDBeingSent());case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.getStats=function(){var e=c(S.mark((function e(){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.nativeConnection.getStats();case 2:return t=[],e.sent.forEach((function(e){return t.push(e)})),e.abrupt("return",t);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.close=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.nativeConnection.close();case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),d(e,[{key:"iceConnectionState",get:function(){return this.nativeConnection.iceConnectionState}},{key:"connectionState",get:function(){return this.nativeConnection.connectionState}},{key:"action",get:function(){return this.role===x.Publish?A.PUBLISH:A.SUBSCRIBE}},{key:"remoteDescription",get:function(){return this.nativeConnection.remoteDescription}}]),e}(),ne=function(e){function t(t,n,r,i){var a;return(a=e.call(this,x.Publish,t)||this).observer=r,a.transport=i,a.nativeConnection=new RTCPeerConnection(n),a.nativeConnection.createDataChannel("ion-sfu",{protocol:"SCTP"}),a.nativeConnection.onicecandidate=function(e){var n=e.candidate;n&&t.trickle(a.role,n)},a.nativeConnection.oniceconnectionstatechange=function(){a.observer.onIceConnectionChange(a.nativeConnection.iceConnectionState)},a.nativeConnection.onconnectionstatechange=function(){a.observer.onConnectionStateChange(a.nativeConnection.connectionState)},a}h(t,e);var n=t.prototype;return n.initAfterJoin=function(){var e=this;this.nativeConnection.onnegotiationneeded=c(S.mark((function t(){return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return w.d("HMSPublishConnection","onnegotiationneeded"),t.next=3,e.observer.onRenegotiationNeeded();case 3:case"end":return t.stop()}}),t)})))},n.trackUpdate=function(e){this.transport.trackUpdate(e)},t}(te),re=function(e){this.tracks=new Array,this.nativeStream=e,this.id=e.id};(C=exports.HMSRoomUpdate||(exports.HMSRoomUpdate={}))[C.PEER_ADDED=0]="PEER_ADDED",C[C.PEER_REMOVED=1]="PEER_REMOVED",C[C.PEER_KNOCKED=2]="PEER_KNOCKED",C[C.ROOM_TYPE_CHANGED=3]="ROOM_TYPE_CHANGED",C[C.METADATA_UPDATED=4]="METADATA_UPDATED",C[C.SCREENSHARE_STARTED=5]="SCREENSHARE_STARTED",C[C.SCREENSHARE_STOPPED=6]="SCREENSHARE_STOPPED",C[C.DEFAULT_UPDATE=7]="DEFAULT_UPDATE",C[C.RECORDING_STATE_UPDATED=8]="RECORDING_STATE_UPDATED",C[C.BROWSER_RECORDING_STATE_UPDATED=9]="BROWSER_RECORDING_STATE_UPDATED",C[C.SERVER_RECORDING_STATE_UPDATED=10]="SERVER_RECORDING_STATE_UPDATED",C[C.RTMP_STREAMING_STATE_UPDATED=11]="RTMP_STREAMING_STATE_UPDATED",(M=exports.HMSPeerUpdate||(exports.HMSPeerUpdate={}))[M.PEER_JOINED=0]="PEER_JOINED",M[M.PEER_LEFT=1]="PEER_LEFT",M[M.AUDIO_TOGGLED=2]="AUDIO_TOGGLED",M[M.VIDEO_TOGGLED=3]="VIDEO_TOGGLED",M[M.BECAME_DOMINANT_SPEAKER=4]="BECAME_DOMINANT_SPEAKER",M[M.RESIGNED_DOMINANT_SPEAKER=5]="RESIGNED_DOMINANT_SPEAKER",M[M.STARTED_SPEAKING=6]="STARTED_SPEAKING",M[M.STOPPED_SPEAKING=7]="STOPPED_SPEAKING",M[M.ROLE_UPDATED=8]="ROLE_UPDATED",M[M.PEER_LIST=9]="PEER_LIST",(D=exports.HMSTrackUpdate||(exports.HMSTrackUpdate={}))[D.TRACK_ADDED=0]="TRACK_ADDED",D[D.TRACK_REMOVED=1]="TRACK_REMOVED",D[D.TRACK_MUTED=2]="TRACK_MUTED",D[D.TRACK_UNMUTED=3]="TRACK_UNMUTED",D[D.TRACK_DESCRIPTION_CHANGED=4]="TRACK_DESCRIPTION_CHANGED",D[D.TRACK_DEGRADED=5]="TRACK_DEGRADED",D[D.TRACK_RESTORED=6]="TRACK_RESTORED",(_=exports.HMSRoomType||(exports.HMSRoomType={}))[_.DEFAULT=0]="DEFAULT",(L=exports.HMSSimulcastLayer||(exports.HMSSimulcastLayer={})).NONE="none",L.LOW="low",L.MEDIUM="medium",L.HIGH="high";var ie,ae,se={f:exports.HMSSimulcastLayer.HIGH,h:exports.HMSSimulcastLayer.MEDIUM,q:exports.HMSSimulcastLayer.LOW};(ie=exports.HMSVideoCodec||(exports.HMSVideoCodec={})).VP8="vp8",ie.VP9="vp9",ie.H264="h264",(exports.HMSAudioCodec||(exports.HMSAudioCodec={})).OPUS="opus",(ae=exports.HMSPlaylistType||(exports.HMSPlaylistType={})).audio="audio",ae.video="video";var oe,ce=function(e){function t(t,n){var r;return(r=e.call(this,t)||this).audio=!0,r.video=exports.HMSSimulcastLayer.NONE,r.frameRate=exports.HMSSimulcastLayer.HIGH,r.connection=n,r}h(t,e);var n=t.prototype;return n.setAudio=function(e){this.audio!==e&&(this.audio=e,this.syncWithApiChannel())},n.setVideo=function(e){this.video!==e?(this.video=e,w.d("[Remote stream] "+this.id,"Switching to "+e+" layer"),this.syncWithApiChannel()):w.d("[Remote stream] "+this.id,"Already on "+e+" layer")},n.getSimulcastLayer=function(){return this.video},n.isAudioSubscribed=function(){return this.audio},n.syncWithApiChannel=function(){this.connection.sendOverApiDataChannel(JSON.stringify({streamId:this.id,video:this.video,audio:this.audio,framerate:this.frameRate}))},t}(re),ue=function(){function e(e,t,n){var r=this;void 0===n&&(n=""),this.TAG="HMSDataChannel",this.nativeChannel=e,this.observer=t,this.metadata=n,e.onmessage=function(e){r.observer.onMessage(e.data)}}var t=e.prototype;return t.send=function(e){w.d(this.TAG,"["+this.metadata+"] Sending [size="+e.length+"] message="+e),this.nativeChannel.send(e)},t.close=function(){this.nativeChannel.close()},d(e,[{key:"id",get:function(){return this.nativeChannel.id}},{key:"label",get:function(){return this.nativeChannel.label}},{key:"readyState",get:function(){return this.nativeChannel.readyState}}]),e}(),de=function(){function e(e,t,n){this.stream=e,this.nativeTrack=t,this.source=n}var t=e.prototype;return t.getMediaTrackSettings=function(){return this.nativeTrack.getSettings()},t.setEnabled=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.nativeTrack.enabled=t;case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.setSdpTrackId=function(e){this.sdpTrackId=e},t.setFirstTrackId=function(e){this.firstTrackId=e},t.cleanup=function(){var e;null==(e=this.nativeTrack)||e.stop()},d(e,[{key:"enabled",get:function(){return this.nativeTrack.enabled}},{key:"trackId",get:function(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}}]),e}();(oe=exports.HMSTrackType||(exports.HMSTrackType={})).AUDIO="audio",oe.VIDEO="video";var le=function(e){function t(t,n,r){var i;if((i=e.call(this,t,n,r)||this).type=exports.HMSTrackType.AUDIO,i.audioElement=null,"audio"!==n.kind)throw new Error("Expected 'track' kind = 'audio'");return i}h(t,e);var n=t.prototype;return n.getVolume=function(){return this.audioElement?100*this.audioElement.volume:null},n.setVolume=function(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.subscribeToAudio(0!==e&&this.enabled),this.audioElement&&(this.audioElement.volume=e/100)},n.setAudioElement=function(e){this.audioElement=e},n.getAudioElement=function(){return this.audioElement},n.getOutputDevice=function(){return this.outputDevice},n.cleanup=function(){e.prototype.cleanup.call(this),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)},n.setOutputDevice=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.audioElement){e.next=3;break}return w.d("audio-track","no audio element to set output"),e.abrupt("return");case 3:if(e.prev=3,"function"!=typeof this.audioElement.setSinkId){e.next=8;break}return e.next=7,null==(n=this.audioElement)?void 0:n.setSinkId(t.deviceId);case 7:this.outputDevice=t;case 8:e.next=12;break;case 10:e.prev=10,e.t0=e.catch(3);case 12:case"end":return e.stop()}}),e,this,[[3,10]])})));return function(t){return e.apply(this,arguments)}}(),n.removeSink=function(){var e;this.audioElement&&null!=(e=window.HMS)&&e.AUDIO_SINK&&(this.audioElement.srcObject=null,this.subscribeToAudio(!1))},n.addSink=function(){var e;if(this.nativeTrack&&this.audioElement&&null!=(e=window.HMS)&&e.AUDIO_SINK){var t,n=this.audioElement.srcObject;if(null!==n&&n instanceof MediaStream&&(null==(t=n.getAudioTracks()[0])?void 0:t.id)===this.nativeTrack.id)return;this.audioElement.srcObject=new MediaStream([this.nativeTrack]),this.subscribeToAudio(!0)}},n.subscribeToAudio=function(e){this.stream instanceof ce&&this.stream.setAudio(e)},t}(de),he=function(e){function t(){return e.apply(this,arguments)||this}return h(t,e),t.prototype.setEnabled=function(){var t=c(S.mark((function t(n){return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==this.enabled){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,e.prototype.setEnabled.call(this,n);case 4:this.subscribeToAudio(n);case 5:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),t}(le),pe=function(e){function t(t,n,r){var i;if((i=e.call(this,t,n,r)||this).type=exports.HMSTrackType.VIDEO,i.sinkCount=0,"video"!==n.kind)throw new Error("Expected 'track' kind = 'video'");return i}h(t,e);var n=t.prototype;return n.hasSinks=function(){return this.sinkCount>0},n.addSink=function(e){this.addSinkInternal(e,this.nativeTrack)},n.removeSink=function(e){e.srcObject=null,this.sinkCount>0&&this.sinkCount--},n.addSinkInternal=function(e,t){var n,r=e.srcObject;null!==r&&r instanceof MediaStream&&(null==(n=r.getVideoTracks()[0])?void 0:n.id)===t.id||(e.srcObject=new MediaStream([t]),this.sinkCount++)},t}(de),fe=function(e){function t(){var t;return(t=e.apply(this,arguments)||this)._degraded=!1,t._layerDefinitions=[],t}h(t,e);var n=t.prototype;return n.setEnabled=function(){var t=c(S.mark((function t(n){return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==this.enabled){t.next=2;break}return t.abrupt("return");case 2:return this._degraded&&!n&&(this._degraded=!1),t.next=5,e.prototype.setEnabled.call(this,n);case 5:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),n.preferLayer=function(e){this.stream.setVideo(e)},n.getSimulcastLayer=function(){return this.stream.getSimulcastLayer()},n.addSink=function(t){e.prototype.addSink.call(this,t),this.updateLayer()},n.removeSink=function(t){e.prototype.removeSink.call(this,t),this.updateLayer()},n.getSimulcastDefinitions=function(){return[].concat(this._layerDefinitions)},n.setSimulcastDefinitons=function(e){this._layerDefinitions=e},n.setDegraded=function(e){this._degraded=e,this.updateLayer()},n.updateLayer=function(){var e=this.hasSinks()?exports.HMSSimulcastLayer.HIGH:exports.HMSSimulcastLayer.NONE;this.degraded&&(e=exports.HMSSimulcastLayer.NONE),this.stream.setVideo(e)},d(t,[{key:"degraded",get:function(){return this._degraded}}]),t}(pe),ve=function(e){function t(t,n,r){var i;return(i=e.call(this,x.Subscribe,t)||this).TAG="[HMSSubscribeConnection]",i.remoteStreams=new Map,i.pendingMessageQueue=[],i.handlePendingApiMessages=function(){i.pendingMessageQueue.length>0&&(w.d(i.TAG,"Found pending message queue, sending messages"),i.pendingMessageQueue.forEach((function(e){return i.sendOverApiDataChannel(e)})),i.pendingMessageQueue.length=0)},i.observer=r,i.nativeConnection=new RTCPeerConnection(n),i.initNativeConnectionCallbacks(),i}h(t,e);var r=t.prototype;return r.initNativeConnectionCallbacks=function(){var e=this;this.nativeConnection.oniceconnectionstatechange=function(){e.observer.onIceConnectionChange(e.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=function(){e.observer.onConnectionStateChange(e.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=function(t){"ion-sfu"===t.channel.label&&(e.apiChannel=new ue(t.channel,{onMessage:function(t){e.observer.onApiChannelMessage(t)}},"role="+e.role),t.channel.onopen=e.handlePendingApiMessages)},this.nativeConnection.onicecandidate=function(t){null!==t.candidate&&e.signal.trickle(e.role,t.candidate)},this.nativeConnection.ontrack=function(t){var r,i=t.streams[0],a=i.id;if(!e.remoteStreams.has(a)){var s=new ce(i,e);e.remoteStreams.set(a,s),i.onremovetrack=function(t){var n=s.tracks.findIndex((function(e){return e.nativeTrack.id===t.track.id}));n>=0&&(e.observer.onTrackRemove(s.tracks[n]),s.tracks.splice(n,1),0===s.tracks.length&&e.remoteStreams.delete(a))}}var o=e.remoteStreams.get(a),c=new("audio"===t.track.kind?he:fe)(o,t.track),u=function(e,t){var r;if(null!=e&&e.sdp&&t){var i=n.parse(e.sdp).media.find((function(e){return null!=e.mid&&parseInt(e.mid)===parseInt(t)}));return null==i||null==(r=i.msid)?void 0:r.split(" ")[1]}}(e.remoteDescription,null==(r=t.transceiver)?void 0:r.mid);u&&c.setSdpTrackId(u),o.tracks.push(c),e.observer.onTrackAdd(c)}},r.sendOverApiDataChannel=function(e){this.apiChannel&&"open"===this.apiChannel.readyState?this.apiChannel.send(e):(w.w(this.TAG,"API Data channel not "+(this.apiChannel?"open":"present")+", queueing",e),this.pendingMessageQueue.push(e))},r.close=function(){var t=c(S.mark((function t(){var n;return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.prototype.close.call(this);case 2:null==(n=this.apiChannel)||n.close();case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),t}(te),ge=new r.UAParser,me="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,ke="undefined"!=typeof window,Te=function(){return!me}();function Ee(){if(me)return"hmsclient/0.1.18";var e=ge.getDevice(),t=ge.getBrowser(),n=ge.getOS();return e.type?"hmsclient/0.1.18 "+n.name+"/"+n.version+" ("+e.vendor+"_"+e.type+"_/_"+t.name+"_"+t.version+")":"hmsclient/0.1.18 "+n.name+"/"+n.version+" ("+t.name+"_"+t.version+")"}var xe,ye=function(){return"mobile"===ge.getDevice().type},be=Ee(),Se="InitService",we=function(){function e(){}return e.fetchInitConfig=function(){var e=c(S.mark((function e(t,n,r){var i,a,s,o,c,u,d;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n="https://prod-init.100ms.live"),void 0===r&&(r=""),w.d(Se,"fetchInitConfig: initEndpoint="+n+" token="+t+" region="+r),i=Ie(n,r),e.prev=4,e.next=7,fetch(i,{headers:{Authorization:"Bearer "+t}});case 7:return a=e.sent,e.next=10,a.json();case 10:if(c=e.sent,404!==a.status){e.next=13;break}throw void 0===(l=c.message||a.statusText)&&(l=""),new R(2003,"EndpointUnreachable",A.INIT,"Endpoint is not reachable.",l);case 13:if(200===(null==(o=a)?void 0:o.status)){e.next=15;break}throw N(c.code||a.status,A.INIT,c.message||(null==(u=a)?void 0:u.statusText));case 15:s=c,w.d(Se,"config is "+JSON.stringify(s,null,2)),e.next=25;break;case 19:if(e.prev=19,e.t0=e.catch(4),"Failed to fetch"!==(d=e.t0).message){e.next=24;break}throw U(A.INIT,d.message);case 24:throw d;case 25:return e.abrupt("return",Ae(s));case 26:case"end":return e.stop()}var l}),e,null,[[4,19]])})));return function(t,n,r){return e.apply(this,arguments)}}(),e}();function Ie(e,t){try{var n=new URL("/init",e);return t&&t.trim().length>0&&n.searchParams.set("region",t.trim()),n.searchParams.set("user_agent",be),n.toString()}catch(e){var r=e;throw w.e(Se,r.name,r.message),r}}function Ae(e){return l({},e,{rtcConfiguration:l({},e.rtcConfiguration,{iceServers:e.rtcConfiguration.ice_servers})})}function Pe(e){switch(e){case xe.JOIN:return A.JOIN;case xe.OFFER:return A.PUBLISH;case xe.ANSWER:return A.SUBSCRIBE;case xe.TRACK_UPDATE:return A.TRACK;default:return A.NONE}}!function(e){e.JOIN="join",e.OFFER="offer",e.ANSWER="answer",e.TRICKLE="trickle",e.TRACK_UPDATE="track-update",e.BROADCAST="broadcast",e.ANALYTICS="analytics",e.SERVER_ERROR="on-error",e.SDK_NOTIFICATION="sdk-notification",e.LEAVE="leave",e.END_ROOM="end-room",e.PING="ping",e.ROLE_CHANGE_REQUEST="role-change-request",e.ROLE_CHANGE="role-change",e.TRACK_UPDATE_REQUEST="track-update-request",e.PEER_LEAVE_REQUEST="peer-leave-request",e.CHANGE_TRACK_MUTE_STATE_REQUEST="change-track-mute-state-request",e.START_RTMP_OR_RECORDING_REQUEST="rtmp-start",e.STOP_RTMP_AND_RECORDING_REQUEST="rtmp-stop"}(xe||(xe={}));var Re,Ce,Me=function(){function e(e){var t=this;this.TAG="[ SIGNAL ]: ",this.isJoinCompleted=!1,this.pendingTrickle=[],this.socket=null,this.callbacks=new Map,this._isConnected=!1,this.id=0,this.observer=e,window.addEventListener("offline",(function(){w.d(t.TAG,"Window network offline"),t.isConnected=!1})),window.addEventListener("online",(function(){w.d(t.TAG,"Window network online")})),this.onCloseHandler=this.onCloseHandler.bind(this),this.onMessageHandler=this.onMessageHandler.bind(this)}var t=e.prototype;return t.call=function(){var e=c(S.mark((function e(t,n){var r,a,s=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.v4(),this.socket.send(JSON.stringify({method:t,params:n,id:r,jsonrpc:"2.0"})),e.prev=3,e.next=6,new Promise((function(e,t){s.callbacks.set(r,{resolve:e,reject:t})}));case 6:return e.abrupt("return",e.sent);case 10:throw e.prev=10,e.t0=e.catch(3),a=e.t0,W(Number(a.code),Pe(t),a.message);case 14:case"end":return e.stop()}}),e,this,[[3,10]])})));return function(t,n){return e.apply(this,arguments)}}(),t.notify=function(e,t){this.socket.send(JSON.stringify({method:e,params:t}))},t.open=function(e){var t=this;return new Promise((function(n,r){t.socket&&(t.socket.removeEventListener("close",t.onCloseHandler),t.socket.removeEventListener("message",t.onMessageHandler)),t.socket=new WebSocket(e);var i=function(e){w.d(t.TAG,"Error opening socket connection",e),r(O(A.JOIN,"Error opening socket connection"))};t.socket.addEventListener("error",i),t.socket.addEventListener("open",(function e(){n(),t.isConnected=!0,t.id++,t.socket.removeEventListener("open",e),t.socket.removeEventListener("error",i),t.pingPongLoop(t.id)})),t.socket.addEventListener("close",t.onCloseHandler),t.socket.addEventListener("message",t.onMessageHandler)}))},t.close=function(){var e=c(S.mark((function e(){var t,n=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Promise((function(e){n.socket.addEventListener("close",(function(){return e()}))})),this.socket.close(1e3,"Normal Close"),this.isConnected=!1,this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler),e.abrupt("return",t);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.join=function(){var e=c(S.mark((function e(t,n,r,i){var a,s,o=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a={name:t,disableVidAutoSub:i,data:n,offer:r},e.next=3,this.call(xe.JOIN,a);case 3:return s=e.sent,this.isJoinCompleted=!0,this.pendingTrickle.forEach((function(e){return o.trickle(e.target,e.candidate)})),this.pendingTrickle.length=0,w.d(this.TAG,"join: response="+JSON.stringify(s,null,1)),e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i){return e.apply(this,arguments)}}(),t.trickle=function(e,t){this.isJoinCompleted?this.notify(xe.TRICKLE,{target:e,candidate:t}):this.pendingTrickle.push({target:e,candidate:t})},t.offer=function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.OFFER,{desc:t,tracks:Object.fromEntries(n)});case 2:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.answer=function(e){this.notify(xe.ANSWER,{desc:e})},t.trackUpdate=function(e){this.notify(xe.TRACK_UPDATE,{version:"1.0",tracks:Object.fromEntries(e)})},t.broadcast=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.BROADCAST,l({version:"1.0"},t.toSignalParams()));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.recordStart=function(){},t.recordEnd=function(){},t.leave=function(){this.notify(xe.LEAVE,{version:"1.0"})},t.endRoom=function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.END_ROOM,{lock:t,reason:n});case 2:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.sendEvent=function(e){if(!this.isConnected)throw Error(this.TAG+" not connected. Could not send event "+e);this.notify(xe.ANALYTICS,e.toSignalParams())},t.ping=function(e){var t=Date.now(),n=new Promise((function(n){setTimeout((function(){n(Date.now()-t)}),e+1)})),r=this.call(xe.PING,{timestamp:t}).then((function(){return Date.now()-t})).catch((function(){return Date.now()-t}));return Promise.race([n,r])},t.requestRoleChange=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.ROLE_CHANGE_REQUEST,t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.acceptRoleChangeRequest=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.ROLE_CHANGE,t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.requestTrackStateChange=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.TRACK_UPDATE_REQUEST,t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.requestMultiTrackStateChange=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.CHANGE_TRACK_MUTE_STATE_REQUEST,t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.removePeer=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.PEER_LEAVE_REQUEST,t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.startRTMPOrRecording=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.START_RTMP_OR_RECORDING_REQUEST,l({version:"1.0"},t));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.stopRTMPAndRecording=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.call(xe.STOP_RTMP_AND_RECORDING_REQUEST,{version:"1.0"});case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.onCloseHandler=function(e){w.d("Websocket closed code="+e.code),this.isConnected=!1},t.onMessageHandler=function(e){var t=JSON.parse(e.data);if(t.hasOwnProperty("id")){var n=t,r=n.id;if(this.callbacks.has(r)){var i=this.callbacks.get(r);this.callbacks.delete(r),n.result?i.resolve(n.result):i.reject(n.error)}else this.observer.onNotification(n)}else{if(!t.hasOwnProperty("method"))throw Error("WebSocket message has no 'method' or 'id' field, message="+t);t.method===xe.OFFER?this.observer.onOffer(t.params):t.method===xe.TRICKLE?this.observer.onTrickle(t.params):t.method===xe.SERVER_ERROR?this.observer.onServerError(W(Number(t.params.code),A.NONE,t.params.message)):this.observer.onNotification(t)}},t.pingPongLoop=function(){var e=c(S.mark((function e(t){var n,r=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=1e4,!this.isConnected){e.next=6;break}return e.next=4,this.ping(n);case 4:e.sent>n?(w.d(this.TAG,"Pong timeout",{id:t}),this.id===t&&(this.isConnected=!1)):setTimeout((function(){return r.pingPongLoop(t)}),1e3);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d(e,[{key:"isConnected",get:function(){return this._isConnected},set:function(e){w.d(this.TAG,"isConnected set",{id:this.id,old:this._isConnected,new:e}),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.observer.onOffline()):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}}]),e}(),De=function(){function e(){this._volume=1,this._codec=exports.HMSAudioCodec.OPUS,this._maxBitrate=32,this._deviceId="default",this._advanced=[{googEchoCancellation:{exact:!0}},{googExperimentalEchoCancellation:{exact:!0}},{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{googHighpassFilter:{exact:!0}},{googAudioMirroring:{exact:!0}}]}var t=e.prototype;return t.volume=function(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this},t.codec=function(e){return this._codec=e,this},t.maxBitrate=function(e){if(e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,this},t.deviceId=function(e){return this._deviceId=e,this},t.advanced=function(e){return this._advanced=e,this},t.build=function(){return new _e(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced)},e}(),_e=function(){function e(e,t,n,r,i){this.volume=e,this.codec=t,this.maxBitrate=n,this.deviceId=r,this.advanced=i}var t=e.prototype;return t.toConstraints=function(){return{deviceId:this.deviceId,advanced:this.advanced}},t.toAnalyticsProperties=function(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}},e}(),Le=function(){function e(){this._width=320,this._height=180,this._codec=exports.HMSVideoCodec.VP8,this._maxFramerate=30,this._maxBitrate=150,this._advanced=[]}var t=e.prototype;return t.setWidth=function(e){return this._width=e,this},t.setHeight=function(e){return this._height=e,this},t.codec=function(e){return this._codec=e,this},t.maxFramerate=function(e){if(e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this},t.maxBitrate=function(e,t){if(void 0===t&&(t=!0),"number"==typeof e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this},t.deviceId=function(e){return this._deviceId=e,this},t.advanced=function(e){return this._advanced=e,this},t.build=function(){return new Oe(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate)},e}(),Oe=function(){function e(e,t,n,r,i,a,s){this.width=e,this.height=t,this.codec=n,this.maxFramerate=r,this.maxBitrate=s,this.deviceId=i,this.advanced=a}var t=e.prototype;return t.toConstraints=function(){return{width:this.width,height:this.height,frameRate:this.maxFramerate,deviceId:this.deviceId}},t.toAnalyticsProperties=function(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec}},e}(),Ne=function(){function e(){this._video=(new Le).build(),this._audio=(new De).build(),this._screen=(new Le).build(),this._simulcast=!1}var t=e.prototype;return t.video=function(e){return this._video=e,this},t.audio=function(e){return this._audio=e,this},t.screen=function(e){return this._screen=e,this},t.simulcast=function(e){return this._simulcast=e,this},t.build=function(){if(null===this._audio&&null===this._video)throw V(A.TRACK);if(null===this._video&&this._simulcast)throw void 0===(e="Cannot enable simulcast when no video settings are provided")&&(e=""),new R(3006,"InvalidVideoSettings",A.TRACK,"Cannot enable simulcast when no video settings are provided",e);var e;return new Ue(this._video,this._audio,this._simulcast,this._screen||void 0)},e}(),Ue=function(){function e(e,t,n,r){void 0===r&&(r=null),this.video=e,this.audio=t,this.simulcast=n,this.screen=r}return e.prototype.toAnalyticsProperties=function(){var e={audio_enabled:null!==this.audio,video_enabled:null!==this.video};return this.audio&&(e=l({},this.audio.toAnalyticsProperties(),e)),this.video&&(e=l({},this.video.toAnalyticsProperties(),e)),e},e}();function Ge(e,n){var r=function(e,n){var r=e.message.toLowerCase();if("screen"===n&&"chrome"===t.browserDetails.browser&&"NotAllowedError"===e.name&&e.message.includes("denied by system"))return B(A.TRACK,n,e.message);switch(e.name){case"OverconstrainedError":return H(A.TRACK,e.message);case"NotAllowedError":return F(A.TRACK,n,e.message);case"NotFoundError":return B(A.TRACK,n,e.message);case"NotReadableError":return function(e,t,n){return void 0===n&&(n=""),new R(3003,"DeviceInUse",A.TRACK,"[TRACK]: Capture device is in use by another application - "+t,n)}(0,n,e.message);case"TypeError":return V(A.TRACK,e.message);default:return r.includes("device not found")?B(A.TRACK,n,e.message):r.includes("permission denied")?F(A.TRACK,n,e.message):H(A.TRACK,e.message)}}(e,n);return r.addNativeError(e),r}function He(e){return Fe.apply(this,arguments)}function Fe(){return(Fe=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getUserMedia({audio:!!t&&t.toConstraints()});case 3:return e.abrupt("return",e.sent.getAudioTracks()[0]);case 7:throw e.prev=7,e.t0=e.catch(0),Ge(e.t0,Re.AUDIO);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}function Be(e){return Ve.apply(this,arguments)}function Ve(){return(Ve=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getUserMedia({video:!!t&&t.toConstraints()});case 3:return e.abrupt("return",e.sent.getVideoTracks()[0]);case 7:throw e.prev=7,e.t0=e.catch(0),Ge(e.t0,Re.VIDEO);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}function Ke(e){return"canvas"in e||"MediaStreamAudioDestinationNode"===e.label||""===e.label}function je(e){var t,n,r,i=(null==e||null==(t=e.getSettings())?void 0:t.width)||320,a=(null==e||null==(n=e.getSettings())?void 0:n.height)||240;Ce||null==(r=(Ce=Object.assign(document.createElement("canvas"),{width:i,height:a})).getContext("2d"))||r.fillRect(0,0,i,a);var s=Ce.captureStream(10).getVideoTracks()[0],o=setInterval((function(){if("ended"!==s.readyState){var e=Ce.getContext("2d");if(e){var t=e.getImageData(0,0,1,1).data;e.fillStyle="rgb("+(0===t[0]?1:0)+", 0, 0)",e.fillRect(0,0,1,1)}}else clearInterval(o)}),100);return s.onended=function(){clearInterval(o)},s.enabled=!1,s}function qe(){var e=new AudioContext,t=e.createOscillator(),n=t.connect(e.createMediaStreamDestination());t.start();var r=n.stream.getAudioTracks()[0];return r.enabled=!1,r}!function(e){e.AUDIO="audio",e.VIDEO="video",e.AV="audio, video",e.SCREEN="screen"}(Re||(Re={}));var We,Je,Ye=function(e){function t(){return e.apply(this,arguments)||this}h(t,e);var n=t.prototype;return n.on=function(t,n){return e.prototype.on.call(this,t,n)},n.off=function(t,n){return e.prototype.off.call(this,t,n)},n.emit=function(t,n){return e.prototype.emit.call(this,t,n)},n.listeners=function(t){return e.prototype.listeners.call(this,t)},t}(a.EventEmitter),Qe=function(e){function t(t){var n;return(n=e.call(this)||this).track=t,n.averaging=.99,n.audioLevel=0,n.rawLevel=0,n.processVolume=function(e){for(var t=e.inputBuffer.getChannelData(0),r=0,i=0;i<t.length;++i)r+=t[i]*t[i];var a=Math.sqrt(r/t.length);n.rawLevel=Math.max(a,n.rawLevel*n.averaging)},n.audioContext=new AudioContext,n.audioSource=n.audioContext.createMediaStreamSource(new MediaStream([n.track.nativeTrack])),n.processor=n.audioContext.createScriptProcessor(512),n.processor.addEventListener("audioprocess",n.processVolume),n.audioSource.connect(n.processor),n.processor.connect(n.audioContext.destination),n}h(t,e);var n=t.prototype;return n.updateAudioLevel=function(e){var t=Math.ceil(Math.min(400*e,100));(t<this.audioLevel-5||t>this.audioLevel+5)&&(this.audioLevel=t>35?t:0,this.emit("AUDIO_LEVEL_UPDATE",this.audioLevel?{track:this.track,audioLevel:this.audioLevel}:void 0))},n.start=function(){var e=this,t=-1;this.interval=window.setTimeout((function(){e.rawLevel!==t&&(t=e.rawLevel,e.updateAudioLevel(e.rawLevel)),e.start()}),1e3)},n.stop=function(){this.updateAudioLevel(0),window.clearInterval(this.interval),this.interval=void 0},t}(Ye);function ze(){if(ke&&window){var e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?Je.LOCAL:e.includes("app.100ms.live")?Je.HMS:Je.CUSTOM}return Je.CUSTOM}(We=exports.HMSAudioPluginType||(exports.HMSAudioPluginType={})).TRANSFORM="TRANSFORM",We.ANALYZE="ANALYZE",function(e){e.CUSTOM="CUSTOM",e.LOCAL="LOCAL",e.HMS="HMS"}(Je||(Je={}));var Ze,Xe,$e=ze(),et=function(){function e(e){var t=e.level,n=e.properties,r=e.includesPII,i=e.timestamp;this.name=e.name,this.level=t,this.includesPII=r||!1,this.properties=n||{},this.timestamp=i||(new Date).getTime()}return e.prototype.toSignalParams=function(){return{name:this.name,info:l({},this.properties,{timestamp:this.timestamp,domain:$e}),timestamp:(new Date).getTime()}},e}();!function(e){e[e.VERBOSE=0]="VERBOSE",e[e.INFO=1]="INFO",e[e.ERROR=2]="ERROR",e[e.OFF=3]="OFF"}(Ze||(Ze={})),function(e){e[e.VERBOSE=0]="VERBOSE",e[e.INFO=1]="INFO",e[e.ERROR=2]="ERROR",e[e.OFF=3]="OFF"}(Xe||(Xe={}));var tt=function(){function e(){}return e.failure=function(e,t){var n=Xe.ERROR,r=l({plugin_name:e},t.toAnalyticsProperties());return new et({name:"mediaPlugin.failed",level:n,properties:r})},e.audioPluginStats=function(e){return new et({name:"mediaPlugin.stats",level:Xe.INFO,properties:{plugin_name:e.pluginName,duration:e.duration,load_time:e.loadTime}})},e.stats=function(e){return new et({name:"mediaPlugin.stats",level:Xe.INFO,properties:{plugin_name:e.pluginName,duration:e.duration,load_time:e.loadTime,avg_preprocessing_time:e.avgPreProcessingTime,avg_processing_time:e.avgProcessingTime,input_frame_rate:e.inputFrameRate,plugin_frame_rate:e.pluginFrameRate}})},e}(),nt="AnalyticsEventsService",rt=new(function(){function e(){this.bufferSize=100,this.transports=[],this.pendingEvents=[],this.level=Ze.INFO}var t=e.prototype;return t.addTransport=function(e){this.transports.push(e)},t.removeTransport=function(e){this.transports.splice(this.transports.indexOf(e),1)},t.queue=function(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){var t=this.pendingEvents.shift();w.d(nt,"Max buffer size reached","Removed event to accommodate new events",t)}return this},t.flush=function(){var e=this;if(0!==this.transports.length)try{for(var t=function(){var t=e.pendingEvents.shift();t&&e.transports.forEach((function(e){return e.sendEvent(t)}))};this.pendingEvents.length>0;)t()}catch(e){w.w(nt,"Flush Failed",e)}else w.w(nt,"No valid signalling API found to flush analytics")},e}()),it="AudioPluginsAnalytics",at=function(){function e(){this.initTime={},this.addedTimestamps={},this.pluginAdded={}}var t=e.prototype;return t.added=function(e){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0},t.removed=function(e){if(this.pluginAdded[e]){var t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e]};rt.queue(tt.audioPluginStats(t)).flush(),this.clean(e)}},t.failure=function(e,t){this.pluginAdded[e]&&(rt.queue(tt.failure(e,t)).flush(),this.clean(e))},t.initWithTime=function(){var e=c(S.mark((function e(t,n){var r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.initTime[t]){e.next=3;break}return w.i(it,"Plugin Already loaded "+t+", time it took: "+this.initTime[t]),e.abrupt("return");case 3:return r=void 0,e.prev=4,e.next=7,this.timeInMs(n);case 7:w.i(it,"Time taken for Plugin "+t+" initialization : "+(r=e.sent)),e.next=17;break;case 11:throw e.prev=11,e.t0=e.catch(4),i=Z(A.AUDIO_PLUGINS,"failed during initialization of plugin"+(e.t0.message||e.t0)),w.e(it,i),this.failure(t,i),i;case 17:r&&(this.initTime[t]=r);case 18:case"end":return e.stop()}}),e,this,[[4,11]])})));return function(t,n){return e.apply(this,arguments)}}(),t.timeInMs=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Date.now(),e.next=3,t();case 3:return e.abrupt("return",Math.floor(Date.now()-n));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),t.clean=function(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e]},e}(),st="AudioPluginsManager",ot=function(){function e(e){this.pluginAddInProgress=!1,this.hmsTrack=e,this.plugins=[],this.pluginsMap={},this.analytics=new at}var t=e.prototype;return t.getPlugins=function(){return[].concat(this.plugins)},t.addPlugin=function(){var e=c(S.mark((function e(t){var n,r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.pluginAddInProgress){e.next=9;break}if((n=null==t.getName?void 0:t.getName())&&""!==n){e.next=5;break}return w.w("no name provided by the plugin"),e.abrupt("return");case 5:throw r=X(A.AUDIO_PLUGINS,"Add Plugin is already in Progress"),this.analytics.failure(n,r),w.w("can't add another plugin when previous add is in progress"),r;case 9:return this.pluginAddInProgress=!0,e.prev=10,e.next=13,this.addPluginInternal(t);case 13:e.next=18;break;case 15:throw e.prev=15,e.t0=e.catch(10),e.t0;case 18:return e.prev=18,this.pluginAddInProgress=!1,e.finish(18);case 21:case"end":return e.stop()}}),e,this,[[10,15,18,21]])})));return function(t){return e.apply(this,arguments)}}(),t.addPluginInternal=function(){var e=c(S.mark((function e(t){var n,r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=null==t.getName?void 0:t.getName())&&""!==n){e.next=4;break}return w.w("no name provided by the plugin"),e.abrupt("return");case 4:if(!this.pluginsMap[n]){e.next=7;break}return w.w(st,"plugin - "+t.getName()+" already added."),e.abrupt("return");case 7:if(!(this.plugins.length>0)){e.next=10;break}return w.w(st,"An audio plugin is already added, currently supporting only one plugin at a time"),e.abrupt("return");case 10:if(t.isSupported()){e.next=15;break}return r=z(A.AUDIO_PLUGINS,"platform not supported "),this.analytics.failure(n,r),w.i(st,"Platform is not supported for plugin - "+t.getName()),e.abrupt("return");case 15:return e.prev=15,this.analytics.added(n),e.next=19,this.analytics.initWithTime(n,c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.init());case 1:case"end":return e.stop()}}),e)}))));case 19:return this.plugins.push(n),this.pluginsMap[n]=t,e.next=23,this.startPluginsProcess();case 23:e.next=31;break;case 25:return e.prev=25,e.t0=e.catch(15),w.e(st,"failed to add plugin",e.t0),e.next=30,this.removePlugin(t);case 30:throw e.t0;case 31:case"end":return e.stop()}}),e,this,[[15,25]])})));return function(t){return e.apply(this,arguments)}}(),t.removePlugin=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.getName(),this.pluginsMap[n]){e.next=4;break}return w.w(st,"plugin - "+n+" not found to remove."),e.abrupt("return");case 4:if(w.i(st,"removing plugin "+n),this.removePluginEntry(n),0!==this.plugins.length){e.next=10;break}return w.i(st,"No plugins left, stopping plugins loop"),e.next=10,this.stopPluginsProcess();case 10:this.intermediateNode&&(this.intermediateNode.disconnect(),this.intermediateNode=null),t.stop(),this.analytics.removed(n);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.removePluginEntry=function(e){var t=this.plugins.indexOf(e);-1!==t&&this.plugins.splice(t,1),this.pluginsMap[e]&&delete this.pluginsMap[e]},t.cleanup=function(){var e=c(S.mark((function e(){var t,n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=E(this.plugins);case 1:if((r=n()).done){e.next=7;break}return i=r.value,e.next=5,this.removePlugin(this.pluginsMap[i]);case 5:e.next=1;break;case 7:null==(t=this.outputTrack)||t.stop();case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.initElementsAndStream=function(){if(this.audioContext||(this.audioContext=new AudioContext),!this.sourceNode){var e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e)}this.destinationNode||(this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0])},t.startPluginsProcess=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.initElementsAndStream(),this.audioContext){e.next=4;break}return w.w(st,"Audio context is not defined"),e.abrupt("return");case 4:return e.prev=4,e.next=7,this.hmsTrack.setProcessedTrack(this.outputTrack);case 7:e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(4),w.e(st,"error in setting processed track",e.t0),e.t0;case 13:return e.prev=13,e.next=16,this.processAudioThroughPlugins();case 16:e.next=22;break;case 18:throw e.prev=18,e.t1=e.catch(13),w.e(st,"error in processing audio plugins",e.t1),e.t1;case 22:case"end":return e.stop()}}),e,this,[[4,9],[13,18]])})));return function(){return e.apply(this,arguments)}}(),t.processAudioThroughPlugins=function(){var e=c(S.mark((function e(){var t,n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=E(this.plugins);case 1:if((n=t()).done){e.next=29;break}if(i=this.pluginsMap[r=n.value]){e.next=6;break}return e.abrupt("continue",27);case 6:if(e.prev=6,!this.audioContext){e.next=11;break}return e.next=10,i.processAudioTrack(this.audioContext,this.intermediateNode||this.sourceNode);case 10:this.intermediateNode=e.sent;case 11:e.next=18;break;case 13:return e.prev=13,e.t0=e.catch(6),w.e(st,"error in processing plugin "+r,e.t0),e.next=18,this.removePlugin(i);case 18:e.prev=18,this.intermediateNode&&this.destinationNode&&this.intermediateNode.context===this.destinationNode.context&&this.intermediateNode.connect(this.destinationNode),e.next=27;break;case 22:return e.prev=22,e.t1=e.catch(18),w.e(st,"error in processing plugin "+r,e.t1),e.next=27,this.removePlugin(i);case 27:e.next=1;break;case 29:case"end":return e.stop()}}),e,this,[[6,13],[18,22]])})));return function(){return e.apply(this,arguments)}}(),t.stopPluginsProcess=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.hmsTrack.setProcessedTrack(void 0);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e}(),ct=function(){function e(e){this.key=e,this.storage=null}var t=e.prototype;return t.getStorage=function(){return ke&&(this.storage=window.localStorage),this.storage},t.get=function(){var e,t=null==(e=this.getStorage())?void 0:e.getItem(this.key);if(t)return JSON.parse(t)},t.set=function(e){var t,n=JSON.stringify(e);null==(t=this.getStorage())||t.setItem(this.key,n)},t.clear=function(){var e;null==(e=this.getStorage())||e.removeItem(this.key)},e}(),ut=new(function(){function e(){this.storage=new ct("hms-device-selection"),this.remember=!1}var t=e.prototype;return t.setDevices=function(e){this.devices=e},t.rememberDevices=function(e){this.remember=e},t.updateSelection=function(e,t){var n=this,r=t.deviceId,i=t.groupId;if(this.devices&&this.remember){var a=this.devices[e].find((function(e){return n.isSame({deviceId:r,groupId:i},e)}));if(a){var s=this.storage.get()||{};s[e]=a,this.storage.set(s)}}},t.getSelection=function(){if(this.remember)return this.storage.get()},t.cleanup=function(){this.remember=!1,this.devices=void 0},t.isSame=function(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)},e}());function dt(e,t){return function(n){return n in e&&e[n]!==t[n]}}var lt,ht="HMSLocalAudioTrack",pt=function(e){function t(t,n,r,i){var a;return void 0===i&&(i=(new De).build()),a=e.call(this,t,n,r)||this,t.tracks.push(k(a)),a.settings=i,a.pluginsManager=new ot(k(a)),a.publishedTrackId=a.trackId,a.setFirstTrackId(n.id),a}h(t,e);var n=t.prototype;return n.replaceTrackWith=function(){var e=c(S.mark((function e(t){var n,r,i,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.enabled,null==(n=this.nativeTrack)||n.stop(),e.next=5,He(t);case 5:return(i=e.sent).enabled=r,a=this.stream,e.next=10,a.replaceSenderTrack(n,this.processedTrack||i);case 10:return e.next=12,a.replaceStreamTrack(n,i);case 12:this.nativeTrack=i;case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.setEnabled=function(){var t=c(S.mark((function t(n){return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==this.enabled){t.next=2;break}return t.abrupt("return");case 2:if(!n||!Ke(this.nativeTrack)){t.next=5;break}return t.next=5,this.replaceTrackWith(this.settings);case 5:return t.next=7,e.prototype.setEnabled.call(this,n);case 7:this.stream.trackUpdate(this);case 8:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),n.setSettings=function(){var e=c(S.mark((function e(t,n){var r,i,a,s,o,c,u;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n=!1),r=l({},this.settings,t),i=new _e(r.volume,r.codec,r.maxBitrate,r.deviceId,r.advanced),!Ke(this.nativeTrack)){e.next=6;break}return this.settings=i,e.abrupt("return");case 6:if(a=this.stream,!(s=dt(t,this.settings))("deviceId")){e.next=17;break}return c=Boolean(this.audioLevelMonitor),u=null==(o=this.audioLevelMonitor)?void 0:o.listeners("AUDIO_LEVEL_UPDATE"),w.d(ht,"Device change",{isLevelMonitored:c}),c&&this.destroyAudioLevelMonitor(),e.next=15,this.replaceTrackWith(i);case 15:c&&this.initAudioLevelMonitor(u),n||ut.updateSelection("audioInput",{deviceId:t.deviceId,groupId:this.nativeTrack.getSettings().groupId});case 17:if(!s("maxBitrate")){e.next=20;break}return e.next=20,a.setMaxBitrate(i.maxBitrate,this);case 20:if(!s("advanced")){e.next=23;break}return e.next=23,this.nativeTrack.applyConstraints(i.toConstraints());case 23:this.settings=i;case 24:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.getPlugins=function(){return this.pluginsManager.getPlugins()},n.addPlugin=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.pluginsManager.addPlugin(t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.removePlugin=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.pluginsManager.removePlugin(t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.setProcessedTrack=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=6;break}if(!this.processedTrack){e.next=4;break}return e.next=4,this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack);case 4:return this.processedTrack=void 0,e.abrupt("return");case 6:if(t===this.processedTrack){e.next=15;break}if(!this.processedTrack){e.next=12;break}return e.next=10,this.stream.replaceSenderTrack(this.processedTrack,t);case 10:e.next=14;break;case 12:return e.next=14,this.stream.replaceSenderTrack(this.nativeTrack,t);case 14:this.processedTrack=t;case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.initAudioLevelMonitor=function(e){var t=this;w.d(ht,"Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new Qe(this),null==e||e.forEach((function(e){var n;return null==(n=t.audioLevelMonitor)?void 0:n.on("AUDIO_LEVEL_UPDATE",e)})),this.audioLevelMonitor.start()},n.destroyAudioLevelMonitor=function(){var e;null==(e=this.audioLevelMonitor)||e.stop(),this.audioLevelMonitor=void 0},n.cleanup=function(){var t=c(S.mark((function t(){var n;return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.prototype.cleanup.call(this),t.next=3,this.pluginsManager.cleanup();case 3:null==(n=this.processedTrack)||n.stop(),this.destroyAudioLevelMonitor();case 5:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),n.getTrackIDBeingSent=function(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id},t}(le);function ft(e){if(e<0)throw Error("`ms` should be a positive integer");return new Promise((function(t){return setTimeout(t,e)}))}(lt=exports.HMSVideoPluginType||(exports.HMSVideoPluginType={})).TRANSFORM="TRANSFORM",lt.ANALYZE="ANALYZE";var vt=function(){function e(){this.total=0,this.count=0}var t=e.prototype;return t.add=function(e){this.count++,this.total+=e},t.getAvg=function(){return Math.floor(this.total/this.count)},t.reset=function(){this.total=0,this.count=0},e}(),gt="VideoPluginsAnalytics",mt=function(){function e(){this.initTime={},this.preProcessingAvgs=new vt,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}var t=e.prototype;return t.added=function(e,t,n){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new vt,this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=n||t},t.removed=function(e){if(this.pluginAdded[e]){var t,n={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:null==(t=this.processingAvgs[e])?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};rt.queue(tt.stats(n)).flush(),this.clean(e)}},t.failure=function(e,t){this.pluginAdded[e]&&(rt.queue(tt.failure(e,t)).flush(),this.clean(e))},t.initWithTime=function(){var e=c(S.mark((function e(t,n){var r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.initTime[t]){e.next=3;break}return w.i(gt,"Plugin Already loaded "+t+", time it took: "+this.initTime[t]),e.abrupt("return");case 3:return r=void 0,e.prev=4,e.next=7,this.timeInMs(n);case 7:w.i(gt,"Time taken for Plugin "+t+" initialization : "+(r=e.sent)),e.next=17;break;case 11:throw e.prev=11,e.t0=e.catch(4),i=Z(A.VIDEO_PLUGINS,"failed during initialization of plugin"+(e.t0.message||e.t0)),w.e(gt,i),this.failure(t,i),i;case 17:r&&(this.initTime[t]=r);case 18:case"end":return e.stop()}}),e,this,[[4,11]])})));return function(t,n){return e.apply(this,arguments)}}(),t.preProcessWithTime=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.timeInMs(t);case 2:this.preProcessingAvgs.add(e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.processWithTime=function(){var e=c(S.mark((function e(t,n){var r,i,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0,e.prev=1,e.next=4,this.timeInMs(n);case 4:r=e.sent,e.next=13;break;case 7:throw e.prev=7,e.t0=e.catch(1),void 0===(s="Failed during processing of plugin"+(e.t0.message||e.t0))&&(s=""),i=new R(7003,"ProcessingFailed",A.VIDEO_PLUGINS,"Plugin processing failed",s),w.e(gt,i),this.failure(t,i),i;case 13:r&&(null==(a=this.processingAvgs[t])||a.add(r));case 14:case"end":return e.stop()}var s}),e,this,[[1,7]])})));return function(t,n){return e.apply(this,arguments)}}(),t.timeInMs=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Date.now(),e.next=3,t();case 3:return e.abrupt("return",Math.floor(Date.now()-n));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),t.clean=function(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]},e}(),kt="VideoPluginsManager",Tt=function(){function e(e){this.pluginsLoopRunning=!1,this.pluginsLoopState="paused",this.pluginAddInProgress=!1,this.hmsTrack=e,this.plugins=[],this.pluginsMap={},this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new mt}var t=e.prototype;return t.getPlugins=function(){return[].concat(this.plugins)},t.addPlugin=function(){var e=c(S.mark((function e(t,n){var r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.pluginAddInProgress){e.next=9;break}if((r=null==t.getName?void 0:t.getName())&&""!==r){e.next=5;break}return w.w("no name provided by the plugin"),e.abrupt("return");case 5:throw i=X(A.VIDEO_PLUGINS,"Add Plugin is already in Progress"),this.analytics.failure(r,i),w.w("can't add another plugin when previous add is in progress"),i;case 9:return this.pluginAddInProgress=!0,e.prev=10,e.next=13,this.addPluginInternal(t,n);case 13:e.next=18;break;case 15:throw e.prev=15,e.t0=e.catch(10),e.t0;case 18:return e.prev=18,this.pluginAddInProgress=!1,e.finish(18);case 21:case"end":return e.stop()}}),e,this,[[10,15,18,21]])})));return function(t,n){return e.apply(this,arguments)}}(),t.addPluginInternal=function(){var e=c(S.mark((function e(t,n){var r,i,a,s,o,u,d;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=null==t.getName?void 0:t.getName())&&""!==r){e.next=4;break}return w.w("no name provided by the plugin"),e.abrupt("return");case 4:if(!this.pluginsMap[r]){e.next=7;break}return w.w(kt,"plugin - "+t.getName()+" already added."),e.abrupt("return");case 7:if(i=this.hmsTrack.getMediaTrackSettings(),s=i.height,!(!(a=i.width)||!s||a<=0||s<=0)){e.next=11;break}return w.i(kt,"Track width/height is not valid"),e.abrupt("return");case 11:if(o=this.hmsTrack.getMediaTrackSettings().frameRate||24,u=0,n&&n>0?(w.i(kt,"adding plugin "+t.getName()+" with framerate "+n),n<o&&(u=Math.ceil(o/n)-1),this.analytics.added(r,o,n)):(w.i(kt,"adding plugin "+t.getName()),this.analytics.added(r,o)),w.i(kt,"numFrames to skip processing",u),this.pluginNumFramesToSkip[r]=u,this.pluginNumFramesSkipped[r]=u,t.isSupported()){e.next=22;break}return d=z(A.VIDEO_PLUGINS,"platform not supported "),this.analytics.failure(r,d),w.i(kt,"Platform is not supported for plugin - "+t.getName()),e.abrupt("return");case 22:return e.prev=22,e.next=25,this.analytics.initWithTime(r,c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.init();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 25:return this.plugins.push(r),this.pluginsMap[r]=t,e.next=29,this.startPluginsLoop();case 29:e.next=37;break;case 31:return e.prev=31,e.t0=e.catch(22),w.e(kt,"failed to add plugin",e.t0),e.next=36,this.removePlugin(t);case 36:throw e.t0;case 37:case"end":return e.stop()}}),e,this,[[22,31]])})));return function(t,n){return e.apply(this,arguments)}}(),t.removePlugin=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.getName(),this.pluginsMap[n]){e.next=4;break}return w.w(kt,"plugin - "+n+" not found to remove."),e.abrupt("return");case 4:if(w.i(kt,"removing plugin "+n),this.removePluginEntry(n),0!==this.plugins.length){e.next=10;break}return w.i(kt,"No plugins left, stopping plugins loop"),e.next=10,this.stopPluginsLoop();case 10:t.stop(),this.analytics.removed(n);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.removePluginEntry=function(e){var t=this.plugins.indexOf(e);-1!==t&&this.plugins.splice(t,1),this.pluginsMap[e]&&delete this.pluginsMap[e],this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]},t.waitForRestart=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.pluginsLoopRunning&&"running"!==this.pluginsLoopState){e.next=2;break}return e.abrupt("return");case 2:if("paused"!==this.pluginsLoopState){e.next=7;break}return e.next=5,ft(100);case 5:e.next=2;break;case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.cleanup=function(){var e=c(S.mark((function e(){var t,n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=E(this.plugins);case 1:if((r=n()).done){e.next=7;break}return i=r.value,e.next=5,this.removePlugin(this.pluginsMap[i]);case 5:e.next=1;break;case 7:null==(t=this.outputTrack)||t.stop();case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.initElementsAndStream=function(){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas||(this.outputCanvas=document.createElement("canvas")),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext("2d");var e=this.outputCanvas.captureStream();this.outputTrack=e.getVideoTracks()[0]},t.startPluginsLoop=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.pluginsLoopRunning){e.next=2;break}return e.abrupt("return");case 2:return this.initElementsAndStream(),this.pluginsLoopRunning=!0,e.prev=4,e.next=7,this.hmsTrack.setProcessedTrack(this.outputTrack);case 7:e.next=14;break;case 9:throw e.prev=9,e.t0=e.catch(4),this.pluginsLoopRunning=!1,w.e(kt,"error in setting processed track",e.t0),e.t0;case 14:this.pluginsLoop().then((function(){w.d(kt,"processLoop stopped")}));case 15:case"end":return e.stop()}}),e,this,[[4,9]])})));return function(){return e.apply(this,arguments)}}(),t.stopPluginsLoop=function(){var e=c(S.mark((function e(){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.pluginsLoopRunning=!1,e.next=3,this.hmsTrack.setProcessedTrack(void 0);case 3:this.resetCanvases(),null==(t=this.outputTrack)||t.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.pluginsLoop=function(){var e=c(S.mark((function e(){var t,n,r,i,a=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.pluginsLoopRunning){e.next=28;break}if(t=this.hmsTrack.getMediaTrackSettings().frameRate||24,n=Math.floor(1e3/t),this.hmsTrack.enabled&&"ended"!==this.hmsTrack.nativeTrack.readyState){e.next=9;break}return"running"===this.pluginsLoopState&&this.resetCanvases(),this.pluginsLoopState="paused",e.next=8,ft(n);case 8:return e.abrupt("continue",0);case 9:return r=0,e.prev=10,e.next=13,this.analytics.preProcessWithTime(c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.doPreProcessing();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 13:return i=Date.now(),e.next=16,this.processFramesThroughPlugins();case 16:(r=Math.floor(Date.now()-i))>n&&(r=n),e.next=23;break;case 20:e.prev=20,e.t0=e.catch(10),w.e(kt,"error in plugins loop",e.t0);case 23:return this.pluginsLoopState="running",e.next=26,ft(n-r);case 26:e.next=0;break;case 28:case"end":return e.stop()}}),e,this,[[10,20]])})));return function(){return e.apply(this,arguments)}}(),t.doPreProcessing=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.addTrackToVideo();case 2:return e.next=4,this.updateInputCanvas();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.processFramesThroughPlugins=function(){var e=c(S.mark((function e(){var t,n,r,i=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=S.mark((function e(){var t,n,a,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.pluginsMap[t=r.value]){e.next=4;break}return e.abrupt("return","continue");case 4:if(e.prev=4,a=i.checkIfSkipRequired(t),n.getPluginType()!==exports.HMSVideoPluginType.TRANSFORM){e.next=17;break}if(s=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.processVideoFrame(i.inputCanvas,i.outputCanvas,a);case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),a){e.next=13;break}return e.next=11,i.analytics.processWithTime(t,s);case 11:e.next=15;break;case 13:return e.next=15,s();case 15:e.next=20;break;case 17:if(n.getPluginType()!==exports.HMSVideoPluginType.ANALYZE||a){e.next=20;break}return e.next=20,i.analytics.processWithTime(t,c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.processVideoFrame(i.inputCanvas);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))));case 20:e.next=27;break;case 22:return e.prev=22,e.t0=e.catch(4),w.e(kt,"error in processing plugin "+t,e.t0),e.next=27,i.removePlugin(n);case 27:case"end":return e.stop()}}),e,null,[[4,22]])})),n=E(this.plugins);case 2:if((r=n()).done){e.next=9;break}return e.delegateYield(t(),"t0",4);case 4:if("continue"!==e.t0){e.next=7;break}return e.abrupt("continue",7);case 7:e.next=2;break;case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.addTrackToVideo=function(){var e=c(S.mark((function e(){var t,n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.inputVideo){e.next=2;break}return e.abrupt("return");case 2:if(!(null!==(t=this.inputVideo.srcObject)&&t instanceof MediaStream)){e.next=7;break}if((null==(n=t.getVideoTracks()[0])?void 0:n.id)!==this.hmsTrack.nativeTrack.id){e.next=7;break}return e.abrupt("return");case 7:return this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,e.next=12,this.inputVideo.play();case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.updateInputCanvas=function(){var e=c(S.mark((function e(){var t,n,r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.inputCanvas&&this.inputVideo){e.next=2;break}return e.abrupt("return");case 2:if(t=this.hmsTrack.getMediaTrackSettings(),r=t.height,!(!(n=t.width)||!r||n<=0||r<=0)){e.next=6;break}return w.w(kt,"Invalid width/height of videoTrack",n,r),e.abrupt("return");case 6:this.inputCanvas.height!==r&&(this.inputCanvas.height=r),this.inputCanvas.width!==n&&(this.inputCanvas.width=n),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,n,r);case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.resetCanvases=function(){if(this.outputCanvas&&this.inputCanvas){var e=this.outputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height));var t=this.inputCanvas.getContext("2d");t&&(t.fillStyle="rgb(0, 0, 0)",t.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height))}},t.checkIfSkipRequired=function(e){var t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t},e}();function Et(e,t){return function(n){return n in e&&e[n]!==t[n]}}var xt,yt=function(e){function t(t,n,r,i){var a;return void 0===i&&(i=(new Le).build()),a=e.call(this,t,n,r)||this,t.tracks.push(k(a)),a.settings=i,a.pluginsManager=new Tt(k(a)),a.publishedTrackId=a.trackId,a.setFirstTrackId(a.trackId),a}h(t,e);var n=t.prototype;return n.setEnabled=function(){var t=c(S.mark((function t(n){return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==this.enabled){t.next=2;break}return t.abrupt("return");case 2:if("regular"!==this.source){t.next=10;break}if(!n){t.next=8;break}return t.next=6,this.replaceTrackWith(this.settings);case 6:t.next=10;break;case 8:return t.next=10,this.replaceTrackWithBlank();case 10:return t.next=12,e.prototype.setEnabled.call(this,n);case 12:this.stream.trackUpdate(this);case 13:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),n.addSink=function(e){this.addSinkInternal(e,this.processedTrack||this.nativeTrack)},n.setSettings=function(){var e=c(S.mark((function e(t,n){var r,i,a,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n=!1),r=l({},this.settings,t),i=new Oe(r.width,r.height,r.codec,r.maxFramerate,r.deviceId,r.advanced,r.maxBitrate),this.enabled){e.next=6;break}return this.settings=i,e.abrupt("return");case 6:if(a=this.stream,!(s=Et(t,this.settings))("deviceId")||"regular"!==this.source){e.next=13;break}if(!this.enabled){e.next=13;break}return e.next=12,this.replaceTrackWith(i);case 12:n||ut.updateSelection("videoInput",{deviceId:t.deviceId,groupId:this.nativeTrack.getSettings().groupId});case 13:if(!s("maxBitrate")||!i.maxBitrate){e.next=16;break}return e.next=16,a.setMaxBitrate(i.maxBitrate,this);case 16:if(!(s("width")||s("height")||s("advanced"))){e.next=19;break}return e.next=19,this.nativeTrack.applyConstraints(i.toConstraints());case 19:this.settings=i;case 20:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.getPlugins=function(){return this.pluginsManager.getPlugins()},n.addPlugin=function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.pluginsManager.addPlugin(t,n));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.removePlugin=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.pluginsManager.removePlugin(t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.cleanup=function(){var t=c(S.mark((function t(){var n;return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.prototype.cleanup.call(this),t.next=3,this.pluginsManager.cleanup();case 3:null==(n=this.processedTrack)||n.stop();case 4:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}(),n.setProcessedTrack=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.nativeTrack.enabled){e.next=3;break}return this.processedTrack=t,e.abrupt("return");case 3:if(t){e.next=9;break}if(!this.processedTrack){e.next=7;break}return e.next=7,this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack);case 7:return this.processedTrack=void 0,e.abrupt("return");case 9:if(t===this.processedTrack){e.next=18;break}if(!this.processedTrack){e.next=15;break}return e.next=13,this.stream.replaceSenderTrack(this.processedTrack,t);case 13:e.next=17;break;case 15:return e.next=17,this.stream.replaceSenderTrack(this.nativeTrack,t);case 17:this.processedTrack=t;case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.getTrackIDBeingSent=function(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id},n.replaceTrackWith=function(){var e=c(S.mark((function e(t){var n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null==(n=this.nativeTrack)||n.stop(),e.next=4,Be(t);case 4:return r=e.sent,i=this.stream,e.next=8,i.replaceSenderTrack(n,this.processedTrack||r);case 8:return e.next=10,i.replaceStreamTrack(n,r);case 10:return this.nativeTrack=r,e.next=13,this.pluginsManager.waitForRestart();case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.replaceTrackWithBlank=function(){var e=c(S.mark((function e(){var t,n,r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null==(t=this.nativeTrack)||t.stop(),n=je(t),r=this.stream,e.next=6,r.replaceSenderTrack(this.processedTrack||this.nativeTrack,n);case 6:return e.next=8,r.replaceStreamTrack(this.nativeTrack,n);case 8:this.nativeTrack=n;case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t}(pe),bt="HMSLocalStream",St=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).connection=null,t}h(t,e);var n=t.prototype;return n.setConnection=function(e){this.connection=e},t.getLocalScreen=function(){var e=c(S.mark((function e(n,r){var i,a,s,o,c,u,d,h,p;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return delete(i=r.toConstraints()).advanced,a={video:n.toConstraints(),audio:l({},i,{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})},e.prev=3,e.next=6,navigator.mediaDevices.getDisplayMedia(a);case 6:s=e.sent,e.next=12;break;case 9:throw e.prev=9,e.t0=e.catch(3),Ge(e.t0,Re.SCREEN);case 12:return o=[],c=new t(s),u=s.getVideoTracks()[0],d=new yt(c,u,"screen",n),o.push(d),(h=s.getAudioTracks()[0])&&(p=new pt(c,h,"screen",r),o.push(p)),w.v(bt,"getLocalScreen",o),e.abrupt("return",o);case 21:case"end":return e.stop()}}),e,null,[[3,9]])})));return function(t,n){return e.apply(this,arguments)}}(),t.getLocalTracks=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getEmptyLocalTracks({audio:!0,video:!0},t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.getEmptyLocalTracks=function(){var e=c(S.mark((function e(n,r){var i,a,s,o,c,u,d;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n={audio:!0,video:!0}),e.next=3,this.getNativeLocalTracks(n,r);case 3:return a=(i=e.sent).find((function(e){return"video"===e.kind})),s=i.find((function(e){return"audio"===e.kind})),o=new t(new MediaStream(i)),c=[],s&&null!=r&&r.audio&&(u=new pt(o,s,"regular",r.audio),c.push(u)),a&&null!=r&&r.video&&(d=new yt(o,a,"regular",r.video),c.push(d)),w.v(bt,"getEmptyLocalTracks",c),e.abrupt("return",c);case 12:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.addTransceiver=function(e,t){var n=[];if(e instanceof yt)if(t.length>0)w.v(bt,"Simulcast enabled with layers",t),n.push.apply(n,t);else{var r={active:this.nativeStream.active};e.settings.maxBitrate&&!me&&(r.maxBitrate=e.settings.maxBitrate),n.push(r)}var i=this.connection.addTransceiver(e.nativeTrack,{streams:[this.nativeStream],direction:"sendonly",sendEncodings:n});return this.setPreferredCodec(i,e.nativeTrack.kind),i},n.setMaxBitrate=function(){var e=c(S.mark((function e(t,n){var r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null==(r=this.connection)?void 0:r.setMaxBitrate(t,n);case 2:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.setPreferredCodec=function(e,t){},n.replaceTrack=function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.replaceSenderTrack(t,n);case 2:t.stop(),this.replaceStreamTrack(t,n);case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.replaceStreamTrack=function(e,t){this.nativeStream.addTrack(t),this.nativeStream.removeTrack(e)},n.replaceSenderTrack=function(){var e=c(S.mark((function e(t,n){var r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==(i=null==(r=this.connection)?void 0:r.getSenders().find((function(e){return e.track&&e.track.id===t.id})))){e.next=4;break}return w.w(bt,"No sender found for trackId="+t.id),e.abrupt("return");case 4:return e.next=6,i.replaceTrack(n);case 6:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.removeSender=function(e){var t=this,n=0;this.connection.getSenders().forEach((function(r){var i,a;if((null==(i=r.track)?void 0:i.id)===e.trackId||(null==(a=r.track)?void 0:a.id)===e.getTrackIDBeingSent()){t.connection.removeTrack(r),n+=1;var s=t.tracks.indexOf(e);-1!==s?t.tracks.splice(s,1):w.e(bt,"Cannot find "+e.trackId+" in locally stored tracks")}})),1!==n&&w.e(bt,"Removed "+n+" sender's, expected to remove 1")},n.trackUpdate=function(e){var t;null==(t=this.connection)||t.trackUpdate(e)},t.getNativeLocalTracks=function(){var e=c(S.mark((function e(t,n){var r,i,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t={audio:!1,video:!1}),"empty"!==t.video){e.next=5;break}e.t0=je(),e.next=11;break;case 5:if(e.t1=t.video&&(null==n?void 0:n.video),!e.t1){e.next=10;break}return e.next=9,Be(n.video);case 9:e.t1=e.sent;case 10:e.t0=e.t1;case 11:if(r=e.t0,"empty"!==t.audio){e.next=16;break}e.t2=qe(),e.next=22;break;case 16:if(e.t3=t.audio&&(null==n?void 0:n.audio),!e.t3){e.next=21;break}return e.next=20,He(n.audio);case 20:e.t3=e.sent;case 21:e.t2=e.t3;case 22:return a=[],(i=e.t2)&&a.push(i),r&&a.push(r),e.abrupt("return",a);case 27:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),t}(re);!function(e){e.PEER_JOIN="on-peer-join",e.PEER_LEAVE="on-peer-leave",e.PEER_LIST="peer-list",e.TRACK_METADATA_ADD="on-track-add",e.TRACK_UPDATE="on-track-update",e.CHANGE_TRACK_MUTE_STATE_UPDATE="on-change-track-mute-state-request",e.ACTIVE_SPEAKERS="active-speakers",e.BROADCAST="on-broadcast",e.ROLE_CHANGE="on-role-change",e.POLICY_CHANGE="on-policy-change",e.ROLE_CHANGE_REQUEST="on-role-change-request",e.TRACK_UPDATE_REQUEST="on-track-update-request",e.PEER_UPDATE="on-peer-update",e.PEER_LEAVE_REQUEST="on-peer-leave-request",e.UNSUPPORTED="unsupported",e.RTMP_START="on-rtmp-start",e.RTMP_STOP="on-rtmp-stop",e.RECORDING_START="on-record-start",e.RECORDING_STOP="on-record-stop"}(xt||(xt={}));var wt=function(){function e(e,t,n){this.store=e,this.listener=t,this.audioListener=n}return e.prototype.handleActiveSpeakers=function(e){var t,n=this,r=e["speaker-list"],i=r.map((function(e){return{audioLevel:e.level,peer:n.store.getPeerById(e.peer_id),track:n.store.getTrackById(e.track_id)}}));null==(t=this.audioListener)||t.onAudioLevelUpdate(i),this.store.updateSpeakers(i);var a=r[0];if(a){var s,o=this.store.getPeerById(a.peer_id);null==(s=this.listener)||s.onPeerUpdate(exports.HMSPeerUpdate.BECAME_DOMINANT_SPEAKER,o)}else{var c;null==(c=this.listener)||c.onPeerUpdate(exports.HMSPeerUpdate.RESIGNED_DOMINANT_SPEAKER,null)}},e}(),It=function(){function e(e){var t=e.message,n=e.type,r=void 0===n?"chat":n,i=e.recipientPeer,a=e.recipientRoles,s=e.time;this.sender=e.sender,this.message=t,this.type=r,this.recipientPeer=i,this.recipientRoles=a,this.time=s}return e.prototype.toSignalParams=function(){var e,t,n=null==(e=this.recipientRoles)?void 0:e.map((function(e){return e.name})),r=null==(t=this.recipientPeer)?void 0:t.peerId,i={info:{sender:this.sender.peerId,message:this.message,type:this.type}};return null!=n&&n.length&&(i.roles=n),r&&(i.peer_id=r),i},e}(),At=function(){function e(e){var t=e.peerId,n=e.name,r=e.isLocal,i=e.customerUserId,a=e.customerDescription,s=e.role;this.customerUserId="",this.customerDescription="",this.auxiliaryTracks=[],this.name=n,this.peerId=t,this.isLocal=r,this.customerUserId=i,this.customerDescription=a,s&&(this.role=s)}return e.prototype.updateRole=function(e){this.role=e},e}(),Pt=function(){};Pt.makePeerId=function(){return i.v4()};var Rt,Ct=function(e){function t(t){var n;return(n=e.call(this,l({},t,{peerId:Pt.makePeerId(),isLocal:!0}))||this).isLocal=!0,n.auxiliaryTracks=[],n}return h(t,e),t}(At),Mt=function(e){function t(t){var n;return(n=e.call(this,l({},t,{isLocal:!1}))||this).isLocal=!1,n.auxiliaryTracks=[],n}return h(t,e),t}(At),Dt=function(){function e(e,t){this.store=e,this.listener=t}return e.prototype.handleBroadcast=function(e){var t,n,r=e.peer,i=e.info,a=e.roles,s=this.store.getPeerById(r.peer_id);s||(s=new At({peerId:r.peer_id,name:r.info.name,isLocal:!1,customerUserId:r.info.user_id,customerDescription:r.info.data}));var o=[];if(null!=a&&a.length)for(var c,u=this.store.getKnownRoles(),d=E(a);!(c=d()).done;){var h=c.value;u[h]&&o.push(u[h])}e.private&&(n=this.store.getLocalPeer());var p=new It(l({},i,{sender:s,recipientRoles:o,recipientPeer:n,time:new Date(e.timestamp)}));w.d(this.TAG,"Received Message:: ",p),null==(t=this.listener)||t.onMessageReceived(p)},d(e,[{key:"TAG",get:function(){return"["+this.constructor.name+"]"}}]),e}(),_t=function(){function e(e,t,n,r){var i=this;this.store=e,this.peerManager=t,this.trackManager=n,this.listener=r,this.handleInitialPeerList=function(e){var t=Object.values(e.peers);i.peerManager.handlePeerList(t)},this.handleReconnectPeerList=function(e){var t=i.store.getRemotePeers(),n=Object.values(e.peers),r=t.filter((function(t){return!e.peers.hasOwnProperty(t.peerId)}));w.d(i.TAG,{peersToRemove:r}),r.forEach((function(e){var t,n={peer_id:e.peerId,role:(null==(t=e.role)?void 0:t.name)||"",info:{name:e.name,data:e.customerDescription||"",user_id:e.customerUserId||""},tracks:{}};i.peerManager.handlePeerLeave(n)})),n.forEach((function(e){var t=i.store.getPeerById(e.peer_id),n=Object.values(e.tracks);t?(i.store.getPeerTracks(t.peerId).forEach((function(n){var r;e.tracks.hasOwnProperty(n.trackId)||(i.removePeerTrack(t,n.trackId),null==(r=i.listener)||r.onTrackUpdate(exports.HMSTrackUpdate.TRACK_REMOVED,n,t))})),n.forEach((function(e){i.store.getTrackById(e.track_id)||i.store.setTrackState({peerId:t.peerId,trackInfo:e})})),i.trackManager.handleTrackUpdate({peer:{info:e.info,peer_id:e.peer_id},tracks:e.tracks})):i.peerManager.handlePeerJoin(e)}))}}return e.prototype.removePeerTrack=function(e,t){var n,r;if((null==(n=e.audioTrack)?void 0:n.trackId)===t)e.audioTrack=void 0;else if((null==(r=e.videoTrack)?void 0:r.trackId)===t)e.videoTrack=void 0;else{var i=e.auxiliaryTracks.findIndex((function(e){return e.trackId===t}));i>=0&&e.auxiliaryTracks.splice(i,1)}},d(e,[{key:"TAG",get:function(){return"["+this.constructor.name+"]"}}]),e}(),Lt=function(){function e(e,t,n){var r=this;this.store=e,this.trackManager=t,this.listener=n,this.handlePeerList=function(e){var t;if(0!==e.length){for(var n,i=[],a=E(e);!(n=a()).done;)i.push(r.makePeer(n.value));null==(t=r.listener)||t.onPeerUpdate(exports.HMSPeerUpdate.PEER_LIST,i),r.trackManager.processPendingTracks()}},this.handlePeerJoin=function(e){var t,n=r.makePeer(e);null==(t=r.listener)||t.onPeerUpdate(exports.HMSPeerUpdate.PEER_JOINED,n),r.trackManager.processPendingTracks()},this.handlePeerLeave=function(e){var t,n,i,a,s=r.store.getPeerById(e.peer_id);r.store.removePeer(e.peer_id),w.d(r.TAG,"PEER_LEAVE event",e,r.store.getPeers()),s&&(s.audioTrack&&(null==(i=r.listener)||i.onTrackUpdate(exports.HMSTrackUpdate.TRACK_REMOVED,s.audioTrack,s)),s.videoTrack&&(null==(a=r.listener)||a.onTrackUpdate(exports.HMSTrackUpdate.TRACK_REMOVED,s.videoTrack,s)),null==(t=s.auxiliaryTracks)||t.forEach((function(e){var t;null==(t=r.listener)||t.onTrackUpdate(exports.HMSTrackUpdate.TRACK_REMOVED,e,s)})),null==(n=r.listener)||n.onPeerUpdate(exports.HMSPeerUpdate.PEER_LEFT,s))}}var t=e.prototype;return t.handlePeerUpdate=function(e){var t=this.store.getPeerById(e.peer_id);if(t&&t.role&&t.role.name!==e.role){var n,r=this.store.getPolicyForRole(e.role);t.updateRole(r),null==(n=this.listener)||n.onPeerUpdate(exports.HMSPeerUpdate.ROLE_UPDATED,t)}},t.makePeer=function(e){var t=new Mt({peerId:e.peer_id,name:e.info.name,customerUserId:e.info.user_id,customerDescription:e.info.data,role:this.store.getPolicyForRole(e.role)});for(var n in this.store.addPeer(t),w.d(this.TAG,"adding to the peerList",t),e.tracks)this.store.setTrackState({peerId:e.peer_id,trackInfo:e.tracks[n]});return t},d(e,[{key:"TAG",get:function(){return"["+this.constructor.name+"]"}}]),e}(),Ot=function(){function e(e,t){this.store=e,this.eventEmitter=t}return e.prototype.handlePolicyChange=function(e){var t,n=this.store.getLocalPeer();n&&!n.role&&n.updateRole(e.known_roles[e.name]),this.store.setKnownRoles(e.known_roles);var r=null==(t=e.known_roles[e.name])?void 0:t.publishParams;if(this.store.setPublishParams(r),r&&Object.keys(r).length>0){var i=r.screenSimulcastLayers;this.store.setVideoSimulcastLayers(r.videoSimulcastLayers),this.store.setScreenshareSimulcastLayers(i)}if(null!=n&&n.role&&n.role.name!==e.name){var a=this.store.getPolicyForRole(e.name),s=n.role;n.updateRole(a),this.eventEmitter.emit("local-peer-role-update",{detail:{oldRole:s,newRole:a}})}this.eventEmitter.emit("policy-change",{detail:{params:e}})},e}(),Nt=function(){function e(e,t){this.store=e,this.listener=t}var t=e.prototype;return t.handleRoleChangeRequest=function(e){var t,n={requestedBy:this.store.getPeerById(e.requested_by),role:this.store.getPolicyForRole(e.role),token:e.token};null==(t=this.listener)||t.onRoleChangeRequest(n)},t.handleTrackUpdateRequest=function(e){var t=this,n=e.track_id,r=e.mute,i=this.store.getPeerById(e.requested_by),a=this.store.getLocalPeerTracks().find((function(e){return e.publishedTrackId===n}));if(i&&!i.isLocal&&a){var s=function(){var e;null==(e=t.listener)||e.onChangeTrackStateRequest({requestedBy:i,track:a,enabled:!r})};if(r){if(a.enabled===!r)return;a.setEnabled(!r).then(s)}else s()}},t.handleChangeTrackStateRequest=function(e){var t=this,n=e.type,r=e.source,i=e.value,a=this.store.getPeerById(e.requested_by);if(a){var s=!i,o=this.store.getLocalPeerTracks();n&&(o=o.filter((function(e){return e.type===n}))),r&&(o=o.filter((function(e){return e.source===r})));var c=o.filter((function(e){return e.enabled!==s}));if(0!==c.length)if(s){var u;null==(u=this.listener)||u.onChangeMultiTrackStateRequest({requestedBy:a,tracks:c,type:n,source:r,enabled:!0})}else{for(var d,l=[],h=E(c);!(d=h()).done;)l.push(d.value.setEnabled(!1));Promise.all(l).then((function(){var e;null==(e=t.listener)||e.onChangeMultiTrackStateRequest({requestedBy:a,tracks:c,enabled:!1})}))}}},e}(),Ut=function(){function e(e,t){this.store=e,this.listener=t}var t=e.prototype;return t.onPeerList=function(e){var t,n=e.room,r=n.recording,i=n.streaming,a=this.store.getRoom();a.recording||(a.recording=this.getDefaultRecordingState()),a.rtmp||(a.rtmp={running:!1}),a.recording.server.running=r.sfu.enabled,a.recording.browser.running=r.beam.enabled,a.rtmp.running=i.enabled,null==(t=this.listener)||t.onRoomUpdate(exports.HMSRoomUpdate.RECORDING_STATE_UPDATED,a)},t.onRTMPStart=function(){this.setRTMPStatus(!0)},t.onRTMPStop=function(){this.setRTMPStatus(!1)},t.onRecordingStart=function(e){this.setRecordingStatus(e.type,!0)},t.onRecordingStop=function(e){this.setRecordingStatus(e.type,!1)},t.setRecordingStatus=function(e,t){var n,r=this.store.getRoom();r.recording||(r.recording=this.getDefaultRecordingState());var i=-1;"sfu"===e?(r.recording.server.running=t,i=exports.HMSRoomUpdate.SERVER_RECORDING_STATE_UPDATED):(r.recording.browser.running=t,i=exports.HMSRoomUpdate.BROWSER_RECORDING_STATE_UPDATED),null==(n=this.listener)||n.onRoomUpdate(i,r)},t.setRTMPStatus=function(e){var t,n=this.store.getRoom();n.rtmp||(n.rtmp={running:!1}),n.rtmp.running=e,null==(t=this.listener)||t.onRoomUpdate(exports.HMSRoomUpdate.RTMP_STREAMING_STATE_UPDATED,n)},t.getDefaultRecordingState=function(){return{browser:{running:!1},server:{running:!1}}},e}(),Gt=function(){function e(e,t,n){var r=this;this.store=e,this.eventEmitter=t,this.listener=n,this.tracksToProcess=new Map,this.handleTrackAdd=function(e){w.d(r.TAG,"ONTRACKADD",e,e.nativeTrack),r.store.addTrack(e),r.tracksToProcess.set(e.trackId,e),r.processPendingTracks()},this.handleTrackRemove=function(e){var t;w.d(r.TAG,"ONTRACKREMOVE",e,e.nativeTrack);var n=r.store.getTrackState(e.trackId);if(n){e.type===exports.HMSTrackType.AUDIO&&r.eventEmitter.emit("track-removed",{detail:e});var i=r.store.getPeerById(n.peerId);if(i){var a=function(){var t=i.auxiliaryTracks.indexOf(e);t>-1&&i.auxiliaryTracks.splice(t,1)};switch(e.type){case exports.HMSTrackType.AUDIO:"regular"!==e.source?a():i.audioTrack=void 0;break;case exports.HMSTrackType.VIDEO:"regular"!==e.source?a():i.videoTrack=void 0}r.store.removeTrack(e.trackId),null==(t=r.listener)||t.onTrackUpdate(exports.HMSTrackUpdate.TRACK_REMOVED,e,i)}}},this.handleTrackUpdate=function(e){w.d(r.TAG,"TRACK_UPDATE",e);var t=r.store.getPeerById(e.peer.peer_id);if(t)for(var n in e.tracks){var i,a=Object.assign({},null==(i=r.store.getTrackState(n))?void 0:i.trackInfo),s=e.tracks[n],o=r.store.getTrackById(n);if(r.store.setTrackState({peerId:e.peer.peer_id,trackInfo:l({},a,s)}),!o||r.tracksToProcess.has(n))r.processPendingTracks();else if(o.setEnabled(!s.mute),a.mute!==s.mute){var c,u;s.mute?null==(c=r.listener)||c.onTrackUpdate(exports.HMSTrackUpdate.TRACK_MUTED,o,t):null==(u=r.listener)||u.onTrackUpdate(exports.HMSTrackUpdate.TRACK_UNMUTED,o,t),o.type===exports.HMSTrackType.AUDIO&&r.eventEmitter.emit("track-updated",{detail:{track:o,enabled:!s.mute}})}else if(a.description!==s.description){var d;null==(d=r.listener)||d.onTrackUpdate(exports.HMSTrackUpdate.TRACK_DESCRIPTION_CHANGED,o,t)}}}}var t=e.prototype;return t.handleTrackMetadataAdd=function(e){for(var t in w.d(this.TAG,"TRACK_METADATA_ADD",e),e.tracks)this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:e.tracks[t]});this.processPendingTracks()},t.processPendingTracks=function(){var e=this;new Map(this.tracksToProcess).forEach((function(t){var n,r=e.store.getTrackState(t.trackId);if(r){var i=e.store.getPeerById(r.peerId);if(i){switch(t.source=r.trackInfo.source,t.peerId=i.peerId,t.setEnabled(!r.trackInfo.mute),t.type){case exports.HMSTrackType.AUDIO:i.audioTrack||"regular"!==t.source?i.auxiliaryTracks.push(t):i.audioTrack=t;break;case exports.HMSTrackType.VIDEO:var a=t,s=e.store.getSimulcastDefinitionsForPeer(i,a.source);a.setSimulcastDefinitons(s),i.videoTrack||"regular"!==t.source?i.auxiliaryTracks.push(a):i.videoTrack=a}t.type===exports.HMSTrackType.AUDIO?e.eventEmitter.emit("track-added",{detail:{track:t,peer:i}}):null==(n=e.listener)||n.onTrackUpdate(exports.HMSTrackUpdate.TRACK_ADDED,t,i),e.tracksToProcess.delete(t.trackId)}}}))},d(e,[{key:"TAG",get:function(){return"["+this.constructor.name+"]"}}]),e}(),Ht=function(){function e(e,t,n){var r=this;this.store=e,this.listener=t,this.audioListener=n,this.TAG="[HMSNotificationManager]",this.eventEmitter=new s,this.handleTrackAdd=function(e){r.trackManager.handleTrackAdd(e)},this.handleTrackRemove=function(e){r.trackManager.handleTrackRemove(e)},this.trackManager=new Gt(this.store,this.eventEmitter,this.listener),this.peerManager=new Lt(this.store,this.trackManager,this.listener),this.peerListManager=new _t(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new Dt(this.store,this.listener),this.policyChangeManager=new Ot(this.store,this.eventEmitter),this.requestManager=new Nt(this.store,this.listener),this.activeSpeakerManager=new wt(this.store,this.listener,this.audioListener),this.roomUpdateManager=new Ut(this.store,this.listener)}var t=e.prototype;return t.setListener=function(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e},t.setAudioListener=function(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e},t.addEventListener=function(e,t){this.eventEmitter.addListener(e,t)},t.removeEventListener=function(e,t){this.eventEmitter.removeListener(e,t)},t.once=function(e,t){this.eventEmitter.once(e,t)},t.handleNotification=function(e,t){void 0===t&&(t=!1);var n=e.method,r=e.params;switch(n!==xt.ACTIVE_SPEAKERS&&w.d(this.TAG,"Received notification",{method:n,notification:r}),n){case xt.PEER_JOIN:this.peerManager.handlePeerJoin(r);break;case xt.PEER_LEAVE:this.peerManager.handlePeerLeave(r);break;case xt.PEER_LIST:var i=r;t?(w.d(this.TAG,"RECONNECT_PEER_LIST event",i),this.peerListManager.handleReconnectPeerList(i)):(w.d(this.TAG,"PEER_LIST event",i),this.peerListManager.handleInitialPeerList(i)),this.roomUpdateManager.onPeerList(i);break;case xt.TRACK_METADATA_ADD:this.trackManager.handleTrackMetadataAdd(r);break;case xt.TRACK_UPDATE:this.trackManager.handleTrackUpdate(r);break;case xt.ACTIVE_SPEAKERS:this.activeSpeakerManager.handleActiveSpeakers(r);break;case xt.BROADCAST:this.broadcastManager.handleBroadcast(r);break;case xt.POLICY_CHANGE:this.policyChangeManager.handlePolicyChange(r);break;case xt.ROLE_CHANGE_REQUEST:this.requestManager.handleRoleChangeRequest(r);break;case xt.TRACK_UPDATE_REQUEST:this.requestManager.handleTrackUpdateRequest(r);break;case xt.CHANGE_TRACK_MUTE_STATE_UPDATE:this.requestManager.handleChangeTrackStateRequest(r);break;case xt.PEER_UPDATE:this.peerManager.handlePeerUpdate(r);break;case xt.RTMP_START:this.roomUpdateManager.onRTMPStart();break;case xt.RTMP_STOP:this.roomUpdateManager.onRTMPStop();break;case xt.RECORDING_START:this.roomUpdateManager.onRecordingStart(r);break;case xt.RECORDING_STOP:this.roomUpdateManager.onRecordingStop(r);break;default:return}},e}(),Ft=function(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof de?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)};!function(e){e[e.Disconnected=0]="Disconnected",e[e.Connecting=1]="Connecting",e[e.Joined=2]="Joined",e[e.Failed=3]="Failed",e[e.Reconnecting=4]="Reconnecting",e[e.Leaving=5]="Leaving"}(Rt||(Rt={}));var Bt=function(){function e(){}return e.connect=function(e,t,n,r){var i,a,s;void 0===t&&(t=new Date),void 0===n&&(n=new Date);var o=this.eventNameFor("connect",void 0===e),c=e?Xe.ERROR:Xe.INFO,u=this.getPropertiesWithError(((s={})[this.KEY_REQUESTED_AT]=null==(i=t)?void 0:i.getTime(),s[this.KEY_RESPONDED_AT]=null==(a=n)?void 0:a.getTime(),s.endpoint=r,s),e);return new et({name:o,level:c,properties:u})},e.disconnect=function(e){var t=e?Xe.ERROR:Xe.INFO,n=this.getPropertiesWithError({},e);return new et({name:"disconnected",level:t,properties:n})},e.join=function(e,t,n){var r,i=this.eventNameFor("join",void 0===n),a=n?Xe.ERROR:Xe.INFO,s=this.getPropertiesWithError(((r={})[this.KEY_REQUESTED_AT]=e.getTime(),r[this.KEY_RESPONDED_AT]=t.getTime(),r),n);return new et({name:i,level:a,properties:s})},e.publish=function(e){var t=e.devices,n=e.settings,r=e.error,i=this.eventNameFor("publish",void 0===r),a=r?Xe.ERROR:Xe.INFO,s=this.getPropertiesWithError({devices:t,audio:null==n?void 0:n.audio,video:null==n?void 0:n.video},r);return new et({name:i,level:a,properties:s})},e.subscribeFail=function(e){var t=this.eventNameFor("subscribe",!1),n=Xe.ERROR,r=e.toAnalyticsProperties();return new et({name:t,level:n,properties:r})},e.leave=function(){return new et({name:"leave",level:Xe.INFO})},e.deviceChange=function(e){var t=e.selection,n=e.devices,r=e.error,i=this.eventNameFor(r?"publish":"device."+e.type,void 0===r),a=r?Xe.ERROR:Xe.INFO,s=this.getPropertiesWithError({selection:t,devices:n},r);return new et({name:i,level:a,properties:s})},e.performance=function(e){var t=Xe.INFO,n=e.toAnalyticsProperties();return new et({name:"perf.stats",level:t,properties:n})},e.rtcStats=function(e){var t=Xe.INFO,n=e.toAnalyticsProperties();return new et({name:"rtc.stats",level:t,properties:n})},e.eventNameFor=function(e,t){return e+"."+(t?"success":"failed")},e.getPropertiesWithError=function(e,t){return t&&(e=l({},t.toAnalyticsProperties(),e)),e},e}();Bt.KEY_REQUESTED_AT="requested_at",Bt.KEY_RESPONDED_AT="responded_at";var Vt,Kt,jt=function(e,t,n,r,i,a){this.authToken=e,this.peerId=t,this.peerName=n,this.data=r,this.endpoint=i,this.autoSubscribeVideo=a};!function(e){e[e.ConnectFailed=0]="ConnectFailed",e[e.SignalDisconnect=1]="SignalDisconnect",e[e.PublishIceConnectionFailed=2]="PublishIceConnectionFailed",e[e.SubscribeIceConnectionFailed=3]="SubscribeIceConnectionFailed"}(Kt||(Kt={}));var qt=((Vt={})[Kt.ConnectFailed]=[],Vt[Kt.SignalDisconnect]=[],Vt[Kt.PublishIceConnectionFailed]=[Kt.SignalDisconnect],Vt[Kt.SubscribeIceConnectionFailed]=[Kt.SignalDisconnect],Vt),Wt=function(e){var t=this;this.promise=new Promise((function(n,r){t.resolve=n,t.reject=r,e(n,r)}))},Jt="[RetryScheduler]",Yt=function(){function e(e,t){this.inProgress=new Map,this.retryTaskIds=[],this.analyticsEventsService=e,this.onStateChange=t}var t=e.prototype;return t.schedule=function(){var e=c(S.mark((function e(t,n,r,i,a){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===i&&(i=5),void 0===a&&(a=!0),e.next=4,this.scheduleTask(t,n,a,r,i);case 4:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i,a){return e.apply(this,arguments)}}(),t.reset=function(){this.retryTaskIds.forEach((function(e){return clearTimeout(e)})),this.retryTaskIds=[],this.inProgress.clear()},t.scheduleTask=function(){var e=c(S.mark((function e(t,n,r,i,a,s){var o,c,u,d,l,h,p,f,v;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===a&&(a=5),void 0===s&&(s=0),w.d(Jt,"schedule: ",{category:Kt[t],error:n}),0!==s){e.next=13;break}if(!(o=this.inProgress.get(t))){e.next=10;break}return w.d(Jt,"schedule: Already a task for "+Kt[t]+" scheduled, waiting for its completion"),e.next=9,o.promise;case 9:return e.abrupt("return");case 10:c=new Wt((function(e,t){})),this.inProgress.set(t,c),this.sendEvent(n,t);case 13:u=!1,e.t0=S.keys(d=qt[t]);case 16:if((e.t1=e.t0()).done){e.next=35;break}if(l=d[parseInt(e.t1.value)],e.prev=19,!(h=this.inProgress.get(l))){e.next=26;break}return w.d(Jt,"schedule: Suspending retry task of "+Kt[t]+", waiting for "+Kt[l]+" to recover"),e.next=25,h.promise;case 25:w.d(Jt,"schedule: Resuming retry task "+Kt[t]+" as it's dependency "+Kt[l]+" is recovered");case 26:e.next=33;break;case 28:return e.prev=28,e.t2=e.catch(19),w.d(Jt,"schedule: Stopping retry task of "+Kt[t]+" as it's dependency "+Kt[l]+" failed to recover"),u=!0,e.abrupt("break",35);case 33:e.next=16;break;case 35:if(!(s>=a||u)){e.next=48;break}if(n.description+=". ["+Kt[t]+"] Could not recover after "+s+" tries",u&&(n.description+=" Could not recover all of it's required dependencies - ["+d.map((function(e){return Kt[e]})).toString()+"]"),n.isTerminal=!0,this.inProgress.delete(t),this.sendEvent(n,t),this.reset(),!r){e.next=46;break}this.onStateChange(Rt.Failed,n),e.next=47;break;case 46:throw n;case 47:return e.abrupt("return");case 48:return r&&this.onStateChange(Rt.Reconnecting,n),p=this.getDelayForRetryCount(s),w.i(Jt,"schedule: ["+Kt[t]+"] [failedRetryCount="+s+"] Scheduling retry task in "+p+"ms"),e.prev=51,e.next=54,this.setTimeoutPromise(i,p);case 54:f=e.sent,e.next=61;break;case 57:e.prev=57,e.t3=e.catch(51),f=!1,w.w(Jt,"["+Kt[t]+"] Un-caught exception "+e.t3.name+" in retry-task, initiating retry",e.t3);case 61:if(!f){e.next=69;break}v=this.inProgress.get(t),this.inProgress.delete(t),null==v||v.resolve(s),r&&0===this.inProgress.size&&this.onStateChange(Rt.Joined),w.i(Jt,"schedule: ["+Kt[t]+"] [failedRetryCount="+s+"] Recovered "),e.next=71;break;case 69:return e.next=71,this.scheduleTask(t,n,r,i,a,s+1);case 71:case"end":return e.stop()}}),e,this,[[19,28],[51,57]])})));return function(t,n,r,i,a,s){return e.apply(this,arguments)}}(),t.sendEvent=function(e,t){var n;switch(t){case Kt.ConnectFailed:n=Bt.connect(e);break;case Kt.SignalDisconnect:n=Bt.disconnect(e);break;case Kt.PublishIceConnectionFailed:n=Bt.publish({error:e});break;case Kt.SubscribeIceConnectionFailed:n=Bt.subscribeFail(e)}this.analyticsEventsService.queue(n).flush()},t.getDelayForRetryCount=function(e){var t=Math.pow(2,e),n=Math.random();return Math.round(1e3*Math.min(t+n,60))},t.setTimeoutPromise=function(){var e=c(S.mark((function e(t,n){var r=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,i){var a=window.setTimeout(c(S.mark((function n(){var s;return S.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,t();case 3:(s=n.sent)&&r.retryTaskIds.splice(r.retryTaskIds.indexOf(a),1),e(s),n.next=11;break;case 8:n.prev=8,n.t0=n.catch(0),i(n.t0);case 11:case"end":return n.stop()}}),n,null,[[0,8]])}))),n);r.retryTaskIds.push(a)})));case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),e}(),Qt=function(){function e(){}var t=e.prototype;return t.sendEvent=function(e){try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(e){}},t.flushFailedEvents=function(){try{for(w.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){var e=this.failedEvents.dequeue();e&&this.sendSingleEvent(e)}}catch(e){w.w(this.TAG,"flushFailedEvents failed",e)}},t.sendSingleEvent=function(e){try{w.d(this.TAG,"Sending event",{event:e}),this.transportProvider.sendEvent(e)}catch(t){throw w.w(this.TAG,this.transportProvider.constructor.name+".sendEvent failed, adding to local storage events",{event:e,error:t}),this.failedEvents.enqueue(e),t}},d(e,[{key:"TAG",get:function(){return"["+this.constructor.name+"]"}}]),e}(),zt=function(e){function t(){var t;return(t=e.call(this,100)||this).localStorage=new ct("hms-analytics"),t.localStorage.clear(),t.initLocalStorageQueue(),t}h(t,e);var n=t.prototype;return n.enqueue=function(t){e.prototype.enqueue.call(this,t),this.localStorage.set(this.storage)},n.dequeue=function(){var t=e.prototype.dequeue.call(this);return this.localStorage.set(this.storage),t},n.initLocalStorageQueue=function(){var t,n=this;null==(t=this.localStorage.get())||t.forEach((function(t){var r=new et(t);e.prototype.enqueue.call(n,r)}))},t}(function(){function e(e){void 0===e&&(e=Infinity),this.capacity=e,this.storage=[]}var t=e.prototype;return t.size=function(){return this.storage.length},t.enqueue=function(e){if(this.size()===this.capacity)throw Error("Queue has reached max capacity, cannot add more items");this.storage.push(e)},t.dequeue=function(){return this.storage.shift()},e}()),Zt=function(e){function t(t){var n;return(n=e.call(this)||this).transportProvider=t,n.failedEvents=new zt,n}return h(t,e),t}(Qt),Xt=function(e){function t(t,n){var r;return void 0===n&&(n=1e3),(r=e.call(this)||this).connections=t,r.interval=n,r.isMonitored=!1,r}h(t,e);var n=t.prototype;return n.start=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.stop(),this.isMonitored=!0,w.d("Starting RTCStatsMonitor"),this.startLoop().then((function(){return w.d("Stopping RTCStatsMonitor")}));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),n.stop=function(){this.isMonitored=!1},n.startLoop=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isMonitored){e.next=7;break}return e.next=3,this.handleConnectionsStats();case 3:return e.next=5,ft(this.interval);case 5:e.next=0;break;case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),n.handleConnectionsStats=function(){var e=c(S.mark((function e(){var t,n,r,i,a,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=0,n=0,r=0,i=E(this.connections);case 4:if((a=i()).done){e.next=12;break}return s=a.value,e.next=8,s.getStats();case 8:e.sent.forEach((function(e){e.packetsLost&&(t+=e.packetsLost),e.availableIncomingBitrate&&(n=Number(e.availableIncomingBitrate)),e.availableOutgoingBitrate&&(r=Number(e.availableOutgoingBitrate))}));case 10:e.next=4;break;case 12:this.emit("RTC_STATS_CHANGE",{packetsLost:t,availableIncomingBitrate:n,availableOutgoingBitrate:r});case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t}(Ye),$t=function(e){function t(t){var n;(n=e.call(this)||this).store=t,n.TAG="[TrackDegradationController]",n.MAX_RECOVER_GRACE_PERIOD=120,n.recoverAttemptCount=0,n.packetsLost=0;var r=n.store.getSubscribeDegradationParams();return n.PACKETS_LOST_THRESHOLD=r.packetLossThreshold,n.MIN_DEGRADE_GRACE_PERIOD=r.degradeGracePeriodSeconds,n.MIN_RECOVER_GRACE_PERIOD=r.recoverGracePeriodSeconds,n.degradeGracePeriod=n.MIN_DEGRADE_GRACE_PERIOD,n.recoverGracePeriod=n.MIN_RECOVER_GRACE_PERIOD,n}h(t,e);var n=t.prototype;return n.handleRtcStatsChange=function(e){var t=e.packetsLost>this.packetsLost+this.PACKETS_LOST_THRESHOLD;this.packetsLost=e.packetsLost,t?this.degrade():this.recover()},n.degrade=function(){if(this.degradeGracePeriod>0)this.degradeGracePeriod--;else{if(this.isAttemptingRecover)return this.cancelRecovery();w.d(this.TAG,"Packet loss increased, Degrading",{packetsLost:this.packetsLost}),this.degradeActiveTracksByHalf(),this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD}},n.recover=function(){this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod>0?this.recoverGracePeriod--:(this.recoveringTrack=this.getActiveTracks(!0).find((function(e){return e.degraded})),this.recoveringTrack&&(w.d(this.TAG,"Packet lost stable, recovering track",this.recoveringTrack),this.recoveringTrack.setDegraded(!1),this.emit("TRACK_RESTORED",this.recoveringTrack),this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD))},n.degradeActiveTracksByHalf=function(){var e=this.getActiveTracks(!1);if(e.length){w.d(this.TAG,{activeTracks:[].concat(e)});for(var t=Math.ceil(e.length/2);t--;){var n=e.pop();n.setDegraded(!0),this.emit("TRACK_DEGRADED",n)}}},n.getActiveTracks=function(e){var t=this;return this.store.getRemoteVideoTracks().filter((function(t){return t.hasSinks()&&(!t.degraded||e)})).sort((function(e,n){var r=t.store.getComparator().getTrackComparators();return-1*(r.screenShare(e,n)||r.rolePriority(e,n)||r.peerAudioLevel(e,n)||t.store.getComparator().stringComparator(e.trackId,n.trackId))})).slice(0)},n.cancelRecovery=function(){this.recoveringTrack&&(this.recoveringTrack.setDegraded(!0),this.emit("TRACK_DEGRADED",this.recoveringTrack)),this.recoveringTrack=void 0,this.recoverAttemptCount++,this.recoverGracePeriod=this.getDelayForRecoverCount(this.recoverAttemptCount),this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,w.d(this.TAG,"Recover Attempt Failed",{count:this.recoverAttemptCount,delay:this.recoverGracePeriod})},n.getDelayForRecoverCount=function(e){return Math.min(this.MIN_RECOVER_GRACE_PERIOD+this.MIN_RECOVER_GRACE_PERIOD*e,this.MAX_RECOVER_GRACE_PERIOD)},d(t,[{key:"isAttemptingRecover",get:function(){return Boolean(this.recoveringTrack)}}]),t}(Ye),en="[HMSTransport]:",tn=function(){function e(e,t,n){var r,i,a,s,o,u,d,l,h,p=this;this.observer=e,this.deviceManager=t,this.store=n,this.state=Rt.Disconnected,this.trackStates=new Map,this.publishConnection=null,this.subscribeConnection=null,this.retryScheduler=new Yt(rt,function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t===p.state){e.next=4;break}return p.state=t,e.next=4,p.observer.onStateChange(p.state,n);case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()),this.callbacks=new Map,this.signalObserver={onOffer:(s=c(S.mark((function e(t){var n,r,i,a,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,p.subscribeConnection.setRemoteDescription(t);case 3:w.d(en,"[SUBSCRIBE] Adding "+p.subscribeConnection.candidates.length+" ice-candidates",p.subscribeConnection.candidates),n=E(p.subscribeConnection.candidates);case 5:if((r=n()).done){e.next=11;break}return i=r.value,e.next=9,p.subscribeConnection.addIceCandidate(i);case 9:e.next=5;break;case 11:return p.subscribeConnection.candidates.length=0,e.next=14,p.subscribeConnection.createAnswer();case 14:return a=e.sent,e.next=17,p.subscribeConnection.setLocalDescription(a);case 17:p.signal.answer(a),w.d(en,"[role=SUBSCRIBE] onOffer renegotiation DONE "),e.next=28;break;case 21:throw e.prev=21,e.t0=e.catch(0),w.d(en,"[role=SUBSCRIBE] onOffer renegotiation FAILED "),p.state=Rt.Failed,s=e.t0 instanceof R?e.t0:Y(A.PUBLISH,e.t0.message),rt.queue(Bt.subscribeFail(s)).flush(),s;case 28:case"end":return e.stop()}}),e,null,[[0,21]])}))),function(e){return s.apply(this,arguments)}),onTrickle:(a=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==(n=t.target===x.Publish?p.publishConnection:p.subscribeConnection).remoteDescription){e.next=5;break}n.candidates.push(t.candidate),e.next=7;break;case 5:return e.next=7,n.addIceCandidate(t.candidate);case 7:case"end":return e.stop()}}),e)}))),function(e){return a.apply(this,arguments)}),onNotification:function(e){return p.observer.onNotification(e)},onServerError:(i=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.leave();case 2:return e.next=4,p.observer.onStateChange(Rt.Failed,t);case 4:case"end":return e.stop()}}),e)}))),function(e){return i.apply(this,arguments)}),onFailure:function(e){p.joinParameters&&p.retryScheduler.schedule(Kt.SignalDisconnect,e,p.retrySignalDisconnectTask)},onOffline:(r=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:w.d(en,"socket offline",Rt[p.state]);try{p.state!==Rt.Leaving&&p.joinParameters&&p.retryScheduler.schedule(Kt.SignalDisconnect,(void 0===(t="Network offline")&&(t=""),new R(1003,"WebSocketConnectionLost",A.RECONNECT_SIGNAL,"Network connection lost ",t)),p.retrySignalDisconnectTask)}catch(e){console.error(e)}case 2:case"end":return e.stop()}var t}),e)}))),function(){return r.apply(this,arguments)}),onOnline:function(){w.d(en,"socket online",Rt[p.state]),p.analyticsSignalTransport.flushFailedEvents()}},this.signal=new Me(this.signalObserver),this.analyticsSignalTransport=new Zt(this.signal),this.publishConnectionObserver={onRenegotiationNeeded:(d=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.performPublishRenegotiation();case 2:case"end":return e.stop()}}),e)}))),function(){return d.apply(this,arguments)}),onIceConnectionChange:(u=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:w.d("publisher ice connection state change, ",t);case 2:case"end":return e.stop()}}),e)}))),function(e){return u.apply(this,arguments)}),onConnectionStateChange:(o=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(w.d("publisher connection state change, ",t),"failed"!==t){e.next=4;break}return e.next=4,p.handleIceConnectionFailure(x.Publish);case 4:case"end":return e.stop()}}),e)}))),function(e){return o.apply(this,arguments)})},this.subscribeConnectionObserver={onApiChannelMessage:function(e){p.observer.onNotification(JSON.parse(e))},onTrackAdd:function(e){w.d(en,"[Subscribe] onTrackAdd",e),p.observer.onTrackAdd(e)},onTrackRemove:function(e){w.d(en,"[Subscribe] onTrackRemove",e),p.observer.onTrackRemove(e)},onIceConnectionChange:(h=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:w.d("subscriber ice connection state change, ",t),"connected"===t&&(n=p.callbacks.get("SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID"),p.callbacks.delete("SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID"),n&&n.promise.resolve(!0));case 3:case"end":return e.stop()}}),e)}))),function(e){return h.apply(this,arguments)}),onConnectionStateChange:(l=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(w.d("subscriber connection state change, ",t),"failed"!==t){e.next=4;break}return e.next=4,p.handleIceConnectionFailure(x.Subscribe);case 4:"connected"===t&&(n=p.callbacks.get("SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID"),p.callbacks.delete("SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID"),n&&n.promise.resolve(!0));case 5:case"end":return e.stop()}}),e)}))),function(e){return l.apply(this,arguments)})},this.retryPublishIceFailedTask=c(S.mark((function e(){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("connected"===p.publishConnection.iceConnectionState&&"connected"===p.publishConnection.connectionState){e.next=6;break}return t=new Promise((function(e,t){p.callbacks.set("renegotiation-callback-id",{promise:{resolve:e,reject:t},action:A.RESTART_ICE,extra:{}})})),e.next=4,p.performPublishRenegotiation({iceRestart:!0});case 4:return e.next=6,t;case 6:return e.abrupt("return",!0);case 7:case"end":return e.stop()}}),e)}))),this.retrySubscribeIceFailedTask=c(S.mark((function e(){var t,n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("connected"===p.subscribeConnection.iceConnectionState&&"connected"===p.subscribeConnection.connectionState){e.next=4;break}return t=new Promise((function(e,t){p.callbacks.set("SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID",{promise:{resolve:e,reject:t},action:A.RESTART_ICE,extra:{}})})),n=new Promise((function(e){setTimeout(e,6e4,!1)})),e.abrupt("return",Promise.race([t,n]));case 4:return e.abrupt("return",!0);case 5:case"end":return e.stop()}}),e)}))),this.retrySignalDisconnectTask=c(S.mark((function e(){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=p.signal.isConnected,w.d(en,"retrySignalDisconnectTask",{signalConnected:p.signal.isConnected}),p.signal.isConnected){e.next=12;break}return e.prev=3,e.next=6,p.internalConnect(p.joinParameters.authToken,p.joinParameters.endpoint,p.joinParameters.peerId);case 6:t=!0,e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),t=!1;case 12:if(e.t1=p.signal.isConnected,!e.t1){e.next=17;break}return e.next=16,p.retryPublishIceFailedTask();case 16:e.t1=e.sent;case 17:return t=e.t1,p.signal.trackUpdate(p.trackStates),e.abrupt("return",t);case 20:case"end":return e.stop()}}),e,null,[[3,9]])})))}var t=e.prototype;return t.getLocalScreen=function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,St.getLocalScreen(t,n);case 3:return e.abrupt("return",e.sent);case 6:throw e.prev=6,e.t0=e.catch(0),e.t0 instanceof R&&rt.queue(Bt.publish({error:e.t0,devices:this.deviceManager.getDevices(),settings:new Ue(t,n,!1)})).flush(),e.t0;case 10:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t,n){return e.apply(this,arguments)}}(),t.getLocalTracks=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,St.getLocalTracks(t);case 3:return e.abrupt("return",e.sent);case 6:throw e.prev=6,e.t0=e.catch(0),e.t0 instanceof R&&rt.queue(Bt.publish({devices:this.deviceManager.getDevices(),error:e.t0,settings:t})).flush(),e.t0;case 10:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t){return e.apply(this,arguments)}}(),t.getEmptyLocalTracks=function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t={audio:!0,video:!0}),e.prev=1,e.next=4,St.getEmptyLocalTracks(t,n);case 4:return e.abrupt("return",e.sent);case 8:throw e.prev=8,e.t0=e.catch(1),e.t0 instanceof R&&rt.queue(Bt.publish({devices:this.deviceManager.getDevices(),error:e.t0,settings:n})).flush(),e.t0;case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,n){return e.apply(this,arguments)}}(),t.join=function(){var e=c(S.mark((function e(t,n,r,i,a){var s,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===i&&(i="https://prod-init.100ms.live/init"),void 0===a&&(a=!1),this.state===Rt.Failed&&(this.state=Rt.Disconnected),this.state===Rt.Disconnected||this.state===Rt.Reconnecting){e.next=5;break}throw void 0===(c="Cannot join a meeting in "+this.state)&&(c=""),new R(5001,"AlreadyJoined",A.JOIN,"[JOIN]: You have already joined this room.",c);case 5:if(this.state===Rt.Disconnected&&(this.state=Rt.Connecting,this.observer.onStateChange(this.state)),this.joinParameters=new jt(t,n,r.name,r.metaData,i,a),w.d(en,"join: started "),s=new Date,e.prev=9,this.signal.isConnected&&this.initConfig){e.next=13;break}return e.next=13,this.connect(t,i,n);case 13:if(!this.initConfig){e.next=16;break}return e.next=16,this.connectionJoin(r.name,r.metaData,this.initConfig.rtcConfiguration,a);case 16:e.next=28;break;case 18:return e.prev=18,e.t0=e.catch(9),w.e(en,"join: failed  [token="+t+"]",e.t0),this.state=Rt.Failed,e.t0 instanceof R&&rt.queue(Bt.join(s,new Date,e.t0)).flush(),(o=e.t0).isTerminal=500===o.code,e.next=27,this.observer.onStateChange(this.state,o);case 27:throw o;case 28:w.d(en," join: successful"),this.state=Rt.Joined,this.observer.onStateChange(this.state);case 31:case"end":return e.stop()}var c}),e,this,[[9,18]])})));return function(t,n,r,i,a){return e.apply(this,arguments)}}(),t.connect=function(){var e=c(S.mark((function e(t,n,r){var i,a=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.internalConnect(t,n,r);case 3:return e.abrupt("return",e.sent);case 6:if(e.prev=6,e.t0=e.catch(0),!(e.t0 instanceof R&&([P.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,P.InitAPIErrors.ENDPOINT_UNREACHABLE,P.InitAPIErrors.CONNECTION_LOST,P.InitAPIErrors.HTTP_ERROR].includes(e.t0.code)||e.t0.code.toString().startsWith("5")||e.t0.code.toString().startsWith("429")))){e.next=15;break}return i=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.internalConnect(t,n,r);case 2:return e.abrupt("return",Boolean(a.initConfig&&a.initConfig.endpoint));case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.next=13,this.retryScheduler.schedule(Kt.ConnectFailed,e.t0,i,5,!1);case 13:e.next=16;break;case 15:throw e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(t,n,r){return e.apply(this,arguments)}}(),t.leave=function(){var e=c(S.mark((function e(){var t,n,r,i,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return rt.removeTransport(this.analyticsSignalTransport),this.retryScheduler.reset(),this.joinParameters=void 0,e.prev=3,this.state=Rt.Leaving,null==(t=this.subscribeConnStatsMonitor)||t.stop(),null==(n=this.subscribeConnStatsMonitor)||n.removeAllListeners(),null==(r=this.trackDegradationController)||r.removeAllListeners(),e.next=10,null==(i=this.publishConnection)?void 0:i.close();case 10:return e.next=12,null==(a=this.subscribeConnection)?void 0:a.close();case 12:if(!this.signal.isConnected){e.next=16;break}return this.signal.leave(),e.next=16,this.signal.close();case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(3),e.t0 instanceof R&&rt.queue(Bt.disconnect(e.t0)).flush(),w.e(en,"leave: FAILED ",e.t0);case 22:return e.prev=22,this.state=Rt.Disconnected,this.observer.onStateChange(this.state),e.finish(22);case 26:case"end":return e.stop()}}),e,this,[[3,18,22,26]])})));return function(){return e.apply(this,arguments)}}(),t.publish=function(){var e=c(S.mark((function e(t){var n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=E(t);case 1:if((r=n()).done){e.next=13;break}return i=r.value,e.prev=3,e.next=6,this.publishTrack(i);case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),e.t0 instanceof R&&rt.queue(Bt.publish({devices:this.deviceManager.getDevices(),error:e.t0})).flush();case 11:e.next=1;break;case 13:case"end":return e.stop()}}),e,this,[[3,8]])})));return function(t){return e.apply(this,arguments)}}(),t.unpublish=function(){var e=c(S.mark((function e(t){var n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=E(t);case 1:if((r=n()).done){e.next=7;break}return i=r.value,e.next=5,this.unpublishTrack(i);case 5:e.next=1;break;case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.sendMessage=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.signal.broadcast(t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.trackUpdate=function(e){var t=Array.from(this.trackStates.values()).find((function(t){return e.type===t.type&&e.source===t.source}));if(t){var n=new Ft(l({},t,{mute:!e.enabled}));this.trackStates.set(t.track_id,n),w.d(en,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[t.track_id,n]]))}},t.changeRole=function(){var e=c(S.mark((function e(t,n,r){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===r&&(r=!1),e.next=3,this.signal.requestRoleChange({requested_for:t.peerId,role:n,force:r});case 3:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}(),t.acceptRoleChange=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.signal.acceptRoleChangeRequest({role:t.role.name,token:t.token});case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.endRoom=function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.signal.endRoom(t,n);case 2:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.removePeer=function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.signal.removePeer({requested_for:t,reason:n});case 2:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.startRTMPOrRecording=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(n=t.rtmpURLs)||!n.length){e.next=5;break}return e.next=3,this.signal.startRTMPOrRecording({meeting_url:t.meetingURL,record:t.record,rtmp_urls:t.rtmpURLs});case 3:e.next=7;break;case 5:return e.next=7,this.signal.startRTMPOrRecording({meeting_url:t.meetingURL,record:t.record});case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.stopRTMPOrRecording=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.signal.stopRTMPAndRecording();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.changeTrackState=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.signal.requestTrackStateChange(t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.changeMultiTrackState=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.signal.requestMultiTrackStateChange(t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.publishTrack=function(){var e=c(S.mark((function e(t){var n,r,i,a,s=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.publishedTrackId=t.nativeTrack.id,w.d(en," publishTrack: trackId="+t.trackId+", toPublishTrackId="+t.publishedTrackId,t),this.trackStates.set(t.publishedTrackId,new Ft(t)),n=new Promise((function(e,t){s.callbacks.set("renegotiation-callback-id",{promise:{resolve:e,reject:t},action:A.PUBLISH,extra:{}})})),(r=t.stream).setConnection(this.publishConnection),i=this.store.getSimulcastLayers(t.source),r.addTransceiver(t,i),w.time("publish-"+t.trackId+"-"+t.type),e.next=11,n;case 11:if(w.timeEnd("publish-"+t.trackId+"-"+t.type),this.store.addTrack(t),!(a=t.settings.maxBitrate)){e.next=17;break}return e.next=17,r.setMaxBitrate(a,t).then((function(){w.i(en,"Setting maxBitrate for "+t.source+" "+t.type+" to "+a+" kpbs")})).catch((function(e){return w.e(en,"Failed setting maxBitrate",e)}));case 17:w.d(en," publishTrack: trackId="+t.trackId,t,this.callbacks);case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.unpublishTrack=function(){var e=c(S.mark((function e(t){var n,r,i,a=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w.d(en," unpublishTrack: trackId="+t.trackId,t),this.trackStates.has(t.publishedTrackId)?this.trackStates.delete(t.publishedTrackId):(n=Array.from(this.trackStates.values()),(r=n.find((function(e){return t.type===e.type&&t.source===e.source})))&&this.trackStates.delete(r.track_id)),i=new Promise((function(e,t){a.callbacks.set("renegotiation-callback-id",{promise:{resolve:e,reject:t},action:A.UNPUBLISH,extra:{}})})),t.stream.removeSender(t),e.next=7,i;case 7:return e.next=9,t.cleanup();case 9:this.store.removeTrack(t.trackId),w.d(en," unpublishTrack: trackId="+t.trackId,this.callbacks);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.connectionJoin=function(){var e=c(S.mark((function e(t,n,r,i,a){var s,o,c,u,d;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===a&&(a={offerToReceiveAudio:!1,offerToReceiveVideo:!1}),this.publishConnection=new ne(this.signal,r,this.publishConnectionObserver,this),this.subscribeConnection=new ve(this.signal,r,this.subscribeConnectionObserver),e.prev=3,w.d(en," join: Negotiating over PUBLISH connection"),e.next=7,this.publishConnection.createOffer(a,new Map);case 7:return s=e.sent,e.next=10,this.publishConnection.setLocalDescription(s);case 10:return e.next=12,this.signal.join(t,n,s,!i);case 12:return o=e.sent,e.next=15,this.publishConnection.setRemoteDescription(o);case 15:c=E(this.publishConnection.candidates||[]);case 16:if((u=c()).done){e.next=22;break}return d=u.value,e.next=20,this.publishConnection.addIceCandidate(d);case 20:e.next=16;break;case 22:return this.publishConnection.initAfterJoin(),e.next=25,this.initRtcStatsMonitor();case 25:w.d(en," join: Negotiated over PUBLISH connection"),e.next=32;break;case 28:throw e.prev=28,e.t0=e.catch(3),this.state=Rt.Failed,e.t0;case 32:case"end":return e.stop()}}),e,this,[[3,28]])})));return function(t,n,r,i,a){return e.apply(this,arguments)}}(),t.performPublishRenegotiation=function(){var e=c(S.mark((function e(t){var n,r,i,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w.d(en," [role=PUBLISH] onRenegotiationNeeded START",this.trackStates),n=this.callbacks.get("renegotiation-callback-id"),this.callbacks.delete("renegotiation-callback-id"),e.prev=3,e.next=6,this.publishConnection.createOffer(t,this.trackStates);case 6:return r=e.sent,e.next=9,this.publishConnection.setLocalDescription(r);case 9:return w.time("renegotiation-offer-exchange"),e.next=12,this.signal.offer(r,this.trackStates);case 12:return i=e.sent,w.timeEnd("renegotiation-offer-exchange"),e.next=16,this.publishConnection.setRemoteDescription(i);case 16:n.promise.resolve(!0),w.d(en,"[role=PUBLISH] onRenegotiationNeeded DONE "),e.next=25;break;case 20:e.prev=20,e.t0=e.catch(3),a=e.t0 instanceof R?e.t0:Y(A.PUBLISH,e.t0.message),n.promise.reject(a),w.d(en,"[role=PUBLISH] onRenegotiationNeeded FAILED ");case 25:case"end":return e.stop()}}),e,this,[[3,20]])})));return function(t){return e.apply(this,arguments)}}(),t.handleIceConnectionFailure=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t===x.Publish?this.retryScheduler.schedule(Kt.PublishIceConnectionFailed,q(A.PUBLISH),this.retryPublishIceFailedTask):this.retryScheduler.schedule(Kt.SubscribeIceConnectionFailed,q(A.SUBSCRIBE),this.retrySubscribeIceFailedTask,1);case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.internalConnect=function(){var e=c(S.mark((function e(t,n,r){var i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w.d(en,"connect: started "),i=new Date,e.prev=2,e.next=5,we.fetchInitConfig(t,n);case 5:return this.initConfig=e.sent,e.next=8,this.openSignal(t,r);case 8:w.d(en,"Adding Analytics Transport: JsonRpcSignal"),rt.addTransport(this.analyticsSignalTransport),rt.flush(),e.next=18;break;case 13:throw e.prev=13,e.t0=e.catch(2),rt.queue(Bt.connect(e.t0,i,new Date,n)).flush(),w.d(en," internal connect: failed",e.t0),e.t0;case 18:case"end":return e.stop()}}),e,this,[[2,13]])})));return function(t,n,r){return e.apply(this,arguments)}}(),t.openSignal=function(){var e=c(S.mark((function e(t,n){var r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.initConfig){e.next=2;break}throw O(A.INIT,"Init Config not found");case 2:return w.d(en," internal connect: connecting to ws endpoint",this.initConfig.endpoint),(r=new URL(this.initConfig.endpoint)).searchParams.set("peer",n),r.searchParams.set("token",t),r.searchParams.set("user_agent",be),this.endpoint=r.toString(),e.next=10,this.signal.open(this.endpoint);case 10:w.d(en," internal connect: connected to ws endpoint");case 11:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.initRtcStatsMonitor=function(){var e=c(S.mark((function e(){var t=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.store.getSubscribeDegradationParams()){e.next=8;break}return this.subscribeConnStatsMonitor=new Xt([this.subscribeConnection]),this.trackDegradationController=new $t(this.store),this.subscribeConnStatsMonitor.on("RTC_STATS_CHANGE",(function(e){var n;return null==(n=t.trackDegradationController)?void 0:n.handleRtcStatsChange(e)})),this.trackDegradationController.on("TRACK_DEGRADED",this.observer.onTrackDegrade),this.trackDegradationController.on("TRACK_RESTORED",this.observer.onTrackRestore),e.next=8,this.subscribeConnStatsMonitor.start();case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e}();function nn(e){if(0===e.length)throw G(A.INIT,"Token cannot be an empty string");var t=e.split(".");if(3!==t.length)throw G(A.INIT,"Expected 3 '.' separate fields - header, payload and signature respectively");var n=atob(t[1]);try{var r=JSON.parse(n);return{roomId:r.room_id,userId:r.user_id,role:r.role}}catch(e){throw G(A.INIT,e.message)}}var rn,an=function(){function e(e,t,n){this.id=e,this.name=t,this.store=n}return d(e,[{key:"localPeer",get:function(){return this.store.getLocalPeer()}},{key:"peers",get:function(){return this.store.getPeers()}}]),e}(),sn={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},on=function(){function e(e,t,n){var r=this;this.store=e,this.notificationManager=t,this.deviceManager=n,this.autoPausedTracks=new Set,this.TAG="[AudioSinkManager]:",this.volume=100,this.eventEmitter=new a.EventEmitter,this.state=l({},sn),this.handleAudioPaused=function(e){var t,n=null==(t=e.target.srcObject)?void 0:t.getAudioTracks()[0];if(null!=n&&n.enabled){w.d(r.TAG,"Audio Paused",e.target.id);var i=r.store.getTrackById(e.target.id);i&&(ye()?setTimeout(c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i){e.next=3;break}return e.next=3,r.playAudioFor(i);case 3:case"end":return e.stop()}}),e)}))),500):r.autoPausedTracks.add(i))}},this.handleTrackUpdate=function(e){var t;if(null!=(t=window.HMS)&&t.AUDIO_SINK){var n=e.detail,i=n.track;n.enabled?(i.addSink(),r.playAudioFor(i)):i.removeSink()}},this.handleTrackAdd=function(e){r.handleTrackAddAsync(e)},this.handleTrackAddAsync=function(){var e=c(S.mark((function e(t){var n,i,a,s,o,c,u,d;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=(s=t.detail).track,c=s.peer,(u=document.createElement("audio")).style.display="none",u.id=o.trackId,u.addEventListener("pause",r.handleAudioPaused),o.setAudioElement(u),o.setVolume(r.volume),w.d(r.TAG,"Audio track added",o.trackId),null==(n=r.audioSink)||n.append(u),e.t0=r.outputDevice,!e.t0){e.next=13;break}return e.next=13,o.setOutputDevice(r.outputDevice);case 13:if(null==(i=window.HMS)||!i.AUDIO_SINK){e.next=21;break}if(o.enabled){e.next=18;break}return o.removeSink(),null==(d=r.listener)||d.onTrackUpdate(exports.HMSTrackUpdate.TRACK_ADDED,o,c),e.abrupt("return");case 18:o.addSink(),e.next=22;break;case 21:u.srcObject=new MediaStream([o.nativeTrack]);case 22:if(null==(a=r.listener)||a.onTrackUpdate(exports.HMSTrackUpdate.TRACK_ADDED,o,c),void 0!==r.state.autoplayFailed){e.next=27;break}return r.state.autoplayCheckPromise||(r.state.autoplayCheckPromise=new Promise((function(e){r.playAudioFor(o).then(e)}))),e.next=27,r.state.autoplayCheckPromise;case 27:if(!r.state.autoplayFailed){e.next=30;break}return r.autoPausedTracks.add(o),e.abrupt("return");case 30:return e.next=32,r.playAudioFor(o);case 32:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.handleAudioDeviceChange=function(e){!e.error&&e.selection&&r.unpauseAudioTracks()},this.handleTrackRemove=function(e){var t=e.detail;r.autoPausedTracks.delete(t);var n=document.getElementById(t.trackId);n&&(n.removeEventListener("pause",r.handleAudioPaused),n.srcObject=null,n.remove(),t.setAudioElement(null)),r.audioSink&&0===r.audioSink.childElementCount&&(r.state.autoplayCheckPromise=void 0,r.state.autoplayFailed=void 0),w.d(r.TAG,"Audio track removed",t.trackId)},this.unpauseAudioTracks=c(S.mark((function e(){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],r.autoPausedTracks.forEach((function(e){t.push(r.playAudioFor(e))})),e.next=4,Promise.all(t);case 4:case"end":return e.stop()}}),e)}))),this.notificationManager.addEventListener("track-added",this.handleTrackAdd),this.notificationManager.addEventListener("track-removed",this.handleTrackRemove),this.notificationManager.addEventListener("track-updated",this.handleTrackUpdate),this.deviceManager.addEventListener("audio-device-change",this.handleAudioDeviceChange),this.audioContext=new AudioContext}var t=e.prototype;return t.setListener=function(e){this.listener=e},t.addEventListener=function(e,t){this.eventEmitter.addListener(e,t)},t.removeEventListener=function(e,t){this.eventEmitter.removeListener(e,t)},t.getVolume=function(){return this.volume},t.setVolume=function(e){this.store.updateAudioOutputVolume(e),this.volume=e},t.unblockAutoplay=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.autoPausedTracks.size>0&&this.unpauseAudioTracks();case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.init=function(e){if(!this.state.initialized){this.state.initialized=!0;var t=document.createElement("div");t.id="HMS-SDK-audio-sink-"+i.v4(),(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t}},t.cleanUp=function(){var e,t;null==(e=this.audioSink)||e.remove(),this.audioSink=void 0,null==(t=this.audioContext)||t.close(),this.audioContext=void 0,this.notificationManager.removeEventListener("track-added",this.handleTrackAdd),this.notificationManager.removeEventListener("track-removed",this.handleTrackRemove),this.notificationManager.removeEventListener("track-updated",this.handleTrackUpdate),this.deviceManager.removeEventListener("audio-device-change",this.handleAudioDeviceChange),this.autoPausedTracks=new Set,this.state=l({},sn)},t.playAudioFor=function(){var e=c(S.mark((function e(t){var n,r,i,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.getAudioElement()){e.next=4;break}return w.w(this.TAG,"No audio element found on track",t.trackId),e.abrupt("return");case 4:return e.prev=4,"suspended"===(null==(r=this.audioContext)?void 0:r.state)&&(null==(i=this.audioContext)||i.resume()),e.next=8,n.play();case 8:this.state.autoplayFailed=!1,this.autoPausedTracks.delete(t),w.d(this.TAG,"Played track",t.trackId),e.next=18;break;case 13:e.prev=13,e.t0=e.catch(4),this.autoPausedTracks.add(t),w.e(this.TAG,"Failed to play track",t.trackId,e.t0),this.state.autoplayFailed||(this.state.autoplayFailed=!0,void 0===(s="")&&(s=""),a=new R(P.TracksErrors.AUTOPLAY_ERROR,"AutoplayBlocked",A.AUTOPLAY,"Autoplay blocked because the user didn't interact with the document first",s),this.eventEmitter.emit("autoplay-error",{error:a}));case 18:case"end":return e.stop()}var s}),e,this,[[4,13]])})));return function(t){return e.apply(this,arguments)}}(),d(e,[{key:"outputDevice",get:function(){return this.deviceManager.outputDevice}}]),e}(),cn=function(){function e(e){var t,n,r,i=this;this.store=e,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.hasWebcamPermission=!1,this.hasMicrophonePermission=!1,this.eventEmitter=new s,this.TAG="[Device Manager]:",this.initialized=!1,this.videoInputChanged=!1,this.audioInputChanged=!1,this.updateOutputDevice=function(e){var t=i.audioOutput.find((function(t){return t.deviceId===e}));return t&&(i.outputDevice=t,i.store.updateAudioOutputDevice(t),ut.updateSelection("audioOutput",{deviceId:t.deviceId,groupId:t.groupId})),t},this.getCurrentSelection=function(){var e,t,n=i.store.getLocalPeer(),r=i.createIdentifier(null==n||null==(e=n.audioTrack)?void 0:e.getMediaTrackSettings()),a=i.createIdentifier(null==n||null==(t=n.videoTrack)?void 0:t.getMediaTrackSettings());return{audioInput:i.audioInput.find((function(e){return i.createIdentifier(e)===r})),videoInput:i.videoInput.find((function(e){return i.createIdentifier(e)===a})),audioOutput:i.outputDevice}},this.computeChange=function(e,t){return e.length!==t.length||t.some((function(t){return!e.includes(i.createIdentifier(t))}))},this.enumerateDevices=c(S.mark((function e(){var t,n,r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.enumerateDevices();case 3:t=e.sent,n=i.videoInput.map(i.createIdentifier),r=i.audioInput.map(i.createIdentifier),i.audioInput=[],i.audioOutput=[],i.videoInput=[],t.forEach((function(e){"audioinput"===e.kind&&e.label?(i.hasMicrophonePermission=!0,i.audioInput.push(e)):"audiooutput"===e.kind?i.audioOutput.push(e):"videoinput"===e.kind&&e.label&&(i.hasWebcamPermission=!0,i.videoInput.push(e))})),i.videoInputChanged=i.computeChange(n,i.videoInput),i.audioInputChanged=i.computeChange(r,i.audioInput),ut.setDevices({videoInput:[].concat(i.videoInput),audioInput:[].concat(i.audioInput),audioOutput:[].concat(i.audioOutput)}),i.logDevices("Enumerate Devices"),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(0),w.e(i.TAG,"Failed enumerating devices",e.t0);case 19:case"end":return e.stop()}}),e,null,[[0,16]])}))),this.handleDeviceChange=(t=c(S.mark((function e(){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.enumerateDevices();case 2:return rt.queue(Bt.deviceChange({selection:i.getCurrentSelection(),type:"list",devices:i.getDevices()})).flush(),i.logDevices("After Device Change"),t=i.store.getLocalPeer(),i.setOutputDevice(!0),e.next=8,i.handleAudioInputDeviceChange(null==t?void 0:t.audioTrack);case 8:return e.next=10,i.handleVideoInputDeviceChange(null==t?void 0:t.videoTrack);case 10:case"end":return e.stop()}}),e)}))),n=500,void 0===n&&(n=300),function(){for(var e=arguments.length,i=new Array(e),a=0;a<e;a++)i[a]=arguments[a];clearTimeout(r),r=void 0;var s=this;r=setTimeout((function(){t.apply(s,i)}),n)}).bind(this),this.handleAudioInputDeviceChange=function(){var e=c(S.mark((function e(t){var n,r,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return w.d(i.TAG,"No Audio track on local peer"),e.abrupt("return");case 3:if(i.audioInputChanged){e.next=6;break}return w.d(i.TAG,"No Change in AudioInput Device"),e.abrupt("return");case 6:if((n=i.getNewAudioInputDevice())&&n.deviceId){e.next=10;break}return w.w(i.TAG,"Audio device not found"),e.abrupt("return");case 10:return r=t.settings,a=(new De).codec(r.codec).maxBitrate(r.maxBitrate).deviceId(n.deviceId).build(),e.prev=12,e.next=15,t.setSettings(a,!0);case 15:i.eventEmitter.emit("audio-device-change",{devices:i.getDevices(),selection:n,type:"audioInput"}),i.logDevices("Audio Device Change Success"),e.next=24;break;case 19:e.prev=19,e.t0=e.catch(12),w.e(i.TAG,"[Audio Device Change]",e.t0),rt.queue(Bt.deviceChange({selection:{audioInput:n},devices:i.getDevices(),error:e.t0})).flush(),i.eventEmitter.emit("audio-device-change",{error:e.t0,selection:n,type:"audioInput",devices:i.getDevices()});case 24:case"end":return e.stop()}}),e,null,[[12,19]])})));return function(t){return e.apply(this,arguments)}}(),this.handleVideoInputDeviceChange=function(){var e=c(S.mark((function e(t){var n,r,a,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return w.d(i.TAG,"No Audio track on local peer"),e.abrupt("return");case 3:if(i.videoInputChanged){e.next=6;break}return w.d(i.TAG,"No Change in VideoInput Device"),e.abrupt("return");case 6:if((n=i.videoInput[0])&&n.deviceId){e.next=10;break}return w.w(i.TAG,"Video device not found"),e.abrupt("return");case 10:return r=t.settings,a=t.enabled,s=(new Le).codec(r.codec).maxBitrate(r.maxBitrate).maxFramerate(r.maxFramerate).setWidth(r.width).setHeight(r.height).deviceId(n.deviceId).build(),e.prev=12,e.next=15,t.setSettings(s,!0);case 15:a||t.setEnabled(a),i.eventEmitter.emit("video-device-change",{devices:i.getDevices(),selection:n,type:"video"}),i.logDevices("Video Device Change Success"),e.next=25;break;case 20:e.prev=20,e.t0=e.catch(12),w.e(i.TAG,"[Video Device Change]",e.t0),rt.queue(Bt.deviceChange({selection:{videoInput:n},devices:i.getDevices(),error:e.t0})).flush(),i.eventEmitter.emit("video-device-change",{error:e.t0,type:"video",selection:n,devices:i.getDevices()});case 25:case"end":return e.stop()}}),e,null,[[12,20]])})));return function(t){return e.apply(this,arguments)}}()}var t=e.prototype;return t.init=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.initialized){e.next=2;break}return e.abrupt("return");case 2:return this.initialized=!0,navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),e.next=6,this.enumerateDevices();case 6:this.logDevices("Init"),this.setOutputDevice(),this.eventEmitter.emit("audio-device-change",{devices:this.getDevices()}),rt.queue(Bt.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})).flush();case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getDevices=function(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}},t.cleanUp=function(){this.initialized=!1,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)},t.createIdentifier=function(e){return e?""+e.deviceId+e.groupId:""},t.getNewAudioInputDevice=function(){var e=this.audioInput.find((function(e){return"default"===e.deviceId}));return e?this.audioInput.find((function(t){return t.label!==e.label&&e.label.includes(t.label)})):this.audioInput[0]},t.setOutputDevice=function(e){void 0===e&&(e=!1);var t=this.getNewAudioInputDevice(),n=this.createIdentifier(this.outputDevice);this.outputDevice=void 0,null!=t&&t.groupId&&(this.outputDevice=this.audioOutput.find((function(e){return"default"!==t.deviceId&&e.label===t.label}))),this.outputDevice||(this.outputDevice=this.audioOutput.find((function(e){return"default"===e.deviceId}))||this.audioOutput[0]),this.store.updateAudioOutputDevice(this.outputDevice),e&&n!==this.createIdentifier(this.outputDevice)&&this.eventEmitter.emit("audio-device-change",{selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()})},t.addEventListener=function(e,t){this.eventEmitter.addListener(e,t)},t.removeEventListener=function(e,t){this.eventEmitter.removeListener(e,t)},t.logDevices=function(e){void 0===e&&(e=""),w.d(this.TAG,e,JSON.stringify({videoInput:[].concat(this.videoInput),audioInput:[].concat(this.audioInput),audioOutput:[].concat(this.audioOutput),selected:this.getCurrentSelection()},null,4))},e}(),un=function(){function e(e,t){this.deviceManager=e,this.audioSinkManager=t}var t=e.prototype;return t.getVolume=function(){return this.audioSinkManager.getVolume()},t.setVolume=function(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)},t.getDevice=function(){return this.deviceManager.outputDevice},t.setDevice=function(e){return this.deviceManager.updateOutputDevice(e)},t.unblockAutoplay=function(){var e=c(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.audioSinkManager.unblockAutoplay();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e}(),dn=function(){function e(e){this.store=e,this.primitiveComparator=function(e,t){return e===t?0:Number(e)-Number(t)},this.stringComparator=function(e,t){return e===t?0:e<t?-1:1}}var t=e.prototype;return t.getPeerComparators=function(){var e=this;return{videoEnabled:function(t,n){var r,i;return e.primitiveComparator(Boolean(null==(r=t.videoTrack)?void 0:r.enabled),Boolean(null==(i=n.videoTrack)?void 0:i.enabled))},audioEnabled:function(t,n){var r,i;return e.primitiveComparator(Boolean(null==(r=t.audioTrack)?void 0:r.enabled),Boolean(null==(i=n.audioTrack)?void 0:i.enabled))},screenShare:function(t,n){return e.primitiveComparator(t.auxiliaryTracks.some((function(e){return"screen"===e.source})),n.auxiliaryTracks.some((function(e){return"screen"===e.source})))},audioLevel:function(t,n){var r,i;return e.primitiveComparator((null==(r=e.store.getSpeakers().find((function(e){return e.peer.peerId===(null==t?void 0:t.peerId)})))?void 0:r.audioLevel)||-1,(null==(i=e.store.getSpeakers().find((function(e){return e.peer.peerId===(null==n?void 0:n.peerId)})))?void 0:i.audioLevel)||-1)},rolePriority:function(t,n){var r,i;return e.primitiveComparator((null==(r=t.role)?void 0:r.priority)||0,(null==(i=n.role)?void 0:i.priority)||0)}}},t.getTrackComparators=function(){var e=this;return{video:function(t,n){return e.primitiveComparator(t.type===exports.HMSTrackType.VIDEO,n.type===exports.HMSTrackType.VIDEO)},audio:function(t,n){return e.primitiveComparator(t.type===exports.HMSTrackType.AUDIO,n.type===exports.HMSTrackType.AUDIO)},enabled:function(t,n){return e.primitiveComparator(Boolean(t.enabled),Boolean(n.enabled))},peerAudioLevel:function(t,n){var r=e.store.getPeerByTrackId(t.trackId),i=e.store.getPeerByTrackId(n.trackId);return e.getPeerComparators().audioLevel(r,i)},audioLevel:function(t,n){var r,i;return e.primitiveComparator((null==(r=e.store.getSpeakers().find((function(e){return e.track.trackId===t.trackId})))?void 0:r.audioLevel)||0,(null==(i=e.store.getSpeakers().find((function(e){return e.track.trackId===n.trackId})))?void 0:i.audioLevel)||0)},screenShare:function(t,n){return e.primitiveComparator("screen"===t.source,"screen"===n.source)},rolePriority:function(t,n){var r,i,a,s;return e.primitiveComparator((null==(r=e.store.getPeerByTrackId(t.trackId))||null==(i=r.role)?void 0:i.priority)||0,(null==(a=e.store.getPeerByTrackId(n.trackId))||null==(s=a.role)?void 0:s.priority)||0)}}},e}(),ln=function(){function e(){this.comparator=new dn(this),this.knownRoles={},this.peers={},this.tracks={},this.peerTrackStates={},this.speakers=[],this.videoLayers=null,this.screenshareLayers=null}var t=e.prototype;return t.getConfig=function(){return this.config},t.getPublishParams=function(){return this.publishParams},t.getComparator=function(){return this.comparator},t.getRoom=function(){return this.room},t.getPolicyForRole=function(e){return this.knownRoles[e]},t.getKnownRoles=function(){return this.knownRoles},t.getLocalPeer=function(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]},t.getRemotePeers=function(){return Object.values(this.peers).filter((function(e){return!e.isLocal}))},t.getPeers=function(){return Object.values(this.peers)},t.getPeerById=function(e){if(this.peers[e])return this.peers[e]},t.getTracks=function(){return Object.values(this.tracks)},t.getVideoTracks=function(){return this.getTracks().filter((function(e){return e.type===exports.HMSTrackType.VIDEO}))},t.getRemoteVideoTracks=function(){return this.getTracks().filter((function(e){return e instanceof fe}))},t.getAudioTracks=function(){return this.getTracks().filter((function(e){return e.type===exports.HMSTrackType.AUDIO}))},t.getPeerTracks=function(e){var t=e?this.peers[e]:void 0,n=[];return(null==t?void 0:t.videoTrack)&&n.push(t.videoTrack),(null==t?void 0:t.audioTrack)&&n.push(t.audioTrack),n.concat((null==t?void 0:t.auxiliaryTracks)||[])},t.getLocalPeerTracks=function(){return this.getPeerTracks(this.localPeerId)},t.getTrackById=function(e){return this.tracks[e]},t.getPeerByTrackId=function(e){var t=this.tracks[e];return t.peerId?this.peers[t.peerId]:void 0},t.getSpeakers=function(){return this.speakers},t.getSpeakerPeers=function(){return this.speakers.map((function(e){return e.peer}))},t.setRoom=function(e){this.room=e},t.setKnownRoles=function(e){this.knownRoles=e,this.updatePeersPolicy()},t.setConfig=function(e){if(ut.rememberDevices(Boolean(e.rememberDeviceSelection)),e.rememberDeviceSelection){var t,n,r,i=ut.getSelection();i&&(e.settings||(e.settings={}),null!=(t=i.audioInput)&&t.deviceId&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||i.audioInput.deviceId),null!=(n=i.audioOutput)&&n.deviceId&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||i.audioOutput.deviceId),null!=(r=i.videoInput)&&r.deviceId&&(e.settings.videoDeviceId=e.settings.videoDeviceId||i.videoInput.deviceId))}this.config=e},t.setPublishParams=function(e){this.publishParams=e},t.addPeer=function(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)},t.addTrack=function(e){this.tracks[e.trackId]=e},t.getTrackState=function(e){return this.peerTrackStates[e]},t.setTrackState=function(e){this.peerTrackStates[e.trackInfo.track_id]=e},t.removePeer=function(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]},t.removeTrack=function(e){delete this.tracks[e]},t.updateSpeakers=function(e){this.speakers=e},t.updateAudioOutputVolume=function(e){this.getAudioTracks().forEach((function(t){return t.setVolume(e)}))},t.updateAudioOutputDevice=function(e){this.getAudioTracks().forEach((function(t){t.setOutputDevice(e)}))},t.getSubscribeDegradationParams=function(){var e,t,n=null==(e=this.getLocalPeer())||null==(t=e.role)?void 0:t.subscribeParams.subscribeDegradation;if(n&&Object.keys(n).length>0)return n},t.getSimulcastLayers=function(e){var t,n;return"screen"===e?(null==(n=this.screenshareLayers)?void 0:n.layers)||[]:(null==(t=this.videoLayers)?void 0:t.layers)||[]},t.getSimulcastDimensions=function(e){var t="screen"===e?this.screenshareLayers:this.videoLayers;return{width:null==t?void 0:t.width,height:null==t?void 0:t.height}},t.convertSimulcastLayers=function(e){return l({},e,{layers:(e.layers||[]).map((function(e){return l({},e,{maxBitrate:1e3*e.maxBitrate})}))})},t.setVideoSimulcastLayers=function(e){this.videoLayers=this.convertSimulcastLayers(e)},t.setScreenshareSimulcastLayers=function(e){this.screenshareLayers=this.convertSimulcastLayers(e)},t.getSimulcastDefinitionsForPeer=function(e,t){if(!e.role)return[];var n,r=this.getPolicyForRole(e.role.name).publishParams;if("regular"===t?n=r.videoSimulcastLayers:"screen"===t&&(n=r.screenSimulcastLayers),!n||!n.layers||0===n.layers.length)return[];var i=n.width,a=n.height;return n.layers.map((function(e){return{layer:se[e.rid],resolution:{width:i&&e.scaleResolutionDownBy?i/e.scaleResolutionDownBy:void 0,height:a&&e.scaleResolutionDownBy?a/e.scaleResolutionDownBy:void 0}}}))},t.cleanUp=function(){for(var e,t=E(this.getTracks());!(e=t()).done;)e.value.cleanup();this.config=void 0},t.setErrorListener=function(e){this.errorListener=e},t.updatePeersPolicy=function(){var e=this;this.getPeers().forEach((function(t){var n;t.role?t.role=e.getPolicyForRole(t.role.name):null==(n=e.errorListener)||n.onError(new R(P.GenericErrors.INVALID_ROLE,"InvalidRole",A.VALIDATION,"Invalid role. Join with valid role","",!0))}))},e}(),hn=function(){function e(e,t,n,r,i){var a=this;this.store=e,this.transport=t,this.publish=n,this.removeAuxillaryTrack=r,this.listener=i,this.handleLocalPeerRoleUpdate=function(){var e=c(S.mark((function e(t){var n,r,i,s,o,c,u,d;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=a.store.getLocalPeer()){e.next=3;break}return e.abrupt("return");case 3:return c=(s=t.detail.newRole).publishParams.allowed||[],u={removeVideo:!1,removeAudio:!1,removeScreen:!1},(o=t.detail.oldRole.publishParams.allowed||[]).length>0&&(0===c.length?(u.removeVideo=!0,u.removeAudio=!0,u.removeScreen=!0):(o.includes("video")&&!c.includes("video")&&(u.removeVideo=!0),o.includes("audio")&&!c.includes("audio")&&(u.removeAudio=!0),o.includes("screen")&&!c.includes("screen")&&(u.removeScreen=!0))),e.next=11,a.removeLocalTracks(u);case 11:return a.store.setPublishParams(s.publishParams),d=(null==(n=a.store.getConfig())?void 0:n.settings)||{isAudioMuted:!0,isVideoMuted:!0,audioInputDeviceId:"default",videoDeviceId:"default",audioOutputDeviceId:"default"},e.next=15,a.publish(l({},d,{isAudioMuted:!0,isVideoMuted:!0}));case 15:null==(r=a.listener)||r.onPeerUpdate(exports.HMSPeerUpdate.ROLE_UPDATED,i);case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}return e.prototype.removeLocalTracks=function(){var e=c(S.mark((function e(t){var n,r,i,a,s,o,c,u,d,l,h,p,f;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.removeVideo,r=t.removeAudio,i=t.removeScreen,a=this.store.getLocalPeer()){e.next=4;break}return e.abrupt("return");case 4:return s=[],null!=a&&a.videoTrack&&n&&(s.push(a.videoTrack),a.videoTrack=void 0),null!=a&&a.audioTrack&&r&&(s.push(a.audioTrack),a.audioTrack=void 0),e.next=9,this.transport.unpublish(s);case 9:for(o=0,c=s;o<c.length;o++)d=c[o],null==(u=this.listener)||u.onTrackUpdate(exports.HMSTrackUpdate.TRACK_REMOVED,d,a);if(!a.auxiliaryTracks||!i){e.next=20;break}l=[].concat(a.auxiliaryTracks),h=E(l);case 13:if((p=h()).done){e.next=20;break}if("screen"!==(f=p.value).source){e.next=18;break}return e.next=18,this.removeAuxillaryTrack(f.trackId);case 18:e.next=13;break;case 20:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),e}(),pn=function(){function e(e,t,n){this.store=e,this.observer=t,this.deviceManager=n,this.TAG="[LocalTrackManager]"}var t=e.prototype;return t.getTracksToPublish=function(){var e=c(S.mark((function e(t){var n,r,i,a,s,o,c,u,d,l,h,p,f,v,g,m,k;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.store.getPublishParams()){e.next=3;break}return e.abrupt("return",[]);case 3:if(r=n.allowed,i=Boolean(r&&r.includes("audio")),a=Boolean(r&&r.includes("video")),i||a){e.next=8;break}return e.abrupt("return",[]);case 8:if(s=[],o=this.getTrackSettings(t,n)){e.next=12;break}return e.abrupt("return",[]);case 12:if(c=this.store.getLocalPeerTracks(),u=c.find((function(e){return e.type===exports.HMSTrackType.VIDEO&&"regular"===e.source})),d=c.find((function(e){return e.type===exports.HMSTrackType.AUDIO&&"regular"===e.source})),l=c.find((function(e){return e.type===exports.HMSTrackType.VIDEO&&"screen"===e.source})),h=Boolean(u&&this.store.getTrackById(u.trackId)),p=Boolean(d&&this.store.getTrackById(d.trackId)),!u||!o.video){e.next=21;break}return e.next=21,u.setSettings(o.video);case 21:if(!d||!o.audio){e.next=24;break}return e.next=24,d.setSettings(o.audio);case 24:if(l&&o.screen&&l.setSettings(o.screen),!h||!p){e.next=27;break}return e.abrupt("return",[]);case 27:return f={audio:i&&!d&&(!t.isAudioMuted||"empty"),video:a&&!u&&(!t.isVideoMuted||"empty")},e.prev=28,w.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:f}),e.next=32,this.getLocalTracks(f,o);case 32:s=e.sent,e.next=69;break;case 35:if(e.prev=35,e.t0=e.catch(28),!(e.t0 instanceof R&&e.t0.action===A.TRACK)){e.next=67;break}return this.observer.onFailure(e.t0),v=e.t0.message.includes("audio"),g=e.t0.message.includes("video"),f.audio=v?"empty":f.audio,f.video=g?"empty":f.video,w.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:f},e.t0),e.prev=44,e.t1=(m=s).push,e.t2=m,e.next=49,this.getLocalTracks(f,o);case 49:e.t3=e.sent,e.t1.apply.call(e.t1,e.t2,e.t3),e.next=65;break;case 53:return e.prev=53,e.t4=e.catch(44),w.w(this.TAG,"Fetch empty tacks failed",e.t4),f.audio=f.audio&&"empty",f.video=f.video&&"empty",e.t5=(k=s).push,e.t6=k,e.next=62,this.getLocalTracks(f,o);case 62:e.t7=e.sent,e.t5.apply.call(e.t5,e.t6,e.t7),this.observer.onFailure(H(A.TRACK,e.t4.message));case 65:e.next=69;break;case 67:w.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e.t0),this.observer.onFailure(H(A.TRACK,e.t0.message));case 69:return u&&a&&!h&&s.push(u),d&&i&&!p&&s.push(d),e.abrupt("return",s);case 72:case"end":return e.stop()}}),e,this,[[28,35],[44,53]])})));return function(t){return e.apply(this,arguments)}}(),t.getLocalTracks=function(){var e=c(S.mark((function e(t,n){var r,i,a,s,o,c,u;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t={audio:!0,video:!0}),e.prev=1,e.next=4,this.getNativeLocalTracks(t,n);case 4:return i=(r=e.sent).find((function(e){return"video"===e.kind})),a=r.find((function(e){return"audio"===e.kind})),s=new St(new MediaStream(r)),o=[],a&&null!=n&&n.audio&&(c=new pt(s,a,"regular",n.audio),o.push(c)),i&&null!=n&&n.video&&(u=new yt(s,i,"regular",n.video),o.push(u)),e.abrupt("return",o);case 14:throw e.prev=14,e.t0=e.catch(1),e.t0 instanceof R&&rt.queue(Bt.publish({devices:this.deviceManager.getDevices(),error:e.t0,settings:n})).flush(),e.t0;case 18:case"end":return e.stop()}}),e,this,[[1,14]])})));return function(t,n){return e.apply(this,arguments)}}(),t.getNativeLocalTracks=function(){var e=c(S.mark((function e(t,n){var r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t={audio:!1,video:!1}),r=new Ue(!0===t.video?n.video:null,!0===t.audio?n.audio:null,n.simulcast),i=[],!r.audio&&!r.video){e.next=10;break}return e.t0=i.push,e.t1=i,e.next=8,this.getAVTracks(r);case 8:e.t2=e.sent,e.t0.apply.call(e.t0,e.t1,e.t2);case 10:return"empty"===t.audio&&i.push(this.getEmptyAudioTrack()),"empty"===t.video&&i.push(this.getEmptyVideoTrack()),e.abrupt("return",i);case 13:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.getEmptyVideoTrack=function(e){var t,n,r,i=(null==e||null==(t=e.getSettings())?void 0:t.width)||320,a=(null==e||null==(n=e.getSettings())?void 0:n.height)||240;rn||null==(r=(rn=Object.assign(document.createElement("canvas"),{width:i,height:a})).getContext("2d"))||r.fillRect(0,0,i,a);var s=rn.captureStream(10).getVideoTracks()[0],o=setInterval((function(){if("ended"!==s.readyState){var e=rn.getContext("2d");if(e){var t=e.getImageData(0,0,1,1).data;e.fillStyle="rgb("+(0===t[0]?1:0)+", 0, 0)",e.fillRect(0,0,1,1)}}else clearInterval(o)}),100);return s.onended=function(){clearInterval(o)},s.enabled=!1,s},t.getEmptyAudioTrack=function(){var e=new AudioContext,t=e.createOscillator(),n=t.connect(e.createMediaStreamDestination());t.start();var r=n.stream.getAudioTracks()[0];return r.enabled=!1,r},t.getAVTracks=function(){var e=c(S.mark((function e(t){var n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getUserMedia({audio:!!t.audio&&t.audio.toConstraints(),video:!!t.video&&t.video.toConstraints()});case 3:return e.abrupt("return",(n=e.sent).getVideoTracks().concat(n.getAudioTracks()));case 7:return e.prev=7,e.t0=e.catch(0),r=!1,i=!1,e.next=13,this.deviceManager.init();case 13:if(!this.deviceManager.hasWebcamPermission&&t.video&&(r=!0),!this.deviceManager.hasMicrophonePermission&&t.audio&&(i=!0),!r||!i){e.next=19;break}throw Ge(e.t0,Re.AV);case 19:if(!r){e.next=23;break}throw Ge(e.t0,Re.VIDEO);case 23:throw Ge(e.t0,Re.AUDIO);case 24:case"end":return e.stop()}}),e,this,[[0,7]])})));return function(t){return e.apply(this,arguments)}}(),t.getTrackSettings=function(e,t){var n=t.audio,r=t.video,i=t.screen,a=t.allowed,s=Boolean(a&&a.includes("audio")),o=Boolean(a&&a.includes("video")),c=Boolean(a&&a.includes("screen"));if(!s&&!o)return null;var u=e.audioInputDeviceId,d=e.videoDeviceId,l=null,h=null,p=null;if(s&&(l=(new De).codec(n.codec).maxBitrate(n.bitRate).deviceId(u||"default").build()),o){var f=this.store.getSimulcastDimensions("regular");h=(new Le).codec(r.codec).maxBitrate(r.bitRate).maxFramerate(r.frameRate).setWidth((null==f?void 0:f.width)||r.width).setHeight((null==f?void 0:f.height)||r.height).deviceId(d||"default").build()}if(c){var v=this.store.getSimulcastDimensions("screen");p=(new Le).maxBitrate(i.bitRate,!1).codec(i.codec).maxFramerate(i.frameRate).setWidth((null==v?void 0:v.width)||i.width).setHeight((null==v?void 0:v.height)||i.height).build()}return(new Ne).video(h).audio(l).screen(p).build()},e}(),fn=function(){function e(e){this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}var t=e.prototype;return t.resumeContext=function(){"suspended"===this.audioContext.state&&(w.d(this.TAG,"AudioContext is resumed"),this.audioContext.resume())},t.getAudioTrack=function(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]},t.cleanup=function(){"closed"!==this.audioContext.state&&this.audioContext.close()},d(e,[{key:"TAG",get:function(){return"AudioContextManager"}}]),e}(),vn=function(e){function t(){var t;return(t=e.call(this)||this).seeked=!1,t.audioElement=t.getAudioElement(),t}h(t,e);var n=t.prototype;return n.play=function(){var e=c(S.mark((function e(t){var n=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){n.audioElement=n.getAudioElement(),n.audioElement.src=t,n.seeked=!1,n.audioElement.onerror=function(){var e="Error loading "+t;w.e(n.TAG,e),n.stop(),r(e)},n.audioElement.oncanplaythrough=c(S.mark((function i(){var a;return S.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(i.prev=0,n.audioElement){i.next=3;break}return i.abrupt("return");case 3:if(n.audioContextManager.resumeContext(),n.track){i.next=12;break}return i.next=7,n.audioElement.play();case 7:a=n.audioContextManager.getAudioTrack(),n.track=a,e([a]),i.next=19;break;case 12:if(n.seeked){i.next=18;break}return i.next=15,n.audioElement.play();case 15:e([n.track]),i.next=19;break;case 18:n.seeked=!1;case 19:i.next=25;break;case 21:i.prev=21,i.t0=i.catch(0),w.e(n.TAG,"Error playing audio",t,i.t0.message),r(i.t0);case 25:case"end":return i.stop()}}),i,null,[[0,21]])}))),n.audioElement.onseeked=function(){n.seeked=!0}})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),n.getTracks=function(){return this.track?[this.track.id]:[]},n.getElement=function(){return this.audioElement},n.stop=function(){var e,t;null==(e=this.audioElement)||e.pause(),null==(t=this.audioElement)||t.removeAttribute("src"),this.audioElement=null,this.audioContextManager.cleanup(),this.track=void 0},n.getAudioElement=function(){var e=this;if(this.audioElement)return this.audioElement;var t=document.createElement("audio");return t.crossOrigin="anonymous",t.addEventListener("timeupdate",(function(t){return e.emit("progress",t)})),t.addEventListener("ended",(function(){e.emit("ended",null)})),this.audioContextManager=new fn(t),t},d(t,[{key:"TAG",get:function(){return"PlaylistAudioManager"}}]),t}(Ye),gn=function(e){function t(){var t;return(t=e.call(this)||this).tracks=[],t.DEFAUL_FPS=24,t.seeked=!1,t.drawImage=function(){var e,n,r;!t.videoElement||t.videoElement.paused||t.videoElement.ended||(null==(e=t.canvasContext)||e.drawImage(t.videoElement,0,0,null==(n=t.canvas)?void 0:n.width,null==(r=t.canvas)?void 0:r.height),t.timer=setTimeout((function(){t.drawImage()}),1e3/t.DEFAUL_FPS))},t.videoElement=t.getVideoElement(),t.canvas=document.createElement("canvas"),t.canvasContext=t.canvas.getContext("2d"),t}h(t,e);var n=t.prototype;return n.play=function(e){var t=this;return new Promise((function(n,r){t.videoElement=t.getVideoElement(),t.videoElement.src=e,t.seeked=!1,t.videoElement.onerror=function(){var n="Error loading "+e;w.e(t.TAG,n),t.stop(),r(n)},t.videoElement.oncanplaythrough=c(S.mark((function i(){var a,s,o,c,u;return S.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(i.prev=0,t.videoElement){i.next=3;break}return i.abrupt("return");case 3:if(t.canvas.width=t.videoElement.videoWidth,t.canvas.height=t.videoElement.videoHeight,0!==t.tracks.length){i.next=21;break}if(t.clearCanvasAndTracks(),a=t.canvas.captureStream()){i.next=11;break}return w.e(t.TAG,"Browser does not support captureStream"),i.abrupt("return");case 11:return t.videoElement.onplay=t.drawImage,t.audioContextManager.resumeContext(),i.next=15,t.videoElement.play();case 15:s=t.audioContextManager.getAudioTrack(),a.addTrack(s),a.getTracks().forEach((function(e){t.tracks.push(e)})),n(t.tracks),i.next=29;break;case 21:if(t.seeked){i.next=27;break}return i.next=24,t.videoElement.play();case 24:n(t.tracks),i.next=29;break;case 27:t.seeked=!1,null==(o=t.canvasContext)||o.drawImage(t.videoElement,0,0,null==(c=t.canvas)?void 0:c.width,null==(u=t.canvas)?void 0:u.height);case 29:i.next=35;break;case 31:i.prev=31,i.t0=i.catch(0),w.e(t.TAG,"Error playing video",e,i.t0.message),r(i.t0);case 35:case"end":return i.stop()}}),i,null,[[0,31]])}))),t.videoElement.onseeked=function(){t.seeked=!0}}))},n.getTracks=function(){return this.tracks.map((function(e){return e.id}))},n.getElement=function(){return this.videoElement},n.stop=function(){var e,t;null==(e=this.videoElement)||e.pause(),null==(t=this.videoElement)||t.removeAttribute("src"),this.videoElement=null,this.clearCanvasAndTracks()},n.clearCanvasAndTracks=function(){var e;this.tracks=[],null==(e=this.canvasContext)||e.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)},n.getVideoElement=function(){var e=this;if(this.videoElement)return this.videoElement;var t=document.createElement("video");return t.crossOrigin="anonymous",t.addEventListener("timeupdate",(function(t){return e.emit("progress",t)})),t.addEventListener("ended",(function(){e.emit("ended",null)})),this.audioContextManager=new fn(t),t},d(t,[{key:"TAG",get:function(){return"PlaylistVideoManager"}}]),t}(Ye),mn={list:[],currentIndex:-1},kn={list:[],currentIndex:-1},Tn=function(e){function t(t){var n;return(n=e.call(this)||this).sdk=t,n.state={audio:l({},mn),video:l({},kn)},n.addTrack=function(){var e=c(S.mark((function e(t,r){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.sdk.addTrack(t,r);case 2:w.d(n.TAG,"Playlist track added",t);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),n.removeTrack=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.sdk.removeTrack(t);case 2:w.d(n.TAG,"Playlist track removed",t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),n.audioManager=new vn,n.videoManager=new gn,n.addListeners(),n}h(t,e);var n=t.prototype;return n.getList=function(e){return void 0===e&&(e=exports.HMSPlaylistType.audio),this.state[e].list},n.setList=function(e){var t=this;e&&0!==e.length?e.forEach((function(e){t.state[e.type].list.push(e)})):w.w(this.TAG,"Please pass in a list of HMSPlaylistItem's")},n.removeItem=function(e){var t=this.state[e.type].list,n=t.findIndex((function(t){return e.id===t.id}));n>-1&&t.splice(n,1)},n.seek=function(e,t){if(void 0===t&&(t=exports.HMSPlaylistType.audio),-1===this.state[t].currentIndex)throw $(A.PLAYLIST,"No item is currently playing");var n=this.getElement(t);if(n){var r=Math.max(n.currentTime+e,0);n.currentTime=Math.min(r,n.duration)}},n.seekTo=function(e,t){if(void 0===t&&(t=exports.HMSPlaylistType.audio),-1===this.state[t].currentIndex)throw $(A.PLAYLIST,"No item is currently playing");if(e<0)throw Error("value cannot be negative");var n=this.getElement(t);n&&(n.currentTime=Math.min(e,n.duration))},n.setVolume=function(e,t){if(void 0===t&&(t=exports.HMSPlaylistType.audio),e<0||e>100)throw Error("Please pass a valid number between 0-100");var n=this.getElement(t);n?n.volume=.01*e:w.w(this.TAG,"No valid element of type "+t+" found")},n.getVolume=function(e){void 0===e&&(e=exports.HMSPlaylistType.audio);var t=this.getElement(e);return t?100*t.volume:(w.w(this.TAG,"No valid element of type "+e+" found"),0)},n.getCurrentTime=function(e){void 0===e&&(e=exports.HMSPlaylistType.audio);var t=this.getElement(e);return(null==t?void 0:t.currentTime)||0},n.getCurrentIndex=function(e){return void 0===e&&(e=exports.HMSPlaylistType.audio),this.state[e].currentIndex},n.getCurrentProgress=function(e){var t;void 0===e&&(e=exports.HMSPlaylistType.audio);var n=this.state[e],r=null==(t=n.list[n.currentIndex])?void 0:t.url,i=this.getElement(e);return r&&i?Math.floor(i.currentTime/i.duration*100):0},n.getCurrentSelection=function(e){void 0===e&&(e=exports.HMSPlaylistType.audio);var t=this.state[e],n=t.currentIndex;if(-1!==n)return t.list[n]},n.isPlaying=function(e){void 0===e&&(e=exports.HMSPlaylistType.audio);var t=this.getElement(e);return!!t&&!t.paused},n.setEnabled=function(){var e=c(S.mark((function e(t,n){var r,i,a,s,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.id,a=void 0===(i=n.type)?exports.HMSPlaylistType.audio:i,s=this.state[a].list.findIndex((function(e){return e.id===r})),r&&-1!==s){e.next=6;break}return w.w(this.TAG,"Pass a valid id"),e.abrupt("return");case 6:if(o=this.state[a].list[s].url,!t){e.next=12;break}return e.next=10,this.play(o,a);case 10:e.next=14;break;case 12:return e.next=14,this.pause(o,a);case 14:this.state[a].currentIndex=s,this.setDuration(a);case 16:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.playNext=function(){var e=c(S.mark((function e(t){var n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=exports.HMSPlaylistType.audio),!((i=(n=this.state[t]).currentIndex)>=(r=n.list).length-1)){e.next=4;break}throw $(A.PLAYLIST,"Reached end of playlist");case 4:return e.next=6,this.play(r[i+1].url,t);case 6:this.state[t].currentIndex=i+1,this.setDuration(t);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.playPrevious=function(){var e=c(S.mark((function e(t){var n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=exports.HMSPlaylistType.audio),r=(n=this.state[t]).list,!((i=n.currentIndex)<=0)){e.next=4;break}throw $(A.PLAYLIST,"Reached start of playlist");case 4:return e.next=6,this.play(r[i-1].url,t);case 6:this.state[t].currentIndex=i-1,this.setDuration(t);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.stop=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t=exports.HMSPlaylistType.audio),n=t===exports.HMSPlaylistType.audio?this.audioManager:this.videoManager,e.next=4,this.removeTracks(t);case 4:n.stop(),this.state[t].currentIndex=-1;case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.cleanup=function(){this.state={audio:l({},mn),video:l({},kn)},this.audioManager.stop(),this.videoManager.stop()},n.onProgress=function(e){var t=this;this.videoManager.on("progress",(function(){try{e({type:exports.HMSPlaylistType.video,progress:t.getCurrentProgress(exports.HMSPlaylistType.video)})}catch(e){w.e(t.TAG,"Error in onProgress callback")}})),this.audioManager.on("progress",(function(){try{e({type:exports.HMSPlaylistType.audio,progress:t.getCurrentProgress(exports.HMSPlaylistType.audio)})}catch(e){w.e(t.TAG,"Error in onProgress callback")}}))},n.onNewTrackStart=function(e){this.on("newTrackStart",e)},n.onPlaylistEnded=function(e){this.on("playlistEnded",e)},n.getElement=function(e){return void 0===e&&(e=exports.HMSPlaylistType.audio),e===exports.HMSPlaylistType.audio?this.audioManager.getElement():this.videoManager.getElement()},n.removeTracks=function(){var e=c(S.mark((function e(t){var n,r,i,a,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===t&&(t=exports.HMSPlaylistType.audio),n=t===exports.HMSPlaylistType.audio?this.audioManager:this.videoManager,r=n.getTracks(),i=E(r);case 4:if((a=i()).done){e.next=10;break}return s=a.value,e.next=8,this.removeTrack(s);case 8:e.next=4;break;case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),n.play=function(){var e=c(S.mark((function e(t,n){var r,i,a,s,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n=exports.HMSPlaylistType.audio),!(r=this.getElement(n))||r.paused||!r.src.includes(t)){e.next=5;break}return w.w(this.TAG,"The "+n+" is currently playing"),e.abrupt("return");case 5:if(!r||!r.src.includes(t)){e.next=10;break}return e.next=8,r.play();case 8:e.next=27;break;case 10:if(null==r||r.pause(),n!==exports.HMSPlaylistType.audio){e.next=17;break}return e.next=14,this.audioManager.play(t);case 14:i=e.sent,e.next=20;break;case 17:return e.next=19,this.videoManager.play(t);case 19:i=e.sent;case 20:a=E(i);case 21:if((s=a()).done){e.next=27;break}return o=s.value,e.next=25,this.addTrack(o,n===exports.HMSPlaylistType.audio?"audioplaylist":"videoplaylist");case 25:e.next=21;break;case 27:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.setDuration=function(e){void 0===e&&(e=exports.HMSPlaylistType.audio);var t=this.getElement(e),n=this.state[e],r=n.list,i=n.currentIndex;r[i]&&(r[i].duration=(null==t?void 0:t.duration)||0),this.emit("newTrackStart",r[i])},n.pause=function(){var e=c(S.mark((function e(t,n){var r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===n&&(n=exports.HMSPlaylistType.audio),(r=this.getElement(n))&&!r.paused&&r.src.includes(t)?(r.pause(),w.d(this.TAG,"paused url",t)):w.w(this.TAG,"The passed in url is not currently playing");case 3:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),n.addListeners=function(){var e=this;this.audioManager.on("ended",(function(){return e.handleEnded(exports.HMSPlaylistType.audio)})),this.videoManager.on("ended",(function(){return e.handleEnded(exports.HMSPlaylistType.video)}))},n.handleEnded=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t=exports.HMSPlaylistType.audio),(n=this.state[t]).currentIndex!==n.list.length-1){e.next=8;break}return e.next=5,this.stop(t);case 5:this.emit("playlistEnded",t),e.next=9;break;case 8:this.playNext(t);case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d(t,[{key:"TAG",get:function(){return"PlaylistManager"}}]),t}(Ye),En={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},xn={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,deviceManagersInitialised:!1},yn=function(){function e(){var e,t=this;this.TAG="[HMSSdk]:",this.transportState=Rt.Disconnected,this.sdkState=l({},xn),this.handleAutoplayError=function(e){var n;null==(n=t.errorListener)||null==n.onError||n.onError(e.error)},this.observer={onNotification:function(e){e.method!==xt.PEER_LEAVE_REQUEST?t.notificationManager.handleNotification(e,t.sdkState.isReconnecting):t.handlePeerLeaveRequest(e.params)},onTrackAdd:function(e){t.notificationManager.handleTrackAdd(e)},onTrackRemove:function(e){t.notificationManager.handleTrackRemove(e)},onTrackDegrade:function(e){var n,r;w.d(t.TAG,"Sending Track Update Track Degraded",e),null==(n=t.listener)||n.onTrackUpdate(exports.HMSTrackUpdate.TRACK_DEGRADED,e,null==(r=t.store)?void 0:r.getPeerByTrackId(e.trackId))},onTrackRestore:function(e){var n,r;w.d(t.TAG,"Sending Track Update Track Restored",e),null==(n=t.listener)||n.onTrackUpdate(exports.HMSTrackUpdate.TRACK_RESTORED,e,null==(r=t.store)?void 0:r.getPeerByTrackId(e.trackId))},onFailure:function(e){var n;null==(n=t.errorListener)||n.onError(e)},onStateChange:(e=c(S.mark((function e(n,r){var i,a,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=n,e.next=e.t0===Rt.Joined?3:e.t0===Rt.Failed?5:e.t0===Rt.Reconnecting?10:13;break;case 3:return t.transportState===Rt.Reconnecting&&(null==(s=t.listener)||s.onReconnected()),e.abrupt("break",13);case 5:return e.next=7,t.leave();case 7:return null==(i=t.errorListener)||null==i.onError||i.onError(r),t.sdkState.isReconnecting=!1,e.abrupt("break",13);case 10:return t.sdkState.isReconnecting=!0,null==(a=t.listener)||a.onReconnecting(r),e.abrupt("break",13);case 13:t.transportState=n;case 14:case"end":return e.stop()}}),e)}))),function(t,n){return e.apply(this,arguments)})},this.handlePeerLeaveRequest=function(e){var n,r=t.store.getPeerById(e.requested_by);null==(n=t.listener)||n.onRemovedFromRoom({roomEnded:e.room_end,reason:e.reason,requestedBy:r}),t.leave()},this.handleDeviceChangeError=function(e){var n;if(w.d(t.TAG,"Device Change event",e),null==(n=t.deviceChangeListener)||null==n.onDeviceChange||n.onDeviceChange(e),e.error&&e.type){var r,i,a,s,o=e.type.includes("audio")?null==(r=t.localPeer)?void 0:r.audioTrack:null==(i=t.localPeer)?void 0:i.videoTrack;null==(a=t.errorListener)||a.onError(e.error),[P.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,P.TracksErrors.DEVICE_IN_USE,P.TracksErrors.DEVICE_NOT_AVAILABLE].includes(e.error.code)&&o&&(o.setEnabled(!1),null==(s=t.listener)||s.onTrackUpdate(exports.HMSTrackUpdate.TRACK_MUTED,o,t.localPeer))}}}var t=e.prototype;return t.initStoreAndManagers=function(){if(this.sdkState.isInitialised)return this.notificationManager.setListener(this.listener),void this.audioSinkManager.setListener(this.listener);this.sdkState.isInitialised=!0,this.store=new ln,this.playlistManager=new Tn(this),this.notificationManager=new Ht(this.store,this.listener,this.audioListener),this.deviceManager=new cn(this.store),this.audioSinkManager=new on(this.store,this.notificationManager,this.deviceManager),this.audioOutput=new un(this.deviceManager,this.audioSinkManager),this.audioSinkManager.addEventListener("autoplay-error",this.handleAutoplayError),this.transport=new tn(this.observer,this.deviceManager,this.store),this.localTrackManager=new pn(this.store,this.observer,this.deviceManager)},t.getPlaylistManager=function(){return this.playlistManager},t.getRecordingState=function(){var e;return null==(e=this.store.getRoom())?void 0:e.recording},t.getRTMPState=function(){var e;return null==(e=this.store.getRoom())?void 0:e.rtmp},t.preview=function(){var e=c(S.mark((function e(t,n){var r,i,a,s,o,u,d,l,h=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.sdkState.isPreviewInProgress){e.next=2;break}return e.abrupt("return");case 2:return this.sdkState.isPreviewInProgress=!0,r=nn(t.authToken),i=r.roomId,a=r.userId,s=r.role,this.errorListener=n,this.deviceChangeListener=n,this.initStoreAndManagers(),this.store.setErrorListener(this.errorListener),this.store.setConfig(t),this.store.setRoom(new an(i,t.userName,this.store)),o=this.store.getPolicyForRole(s),u=new Ct({name:t.userName||"",customerUserId:a,customerDescription:t.metaData,role:o}),this.store.addPeer(u),w.d(this.TAG,"SDK Store",this.store),this.notificationManager.addEventListener("policy-change",d=function(){var e=c(S.mark((function e(){var r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h.notificationManager.removeEventListener("policy-change",d),e.next=3,h.localTrackManager.getTracksToPublish(t.settings||En);case 3:return(i=e.sent).forEach((function(e){return h.setLocalPeerTrack(e)})),(null==(r=h.localPeer)?void 0:r.audioTrack)&&h.initPreviewTrackAudioLevelMonitor(),e.next=8,h.initDeviceManagers();case 8:n.onPreview(h.store.getRoom(),i),h.sdkState.isPreviewInProgress=!1;case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()),e.prev=16,e.next=19,this.transport.connect(t.authToken,t.initEndpoint||"https://prod-init.100ms.live/init",this.localPeer.peerId);case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(16),null==(l=this.errorListener)||l.onError(e.t0),this.sdkState.isPreviewInProgress=!1;case 25:case"end":return e.stop()}}),e,this,[[16,21]])})));return function(t,n){return e.apply(this,arguments)}}(),t.join=function(e,t){var n,r,i,a=this;if(this.sdkState.isPreviewInProgress)throw void 0===(i="Preview is in progress, can't join")&&(i=""),new R(6003,"NotReady",A.JOIN,"WebRTC engine is not ready yet",i);null==(n=this.localPeer)||null==(r=n.audioTrack)||r.destroyAudioLevelMonitor(),this.listener=t,this.errorListener=t,this.deviceChangeListener=t,this.initStoreAndManagers(),this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId),this.store.setErrorListener(this.errorListener),this.store.setConfig(e);var s=nn(e.authToken),o=s.roomId,u=s.userId,d=s.role;if(this.localPeer)this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(d),this.localPeer.customerUserId=u,this.localPeer.customerDescription=e.metaData||"";else{this.notificationManager.addEventListener("role-change",(function(e){a.store.setPublishParams(e.detail.params.role.publishParams)}));var l=new Ct({name:e.userName,customerUserId:u,customerDescription:e.metaData||"",role:this.store.getPolicyForRole(d)});this.store.addPeer(l)}this.roleChangeManager=new hn(this.store,this.transport,this.publish.bind(this),this.removeTrack.bind(this),this.listener),this.notificationManager.addEventListener("local-peer-role-update",this.roleChangeManager.handleLocalPeerRoleUpdate),w.d(this.TAG,"SDK Store",this.store),w.d(this.TAG," Joining room "+o),this.store.getRoom()||this.store.setRoom(new an(o,e.userName,this.store)),w.time("join-room-"+o),this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.initEndpoint,e.autoVideoSubscribe).then(c(S.mark((function t(){var n,r;return S.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(w.d(a.TAG," Joined room "+o),null!=(n=window.HMS)&&n.JOIN_DELAY_FIX&&a.notifyJoin(),!a.publishParams||a.sdkState.published||me){t.next=5;break}return t.next=5,a.publish(e.settings||En);case 5:null!=(r=window.HMS)&&r.JOIN_DELAY_FIX||a.notifyJoin();case 6:case"end":return t.stop()}}),t)})))).catch((function(e){var t;null==(t=a.listener)||t.onError(e),w.e(a.TAG,"Unable to join room",e)})).then((function(){w.timeEnd("join-room-"+o)}))},t.cleanUp=function(){var e,t;this.store.cleanUp(),this.cleanDeviceManagers(),ut.cleanup(),this.playlistManager.cleanup(),w.cleanUp(),this.sdkState=l({},xn),this.localPeer&&(null==(e=this.localPeer.audioTrack)||e.cleanup(),this.localPeer.audioTrack=void 0,null==(t=this.localPeer.videoTrack)||t.cleanup(),this.localPeer.videoTrack=void 0),this.listener=void 0,this.roleChangeManager&&this.notificationManager.removeEventListener("local-peer-role-update",this.roleChangeManager.handleLocalPeerRoleUpdate)},t.leave=function(){var e=c(S.mark((function e(){var t,n,r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=this.store.getRoom())){e.next=8;break}return w.d(this.TAG," Leaving room "+(r=t.id)),e.next=6,null==(n=this.transport)?void 0:n.leave();case 6:this.cleanUp(),w.d(this.TAG," Left room "+r);case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getLocalPeer=function(){return this.store.getLocalPeer()},t.getPeers=function(){var e=this.store.getPeers();return w.d(this.TAG,"Got peers",e),e},t.getAudioOutput=function(){return this.audioOutput},t.sendMessage=function(e,t){this.sendMessageInternal({message:t,type:e})},t.sendBroadcastMessage=function(){var e=c(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sendMessageInternal({message:t,type:n});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.sendGroupMessage=function(){var e=c(S.mark((function e(t,n,r){var i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.store.getKnownRoles(),0!==(n.filter((function(e){return i[e.name]}))||[]).length){e.next=4;break}throw Q("No valid role is present",n);case 4:return e.next=6,this.sendMessageInternal({message:t,recipientRoles:n,type:r});case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}(),t.sendDirectMessage=function(){var e=c(S.mark((function e(t,n,r){var i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.store.getPeerById(n.peerId)){e.next=3;break}throw Q("Invalid peer - peer not present in the room",n);case 3:if((null==(i=this.localPeer)?void 0:i.peerId)!==n.peerId){e.next=5;break}throw Q("Cannot send message to self");case 5:return e.next=7,this.sendMessageInternal({message:t,recipientPeer:n,type:r});case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}(),t.sendMessageInternal=function(){var e=c(S.mark((function e(t){var n,r,i,a,s,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.recipientRoles,r=t.recipientPeer,a=void 0===(i=t.type)?"chat":i,""!==(s=t.message).replace(/\u200b/g," ").trim()){e.next=4;break}throw w.w(this.TAG,"sendMessage","Ignoring empty message send"),Q("Empty message not allowed");case 4:return o=new It({sender:this.localPeer,type:a,message:s,recipientPeer:r,recipientRoles:n,time:new Date}),w.d(this.TAG,"Sending Message:: ",o),e.next=8,this.transport.sendMessage(o);case 8:return e.abrupt("return",o);case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.startScreenShare=function(){var e=c(S.mark((function e(t,n){var r,i,a,s,o,c,u,d,l,h,p,f,v=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n=!1),a=this.publishParams){e.next=4;break}return e.abrupt("return");case 4:if(s=a.screen,(o=a.allowed)&&o.includes("screen")){e.next=9;break}return w.e(this.TAG,"Role "+(null==(c=this.localPeer)?void 0:c.role)+" cannot share screen"),e.abrupt("return");case 9:if(null==(r=this.localPeer)||null==(i=r.auxiliaryTracks)||!i.find((function(e){return"screen"===e.source}))){e.next=11;break}throw Error("Cannot share multiple screens");case 11:return u=this.store.getSimulcastDimensions("screen"),e.next=14,this.transport.getLocalScreen((new Le).maxBitrate(s.bitRate,!1).codec(s.codec).maxFramerate(s.frameRate).setWidth((null==u?void 0:u.width)||s.width).setHeight((null==u?void 0:u.height)||s.height).build(),(new De).build());case 14:if(l=(d=e.sent)[0],h=d[1],p=function(){v.stopEndedScreenshare(t)},f=[],!n){e.next=27;break}if(l.nativeTrack.stop(),h){e.next=23;break}throw Error("Select share audio when sharing screen");case 23:f.push(h),h.nativeTrack.onended=p,e.next=30;break;case 27:f.push(l),l.nativeTrack.onended=p,h&&f.push(h);case 30:return e.next=32,this.transport.publish(f);case 32:f.forEach((function(e){var t,n,r;e.peerId=null==(t=v.localPeer)?void 0:t.peerId,null==(n=v.localPeer)||n.auxiliaryTracks.push(e),null==(r=v.listener)||r.onTrackUpdate(exports.HMSTrackUpdate.TRACK_ADDED,e,v.localPeer)}));case 33:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.stopEndedScreenshare=function(){var e=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w.d(this.TAG," Screenshare ended natively"),e.next=3,this.stopScreenShare();case 3:t();case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.stopScreenShare=function(){var e=c(S.mark((function e(){var t,n,r,i,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(w.d(this.TAG," Screenshare ended from app"),!(n=null==(t=this.localPeer)?void 0:t.auxiliaryTracks.filter((function(e){return"screen"===e.source})))){e.next=10;break}r=E(n);case 4:if((i=r()).done){e.next=10;break}return a=i.value,e.next=8,this.removeTrack(a.trackId);case 8:e.next=4;break;case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.addTrack=function(){var e=c(S.mark((function e(t,n){var r,i,a,s,o,c,u,d,l,h,p;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n="regular"),t){e.next=4;break}return w.w(this.TAG,"Please pass a valid MediaStreamTrack"),e.abrupt("return");case 4:if(this.localPeer){e.next=6;break}throw J(A.VALIDATION,"No local peer present, cannot addTrack");case 6:if(!this.localPeer.auxiliaryTracks.find((function(e){return e.trackId===t.id}))){e.next=9;break}return e.abrupt("return");case 9:if(o=t.kind,c=new MediaStream([t]),u=new St(c),d=new("audio"===o?pt:yt)(u,t,n),"videoplaylist"!==n){e.next=21;break}return l={},"audio"===o?l.maxBitrate=64:(l.maxBitrate=1e3,h=t.getSettings(),p=h.height,l.width=h.width,l.height=p),e.next=19,d.setSettings(l);case 19:e.next=24;break;case 21:if("audioplaylist"!==n){e.next=24;break}return e.next=24,d.setSettings({maxBitrate:64});case 24:return e.next=26,null==(r=this.transport)?void 0:r.publish([d]);case 26:d.peerId=null==(i=this.localPeer)?void 0:i.peerId,null==(a=this.localPeer)||a.auxiliaryTracks.push(d),null==(s=this.listener)||s.onTrackUpdate(exports.HMSTrackUpdate.TRACK_ADDED,d,this.localPeer);case 29:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.removeTrack=function(){var e=c(S.mark((function e(t){var n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.localPeer){e.next=2;break}throw J(A.VALIDATION,"No local peer present, cannot removeTrack");case 2:if(!((n=this.localPeer.auxiliaryTracks.findIndex((function(e){return e.trackId===t})))>-1)){e.next=11;break}return i=this.localPeer.auxiliaryTracks[n],e.next=7,this.transport.unpublish([i]);case 7:this.localPeer.auxiliaryTracks.splice(n,1),null==(r=this.listener)||r.onTrackUpdate(exports.HMSTrackUpdate.TRACK_REMOVED,i,this.localPeer),e.next=12;break;case 11:w.w(this.TAG,"No track found for "+t);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.setAnalyticsLevel=function(e){rt.level=e},t.setLogLevel=function(e){w.level=e},t.addAudioListener=function(e){this.audioListener=e,this.notificationManager.setAudioListener(e)},t.changeRole=function(){var e=c(S.mark((function e(t,n,r){var i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===r&&(r=!1),t.role&&t.role.name!==n){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,null==(i=this.transport)?void 0:i.changeRole(t,n,r);case 5:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}(),t.acceptChangeRole=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null==(n=this.transport)?void 0:n.acceptRoleChange(t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.endRoom=function(){var e=c(S.mark((function e(t,n){var r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.localPeer){e.next=2;break}throw J(A.VALIDATION,"No local peer present, cannot end room");case 2:return e.next=4,null==(r=this.transport)?void 0:r.endRoom(t,n);case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.removePeer=function(){var e=c(S.mark((function e(t,n){var r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.localPeer){e.next=2;break}throw J(A.VALIDATION,"No local peer present, cannot remove peer");case 2:if(this.store.getPeerById(t.peerId)){e.next=4;break}throw Q("Invalid peer, given peer not present in room",t);case 4:return e.next=6,null==(r=this.transport)?void 0:r.removePeer(t.peerId,n);case 6:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.startRTMPOrRecording=function(){var e=c(S.mark((function e(t){var n,r,i,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.localPeer){e.next=2;break}throw J(A.VALIDATION,"No local peer present, cannot start streaming or recording");case 2:return e.next=4,null==(n=this.transport)?void 0:n.startRTMPOrRecording(t);case 4:i={method:xt.RTMP_START,params:{}},a={method:xt.RECORDING_START,params:{type:"Browser"}},null!=(r=t.rtmpURLs)&&r.length&&this.notificationManager.handleNotification(i),t.record&&this.notificationManager.handleNotification(a);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.stopRTMPAndRecording=function(){var e=c(S.mark((function e(){var t,n,r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.localPeer){e.next=2;break}throw J(A.VALIDATION,"No local peer present, cannot stop streaming or recording");case 2:return e.next=4,null==(t=this.transport)?void 0:t.stopRTMPOrRecording();case 4:n=this.store.getRoom(),i=n.rtmp,null!=(r=n.recording)&&r.browser.running&&this.notificationManager.handleNotification({method:xt.RECORDING_STOP,params:{type:"Browser"}}),null!=i&&i.running&&this.notificationManager.handleNotification({method:xt.RTMP_STOP,params:{}});case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.getRoles=function(){return Object.values(this.store.getKnownRoles())},t.changeTrackState=function(){var e=c(S.mark((function e(t,n){var r,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.type!==exports.HMSTrackType.VIDEO||"regular"===t.source){e.next=3;break}return w.w(this.TAG,"Muting non-regular video tracks is currently not supported"),e.abrupt("return");case 3:if(t.enabled!==n){e.next=6;break}return w.w(this.TAG,"Aborting change track state, track already has enabled - "+n,t),e.abrupt("return");case 6:if(this.store.getTrackById(t.trackId)){e.next=8;break}throw Q("No track found for change track state",t);case 8:if(i=this.store.getPeerByTrackId(t.trackId)){e.next=11;break}throw Q("No peer found for change track state",t);case 11:return e.next=13,null==(r=this.transport)?void 0:r.changeTrackState({requested_for:i.peerId,track_id:t.trackId,stream_id:t.stream.id,mute:!n});case 13:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.changeMultiTrackState=function(){var e=c(S.mark((function e(t){var n,r,i,a,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("boolean"==typeof t.enabled){e.next=2;break}throw Q("Pass a boolean for enabled");case 2:return r=t.enabled,i=t.roles,a=t.type,s=t.source,e.next=5,null==(n=this.transport)?void 0:n.changeMultiTrackState({value:!r,type:a,source:s,roles:null==i?void 0:i.map((function(e){return null==e?void 0:e.name}))});case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.publish=function(){var e=c(S.mark((function e(t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.localTrackManager.getTracksToPublish(t);case 2:return n=e.sent,e.next=5,this.setAndPublishTracks(n);case 5:this.sdkState.published=!0;case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.setAndPublishTracks=function(){var e=c(S.mark((function e(t){var n,r,i,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=E(t);case 1:if((r=n()).done){e.next=9;break}return a=r.value,e.next=5,this.transport.publish([a]);case 5:this.setLocalPeerTrack(a),null==(i=this.listener)||i.onTrackUpdate(exports.HMSTrackUpdate.TRACK_ADDED,a,this.localPeer);case 7:e.next=1;break;case 9:return e.next=11,this.initDeviceManagers();case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.setLocalPeerTrack=function(e){var t;switch(e.peerId=null==(t=this.localPeer)?void 0:t.peerId,e.type){case exports.HMSTrackType.AUDIO:this.localPeer.audioTrack=e;break;case exports.HMSTrackType.VIDEO:this.localPeer.videoTrack=e}},t.initDeviceManagers=function(){var e=c(S.mark((function e(){var t,n,r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.sdkState.deviceManagersInitialised){e.next=2;break}return e.abrupt("return");case 2:return this.sdkState.deviceManagersInitialised=!0,this.deviceManager.addEventListener("audio-device-change",this.handleDeviceChangeError),this.deviceManager.addEventListener("video-device-change",this.handleDeviceChangeError),e.next=7,this.deviceManager.init();case 7:this.deviceManager.updateOutputDevice(null==(t=ut.getSelection())||null==(n=t.audioOutput)?void 0:n.deviceId),this.audioSinkManager.init(null==(r=this.store.getConfig())?void 0:r.audioSinkElementId);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.cleanDeviceManagers=function(){this.deviceManager.removeEventListener("audio-device-change",this.handleDeviceChangeError),this.deviceManager.removeEventListener("video-device-change",this.handleDeviceChangeError),this.deviceManager.cleanUp(),this.audioSinkManager.removeEventListener("autoplay-error",this.handleAutoplayError),this.audioSinkManager.cleanUp()},t.initPreviewTrackAudioLevelMonitor=function(){var e,t,n,r,i,a=this;null==(e=this.localPeer)||null==(t=e.audioTrack)||t.initAudioLevelMonitor(),null==(n=this.localPeer)||null==(r=n.audioTrack)||null==(i=r.audioLevelMonitor)||i.on("AUDIO_LEVEL_UPDATE",(function(e){var t,n,r=e?[{audioLevel:e.audioLevel,peer:a.localPeer,track:null==(t=a.localPeer)?void 0:t.audioTrack}]:[];a.store.updateSpeakers(r),null==(n=a.audioListener)||n.onAudioLevelUpdate(r)}))},t.notifyJoin=function(){var e,t=this,n=this.store.getLocalPeer();null!=n&&n.role?null==(e=this.listener)||e.onJoin(this.store.getRoom()):this.notificationManager.once("policy-change",(function(){var e;null==(e=t.listener)||e.onJoin(t.store.getRoom())}))},d(e,[{key:"localPeer",get:function(){var e;return null==(e=this.store)?void 0:e.getLocalPeer()}},{key:"publishParams",get:function(){var e;return null==(e=this.store)?void 0:e.getPublishParams()}}]),e}();function bn(e){return Sn.apply(this,arguments)}function Sn(){return(Sn=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getUserMedia(t);case 3:return e.abrupt("return",e.sent);case 7:throw e.prev=7,e.t0=e.catch(0),Ge(e.t0,Re.AV);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}function wn(){return(wn=c(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getDisplayMedia({video:t,audio:!1});case 3:return e.abrupt("return",e.sent);case 7:throw e.prev=7,e.t0=e.catch(0),Ge(e.t0,Re.SCREEN);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}function In(){return(In=c(S.mark((function e(){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.enumerateDevices();case 3:return t={audioinput:[],audiooutput:[],videoinput:[]},e.sent.forEach((function(e){return t[e.kind].push(e)})),e.abrupt("return",t);case 9:throw e.prev=9,e.t0=e.catch(0),Ge(e.t0,Re.AV);case 12:case"end":return e.stop()}}),e,null,[[0,9]])})))).apply(this,arguments)}function An(){return(An=c(S.mark((function e(){var t,n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(new Le).build(),n=(new De).build(),e.prev=2,e.next=5,He(n);case 5:e.sent.stop(),e.next=17;break;case 9:if(e.prev=9,e.t0=e.catch(2),!Pn(e.t0)){e.next=17;break}return e.next=14,bn({audio:!1,video:!0});case 14:throw e.sent.getTracks().forEach((function(e){return e.stop()})),e.t0;case 17:return e.next=19,Be(t);case 19:return e.sent.stop(),e.abrupt("return",!1);case 22:case"end":return e.stop()}}),e,null,[[2,9]])})))).apply(this,arguments)}function Pn(e){return e instanceof R&&e.action===A.TRACK}console.log("%c "+t.browserDetails.browser+" v"+t.browserDetails.version,"color: #2F80FF"),exports.HMSAudioTrack=le,exports.HMSException=R,exports.HMSLocalAudioTrack=pt,exports.HMSLocalVideoTrack=yt,exports.HMSRemoteAudioTrack=he,exports.HMSRemoteVideoTrack=fe,exports.HMSSdk=yn,exports.HMSTrack=de,exports.HMSVideoTrack=pe,exports.getLocalDevices=function(){return In.apply(this,arguments)},exports.getLocalScreen=function(e){return wn.apply(this,arguments)},exports.getLocalStream=bn,exports.isBrowser=ke,exports.isMobile=ye,exports.isNode=me,exports.isSupported=Te,exports.parsedUserAgent=ge,exports.userAgent=be,exports.validateDeviceAV=function(){return An.apply(this,arguments)};
//# sourceMappingURL=hms-video.cjs.production.min.js.map
